{% extends "base.html" %}

{% block title %}Edit Encounter - {{ encounter.name }}{% endblock %}
{% block header %}Edit Encounter{% endblock %}

{% block content %}
<!-- Campaign Context Banner -->
<div class="panel" style="border-color: var(--lcars-purple); margin-bottom: 15px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <span style="color: var(--lcars-tan);">Campaign:</span>
            <strong style="color: var(--lcars-purple);">{{ campaign.name }}</strong>
            <span style="margin-left: 15px; color: var(--lcars-tan);">Encounter:</span>
            <strong style="color: var(--lcars-orange);">{{ encounter.name }}</strong>
            <span class="action-type" style="margin-left: 10px;">{{ encounter.status.title() }}</span>
        </div>
        <a href="{{ url_for('campaigns.campaign_dashboard', campaign_id=campaign.campaign_id) }}"
           class="btn btn-small" style="background: #666;">
            Back to Campaign
        </a>
    </div>
</div>

<form method="POST" id="encounter-form">
    <input type="hidden" name="tactical_map_json" id="tactical_map_json" value="{{ tactical_map_json }}">
    <input type="hidden" name="ship_positions_json" id="ship_positions_json" value="{{ ship_positions_json }}">

    <div class="grid">
        <div class="panel">
            <h2>Encounter Details</h2>
            <label for="name">Encounter Name</label>
            <input type="text" name="name" id="name" value="{{ encounter.name }}" style="width: 100%;">
            <label for="description" style="margin-top: 10px;">Description (optional)</label>
            <textarea name="description" id="description" rows="3" style="width: 100%;" placeholder="Brief description of this encounter...">{{ encounter.description or '' }}</textarea>
            <label for="threat" style="margin-top: 10px;">Threat Pool</label>
            <input type="number" name="threat" id="threat" min="0" max="20" value="{{ encounter.threat }}" style="width: 100%;">
        </div>

        <div class="panel" style="border-color: var(--lcars-red);">
            <h2 style="color: var(--lcars-red);">Enemy Ships ({{ enemy_ships | length }})</h2>
            <div id="enemy-ships-list">
                {% for enemy in enemy_ships %}
                <div style="background: #222; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    <strong style="color: var(--lcars-red);">{{ enemy.name }}</strong>
                    <div style="font-size: 0.85em; color: var(--lcars-tan);">
                        Scale {{ enemy.scale }} | {{ enemy.crew_quality or 'Standard' }} Crew
                    </div>
                </div>
                {% endfor %}
            </div>
            <p style="font-size: 0.8em; color: var(--lcars-tan); margin-top: 10px;">
                Enemy ships can be managed from the GM combat view.
            </p>
        </div>
    </div>

    <!-- Tactical Map Setup -->
    <div class="panel" style="border-color: var(--lcars-orange);">
        <h2 style="color: var(--lcars-orange);">Tactical Map</h2>
        <p style="color: var(--lcars-tan); margin-bottom: 15px;">
            Configure the battlefield terrain and ship positions. Click hexes to paint terrain, then place ships.
        </p>

        <div class="grid" style="gap: 15px;">
            <!-- Map Display -->
            <div>
                <div id="tactical-map-container" style="min-height: 350px; background: #0a0a0a; border-radius: 5px;">
                    <p style="color: #666; text-align: center; padding-top: 150px;">Loading map...</p>
                </div>
            </div>

            <!-- Map Controls -->
            <div>
                <div style="margin-bottom: 15px;">
                    <label style="color: var(--lcars-orange);">Edit Mode</label>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                        <button type="button" class="btn btn-small mode-btn active" id="mode-terrain" onclick="setEditMode('terrain')">
                            Paint Terrain
                        </button>
                        <button type="button" class="btn btn-small mode-btn" id="mode-ships" onclick="setEditMode('ships')">
                            Place Ships
                        </button>
                    </div>
                </div>

                <!-- Terrain Palette -->
                <div id="terrain-controls">
                    <label for="terrain-palette">Select Terrain</label>
                    <select id="terrain-palette" style="width: 100%;" onchange="selectedTerrain = this.value">
                        <option value="open">Open Space</option>
                        <option value="dust_cloud">Dust Cloud (hides ships)</option>
                        <option value="debris_field">Debris Field (hazardous)</option>
                        <option value="asteroid_field">Asteroid Field (hazardous)</option>
                        <option value="dense_nebula">Dense Nebula (hides ships, 2M cost)</option>
                    </select>
                    <p style="font-size: 0.8em; color: var(--lcars-tan); margin-top: 5px;">
                        Click hexes on the map to paint terrain.
                    </p>
                </div>

                <!-- Ship Placement -->
                <div id="ship-controls" style="display: none;">
                    <label for="ship-to-place">Select Ship to Place</label>
                    <select id="ship-to-place" style="width: 100%;">
                        <option value="player">{{ player_ship.name if player_ship else 'Player Ship' }}</option>
                        {% for enemy in enemy_ships %}
                        <option value="enemy_{{ loop.index0 }}">{{ enemy.name }}</option>
                        {% endfor %}
                    </select>
                    <p style="font-size: 0.8em; color: var(--lcars-tan); margin-top: 5px;">
                        Click a hex on the map to place the selected ship.
                    </p>
                    <div id="ship-positions-list" style="margin-top: 10px; font-size: 0.85em;">
                        <!-- Ship positions will be shown here -->
                    </div>
                </div>

                <!-- Quick Actions -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #333;">
                    <label style="color: var(--lcars-tan);">Quick Setup</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 5px;">
                        <button type="button" class="btn btn-small" onclick="clearMap()">Clear Map</button>
                        <button type="button" class="btn btn-small" style="background: var(--lcars-blue);" onclick="randomizeMap()">Random Terrain</button>
                        <button type="button" class="btn btn-small" style="background: var(--lcars-green);" onclick="resetPositions()">Reset Positions</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button type="submit" class="btn">Save Changes</button>
        <a href="{{ url_for('campaigns.campaign_dashboard', campaign_id=campaign.campaign_id) }}" class="btn" style="background: #666;">
            Cancel
        </a>
    </div>
</form>

<style>
.mode-btn {
    background: #333;
}
.mode-btn.active {
    background: var(--lcars-orange);
}
</style>

<script src="{{ url_for('static', filename='js/hex-map.js') }}"></script>
<script>
// Initialize from server data
let tacticalMapData = {{ tactical_map | tojson | safe }};
let shipPositions = {{ ship_positions | tojson | safe }};
let editMode = 'terrain';
let selectedTerrain = 'open';
let selectedShip = 'player';

// Ship data for rendering
const playerShipName = "{{ player_ship.name if player_ship else 'Player Ship' }}";
const enemyShips = [
    {% for enemy in enemy_ships %}
    { id: "enemy_{{ loop.index0 }}", name: "{{ enemy.name }}" }{{ "," if not loop.last else "" }}
    {% endfor %}
];

// Default positions
const defaultEnemyPositions = [
    { q: 2, r: -1 },
    { q: 2, r: 0 },
    { q: 2, r: 1 },
    { q: 3, r: -1 }
];

function initMap() {
    // Ensure we have valid data structures
    if (!tacticalMapData || !tacticalMapData.radius) {
        tacticalMapData = { radius: 3, tiles: [] };
    }
    if (!shipPositions || typeof shipPositions !== 'object') {
        shipPositions = {};
    }
    if (!shipPositions.player) {
        shipPositions.player = { q: -2, r: 1 };
    }

    // Initialize enemy positions if missing
    enemyShips.forEach((enemy, i) => {
        const key = `enemy_${i}`;
        if (!shipPositions[key]) {
            shipPositions[key] = { ...defaultEnemyPositions[i] };
        }
    });

    renderMap();
}

function renderMap() {
    const ships = [];

    // Player ship
    ships.push({
        id: 'player',
        name: playerShipName,
        faction: 'player',
        position: shipPositions.player || { q: -2, r: 1 }
    });

    // Enemy ships
    enemyShips.forEach((enemy, i) => {
        const key = `enemy_${i}`;
        ships.push({
            id: key,
            name: enemy.name,
            faction: 'enemy',
            position: shipPositions[key] || defaultEnemyPositions[i]
        });
    });

    HexMap.render('tactical-map-container', tacticalMapData, ships, {
        onHexClick: handleHexClick
    });

    updateHiddenFields();
    updateShipPositionsList();
}

function handleHexClick(q, r, terrain) {
    if (editMode === 'terrain') {
        let tile = tacticalMapData.tiles.find(t => t.coord.q === q && t.coord.r === r);

        if (tile) {
            tile.terrain = selectedTerrain;
        } else {
            tacticalMapData.tiles.push({
                coord: { q, r },
                terrain: selectedTerrain
            });
        }
        renderMap();
    } else if (editMode === 'ships') {
        shipPositions[selectedShip] = { q, r };
        renderMap();
    }
}

function setEditMode(mode) {
    editMode = mode;

    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`mode-${mode}`).classList.add('active');

    document.getElementById('terrain-controls').style.display = mode === 'terrain' ? 'block' : 'none';
    document.getElementById('ship-controls').style.display = mode === 'ships' ? 'block' : 'none';
}

function updateShipPositionsList() {
    const container = document.getElementById('ship-positions-list');
    let html = '<div style="color: var(--lcars-tan);">Current positions:</div>';

    const playerPos = shipPositions.player || { q: 0, r: 0 };
    html += `<div style="color: var(--lcars-green);">${playerShipName}: (${playerPos.q}, ${playerPos.r})</div>`;

    enemyShips.forEach((enemy, i) => {
        const pos = shipPositions[`enemy_${i}`] || { q: 0, r: 0 };
        html += `<div style="color: var(--lcars-red);">${enemy.name}: (${pos.q}, ${pos.r})</div>`;
    });

    container.innerHTML = html;
}

function updateHiddenFields() {
    document.getElementById('tactical_map_json').value = JSON.stringify(tacticalMapData);
    document.getElementById('ship_positions_json').value = JSON.stringify(shipPositions);
}

function clearMap() {
    tacticalMapData.tiles = [];
    renderMap();
}

function randomizeMap() {
    tacticalMapData.tiles = [];
    const terrains = ['open', 'dust_cloud', 'debris_field', 'asteroid_field', 'dense_nebula'];
    const radius = tacticalMapData.radius || 3;

    for (let q = -radius; q <= radius; q++) {
        const r1 = Math.max(-radius, -q - radius);
        const r2 = Math.min(radius, -q + radius);
        for (let r = r1; r <= r2; r++) {
            if (Math.random() < 0.3 && !(q === 0 && r === 0)) {
                tacticalMapData.tiles.push({
                    coord: { q, r },
                    terrain: terrains[Math.floor(Math.random() * terrains.length)]
                });
            }
        }
    }

    renderMap();
}

function resetPositions() {
    shipPositions = {
        player: { q: -2, r: 1 }
    };
    enemyShips.forEach((enemy, i) => {
        shipPositions[`enemy_${i}`] = { ...defaultEnemyPositions[i] };
    });
    renderMap();
}

// Ship selector change handler
document.getElementById('ship-to-place').addEventListener('change', function() {
    selectedShip = this.value;
});

// Initialize on load
document.addEventListener('DOMContentLoaded', initMap);
</script>
{% endblock %}
