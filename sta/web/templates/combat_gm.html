{% extends "base.html" %}

{% block title %}{{ encounter.name }} - Game Master View{% endblock %}
{% block header %}{{ encounter.name }} - Round {{ encounter.round }} [GM]{% endblock %}

{% block content %}
<!-- Turn Indicator Banner -->
<div id="turn-banner" class="turn-banner {% if encounter.current_turn == 'enemy' %}your-turn{% else %}player-turn{% endif %}">
    <div class="turn-text">
        {% if encounter.current_turn == 'enemy' %}
        YOUR TURN (GM) - Control enemy vessels
        {% else %}
        PLAYER'S TURN - Waiting for player actions...
        {% endif %}
    </div>
    <div style="margin-top: 10px;">
        <button class="btn" onclick="nextTurn()" id="end-turn-btn">
            {% if encounter.current_turn == 'enemy' %}End Enemy Turn{% else %}End Player Turn{% endif %}
        </button>
    </div>
</div>

<div class="grid">
    <!-- Resource Pools (GM can modify both) -->
    <div class="panel">
        <h2>Resources</h2>
        <div class="resource-pool momentum">
            <span>Momentum</span>
            <button class="btn btn-small" onclick="updateMomentum(-1)">-</button>
            <span class="value" id="momentum">{{ encounter.momentum }}</span>
            <button class="btn btn-small" onclick="updateMomentum(1)">+</button>
            <span style="color: #666;">/ 6</span>
        </div>
        <div class="resource-pool threat">
            <span>Threat</span>
            <button class="btn btn-small" onclick="updateThreat(-1)">-</button>
            <span class="value" id="threat">{{ encounter.threat }}</span>
            <button class="btn btn-small" onclick="updateThreat(1)">+</button>
        </div>
    </div>

    <!-- Player Character (visible to GM) -->
    {% if player_char %}
    <div class="panel" style="border-color: var(--lcars-green);">
        <h2 style="color: var(--lcars-green);">PLAYER: {{ player_char.name }}</h2>
        <div class="stat-row">
            <span>Rank / Position</span>
            <span class="stat-value">{{ player_char.rank }} - {{ position.value.title() }}</span>
        </div>
        <div class="stat-row">
            <span>Stress</span>
            <span class="stat-value">{{ player_char.stress }} / {{ player_char.stress_max }}</span>
        </div>

        <h3 style="margin-top: 15px; color: var(--lcars-tan); font-size: 0.9em;">ATTRIBUTES</h3>
        <div class="stats-grid">
            <div class="stat-row">
                <span>Control</span>
                <span class="stat-value">{{ player_char.attributes.control }}</span>
            </div>
            <div class="stat-row">
                <span>Daring</span>
                <span class="stat-value">{{ player_char.attributes.daring }}</span>
            </div>
            <div class="stat-row">
                <span>Fitness</span>
                <span class="stat-value">{{ player_char.attributes.fitness }}</span>
            </div>
            <div class="stat-row">
                <span>Insight</span>
                <span class="stat-value">{{ player_char.attributes.insight }}</span>
            </div>
            <div class="stat-row">
                <span>Presence</span>
                <span class="stat-value">{{ player_char.attributes.presence }}</span>
            </div>
            <div class="stat-row">
                <span>Reason</span>
                <span class="stat-value">{{ player_char.attributes.reason }}</span>
            </div>
        </div>

        <h3 style="margin-top: 15px; color: var(--lcars-tan); font-size: 0.9em;">DISCIPLINES</h3>
        <div class="stats-grid">
            <div class="stat-row">
                <span>Command</span>
                <span class="stat-value">{{ player_char.disciplines.command }}</span>
            </div>
            <div class="stat-row">
                <span>Conn</span>
                <span class="stat-value">{{ player_char.disciplines.conn }}</span>
            </div>
            <div class="stat-row">
                <span>Engineering</span>
                <span class="stat-value">{{ player_char.disciplines.engineering }}</span>
            </div>
            <div class="stat-row">
                <span>Medicine</span>
                <span class="stat-value">{{ player_char.disciplines.medicine }}</span>
            </div>
            <div class="stat-row">
                <span>Science</span>
                <span class="stat-value">{{ player_char.disciplines.science }}</span>
            </div>
            <div class="stat-row">
                <span>Security</span>
                <span class="stat-value">{{ player_char.disciplines.security }}</span>
            </div>
        </div>

        <div style="margin-top: 10px; font-size: 0.9em; color: var(--lcars-tan);">
            <strong>Focuses:</strong> {{ player_char.focuses | join(', ') }}
        </div>
    </div>
    {% endif %}
</div>

<div class="grid">
    <!-- Player Ship (visible to GM with full details) -->
    {% if player_ship %}
    <div class="panel" style="border-color: var(--lcars-green);">
        <h2 style="color: var(--lcars-green);">PLAYER SHIP: {{ player_ship.name }}</h2>
        <div class="stat-row">
            <span>Class</span>
            <span class="stat-value">{{ player_ship.ship_class }}-class (Scale {{ player_ship.scale }})</span>
        </div>
        <div class="stat-row">
            <span>Shields</span>
            <span class="stat-value" id="player-shields">
                {{ player_ship.shields }} / {{ player_ship.shields_max }}
                <span id="shields-status" style="margin-left: 8px; font-size: 0.8em; {% if player_ship.shields_raised %}color: var(--lcars-green);{% else %}color: var(--lcars-red);{% endif %}">
                    [{{ 'ONLINE' if player_ship.shields_raised else 'OFFLINE' }}]
                </span>
            </span>
        </div>
        <div class="shields-bar">
            <div class="fill" id="player-shields-bar" style="width: {{ (player_ship.shields / player_ship.shields_max * 100) | int }}%; background: var(--lcars-green);{% if not player_ship.shields_raised %} background: var(--lcars-red);{% endif %}"></div>
        </div>
        <div class="stat-row">
            <span>Resistance</span>
            <span class="stat-value" id="player-resistance">
                {{ player_ship.resistance }}{% if resistance_bonus > 0 %} <span style="color: var(--lcars-green);">(+{{ resistance_bonus }})</span>{% endif %}
            </span>
        </div>

        <h3 style="margin-top: 15px; color: var(--lcars-tan); font-size: 0.9em;">SYSTEMS</h3>
        <div class="stats-grid">
            {% set systems = [('Comms', player_ship.systems.comms, 'comms'), ('Computers', player_ship.systems.computers, 'computers'), ('Engines', player_ship.systems.engines, 'engines'), ('Sensors', player_ship.systems.sensors, 'sensors'), ('Structure', player_ship.systems.structure, 'structure'), ('Weapons', player_ship.systems.weapons, 'weapons')] %}
            {% for name, value, key in systems %}
            {% set breach_potency = player_ship.breaches | selectattr('system_name', 'equalto', key) | map(attribute='potency') | sum %}
            <div class="stat-row {% if breach_potency > 0 %}breached{% endif %}" data-system="{{ key }}">
                <span>{{ name }}</span>
                <span class="stat-value">
                    {{ value }}
                    <span class="breach-indicator" style="{% if breach_potency == 0 %}display:none{% endif %}">[Breach <span class="breach-count">{{ breach_potency }}</span>]</span>
                </span>
            </div>
            {% endfor %}
        </div>

        <h3 style="margin-top: 15px; color: var(--lcars-tan); font-size: 0.9em;">DEPARTMENTS</h3>
        <div class="stats-grid">
            <div class="stat-row"><span>Command</span><span class="stat-value">{{ player_ship.departments.command }}</span></div>
            <div class="stat-row"><span>Conn</span><span class="stat-value">{{ player_ship.departments.conn }}</span></div>
            <div class="stat-row"><span>Engineering</span><span class="stat-value">{{ player_ship.departments.engineering }}</span></div>
            <div class="stat-row"><span>Medicine</span><span class="stat-value">{{ player_ship.departments.medicine }}</span></div>
            <div class="stat-row"><span>Science</span><span class="stat-value">{{ player_ship.departments.science }}</span></div>
            <div class="stat-row"><span>Security</span><span class="stat-value">{{ player_ship.departments.security }}</span></div>
        </div>

        <h3 style="margin-top: 15px; color: var(--lcars-tan); font-size: 0.9em;">
            WEAPONS
            <span id="weapons-status" style="margin-left: 10px; {% if player_ship.weapons_armed %}color: var(--lcars-orange);{% else %}color: var(--lcars-red);{% endif %}">
                [{{ 'ARMED' if player_ship.weapons_armed else 'STANDBY' }}]
            </span>
        </h3>
        {% for weapon in player_ship.weapons %}
        <div class="stat-row">
            <span>{{ weapon.name }}</span>
            <span class="stat-value">Dmg {{ weapon.damage }}+{{ player_ship.weapons_damage_bonus() }} | {{ weapon.range.value.title() }}</span>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Enemy Ships (full details for GM) -->
    {% for enemy in enemy_ships %}
    <div class="panel enemy-ship" style="border-color: var(--lcars-red);" data-ship-id="{{ loop.index0 }}">
        <h2 style="color: var(--lcars-red);">ENEMY: {{ enemy.name }}</h2>
        <div class="stat-row">
            <span>Class</span>
            <span class="stat-value">{{ enemy.ship_class }}-class (Scale {{ enemy.scale }})</span>
        </div>
        {% if enemy.crew_quality %}
        <div class="stat-row" style="background: rgba(255,100,100,0.1);">
            <span>Crew Quality</span>
            <span class="stat-value" style="color: var(--lcars-orange);">
                {{ enemy.crew_quality.value.title() }}
                (Target {{ enemy.crew_quality.target_number }})
            </span>
        </div>
        {% endif %}
        <div class="stat-row">
            <span>Shields</span>
            <span class="stat-value enemy-shields">{{ enemy.shields }} / {{ enemy.shields_max }}</span>
        </div>
        <div class="shields-bar">
            <div class="fill enemy-shields-bar" style="width: {{ (enemy.shields / enemy.shields_max * 100) | int }}%; background: var(--lcars-red);"></div>
        </div>
        <div class="stat-row">
            <span>Resistance</span>
            <span class="stat-value">{{ enemy.resistance }}</span>
        </div>

        <h3 style="margin-top: 15px; color: var(--lcars-tan); font-size: 0.9em;">SYSTEMS</h3>
        <div class="stats-grid">
            {% set systems = [('Comms', enemy.systems.comms, 'comms'), ('Computers', enemy.systems.computers, 'computers'), ('Engines', enemy.systems.engines, 'engines'), ('Sensors', enemy.systems.sensors, 'sensors'), ('Structure', enemy.systems.structure, 'structure'), ('Weapons', enemy.systems.weapons, 'weapons')] %}
            {% for name, value, key in systems %}
            {% set breach_potency = enemy.breaches | selectattr('system_name', 'equalto', key) | map(attribute='potency') | sum %}
            <div class="stat-row {% if breach_potency > 0 %}breached{% endif %}" data-system="{{ key }}">
                <span>{{ name }}</span>
                <span class="stat-value">
                    {{ value }}
                    <span class="breach-indicator" style="{% if breach_potency == 0 %}display:none{% endif %}">[Breach <span class="breach-count">{{ breach_potency }}</span>]</span>
                </span>
            </div>
            {% endfor %}
        </div>

        <h3 style="margin-top: 15px; color: var(--lcars-tan); font-size: 0.9em;">DEPARTMENTS</h3>
        <div class="stats-grid">
            <div class="stat-row"><span>Command</span><span class="stat-value">{{ enemy.departments.command }}</span></div>
            <div class="stat-row"><span>Conn</span><span class="stat-value">{{ enemy.departments.conn }}</span></div>
            <div class="stat-row"><span>Engineering</span><span class="stat-value">{{ enemy.departments.engineering }}</span></div>
            <div class="stat-row"><span>Medicine</span><span class="stat-value">{{ enemy.departments.medicine }}</span></div>
            <div class="stat-row"><span>Science</span><span class="stat-value">{{ enemy.departments.science }}</span></div>
            <div class="stat-row"><span>Security</span><span class="stat-value">{{ enemy.departments.security }}</span></div>
        </div>

        <h3 style="margin-top: 15px; color: var(--lcars-tan); font-size: 0.9em;">WEAPONS</h3>
        {% for weapon in enemy.weapons %}
        <div class="stat-row">
            <span>{{ weapon.name }}</span>
            <span class="stat-value">Dmg {{ weapon.damage }}+{{ enemy.weapons_damage_bonus() }} | {{ weapon.range.value.title() }}</span>
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</div>

<!-- GM Controls Panel (only visible on enemy turn) -->
<div id="gm-controls" class="panel" style="border-color: var(--lcars-purple); {% if encounter.current_turn != 'enemy' %}opacity: 0.5;{% endif %}">
    <h2 style="color: var(--lcars-purple);">GM CONTROLS</h2>

    <div id="gm-turn-message" style="padding: 10px; background: #222; border-radius: 5px; margin-bottom: 15px;">
        {% if encounter.current_turn == 'enemy' %}
        <span style="color: var(--lcars-green);">It's the enemy's turn. You can control enemy actions.</span>
        {% else %}
        <span style="color: var(--lcars-tan);">Waiting for the player to complete their turn...</span>
        {% endif %}
    </div>

    <!-- Enemy Attack Section -->
    <div style="margin-bottom: 20px; padding: 15px; background: #2a1a1a; border: 2px solid var(--lcars-red); border-radius: 5px;">
        <h3 style="color: var(--lcars-red); font-size: 1em; margin-bottom: 15px;">ENEMY ATTACK</h3>
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
                <label for="attack-enemy">Attacking Ship</label>
                <select id="attack-enemy" style="width: 100%;" onchange="updateAttackWeapons()">
                    {% for enemy in enemy_ships %}
                    <option value="{{ loop.index0 }}">{{ enemy.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="attack-weapon">Weapon</label>
                <select id="attack-weapon" style="width: 100%;">
                    {% if enemy_ships %}
                    {% for weapon in enemy_ships[0].weapons %}
                    <option value="{{ loop.index0 }}" data-damage="{{ weapon.damage }}">
                        {{ weapon.name }} (Dmg {{ weapon.damage }})
                    </option>
                    {% endfor %}
                    {% endif %}
                </select>
            </div>
        </div>
        <div style="margin-top: 15px;">
            <button class="btn" onclick="executeEnemyAttack()" style="background: var(--lcars-red); width: 100%;">
                ATTACK PLAYER SHIP
            </button>
        </div>
    </div>

    <!-- Attack Results -->
    <div id="attack-results" style="display: none; margin-bottom: 20px; padding: 15px; border-radius: 5px;"></div>

    <!-- NPC Actions Section (NEW!) -->
    <div style="margin-bottom: 20px; padding: 15px; background: #1a2a3a; border: 2px solid var(--lcars-blue); border-radius: 5px;">
        <h3 style="color: var(--lcars-blue); font-size: 1em; margin-bottom: 15px;">NPC ACTIONS</h3>
        <p style="color: var(--lcars-tan); font-size: 0.85em; margin-bottom: 15px;">
            Execute actions for enemy ships using their Crew Quality for rolls.
        </p>

        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div>
                <label for="npc-action-ship">Acting Ship</label>
                <select id="npc-action-ship" style="width: 100%;" onchange="updateNpcActionShipInfo()">
                    {% for enemy in enemy_ships %}
                    <option value="{{ loop.index0 }}"
                            data-crew-quality="{{ enemy.crew_quality.value if enemy.crew_quality else 'talented' }}"
                            data-crew-attr="{{ enemy.crew_quality.attribute if enemy.crew_quality else 10 }}"
                            data-crew-dept="{{ enemy.crew_quality.department if enemy.crew_quality else 3 }}"
                            data-crew-target="{{ enemy.crew_quality.target_number if enemy.crew_quality else 13 }}">
                        {{ enemy.name }}
                        {% if enemy.crew_quality %}({{ enemy.crew_quality.value.title() }}){% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="npc-action-category">Action Category</label>
                <select id="npc-action-category" style="width: 100%;" onchange="updateNpcActionList()">
                    <option value="tactical_minor">Tactical (Minor)</option>
                    <option value="tactical_major">Tactical (Major)</option>
                    <option value="conn_major">Conn/Helm (Major)</option>
                    <option value="engineering_major">Engineering (Major)</option>
                    <option value="science_minor">Science (Minor)</option>
                    <option value="science_major">Science (Major)</option>
                </select>
            </div>
        </div>

        <div style="margin-bottom: 15px;">
            <label for="npc-action-select">Select Action</label>
            <select id="npc-action-select" style="width: 100%;" onchange="updateNpcActionDetails()">
                <!-- Populated by JavaScript -->
            </select>
        </div>

        <!-- NPC Ship Stats Display -->
        <div id="npc-ship-stats" style="padding: 10px; background: #222; border-radius: 5px; margin-bottom: 15px;">
            <strong style="color: var(--lcars-orange);">Crew Quality:</strong>
            <span id="npc-crew-quality-display">Talented</span>
            <span style="color: var(--lcars-tan);">
                (Attribute <span id="npc-attr-display">10</span> + Department <span id="npc-dept-display">3</span> = Target <span id="npc-target-display">13</span>)
            </span>
            <div style="margin-top: 5px; font-size: 0.85em; color: var(--lcars-green);">
                âœ“ NPC crew always have Focus (crits on 1s and 2s)
            </div>
        </div>

        <!-- Action Details -->
        <div id="npc-action-details" style="padding: 10px; background: #222; border-radius: 5px; margin-bottom: 15px; display: none;">
            <strong id="npc-action-name" style="color: var(--lcars-blue);"></strong>
            <div id="npc-action-type" style="font-size: 0.85em; color: var(--lcars-tan);"></div>
            <div id="npc-action-desc" style="margin-top: 5px;"></div>
        </div>

        <!-- Dice Roll Panel (for task roll actions) -->
        <div id="npc-dice-panel" style="display: none; padding: 10px; background: #1a1a2a; border: 1px solid var(--lcars-purple); border-radius: 5px; margin-bottom: 15px;">
            <h4 style="color: var(--lcars-purple); margin-bottom: 10px;">TASK ROLL</h4>
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label for="npc-roll-bonus">Bonus Dice (from Threat)</label>
                    <input type="number" id="npc-roll-bonus" value="0" min="0" max="3" style="width: 80px;">
                </div>
                <div>
                    <label for="npc-roll-difficulty">Difficulty</label>
                    <input type="number" id="npc-roll-difficulty" value="2" min="0" max="5" style="width: 80px;">
                </div>
            </div>
            <div id="npc-roll-results" style="display: none; margin-top: 10px; padding: 10px; background: #222; border-radius: 5px;"></div>
        </div>

        <button id="npc-action-execute-btn" class="btn" onclick="executeNpcAction()" style="background: var(--lcars-blue); width: 100%;">
            EXECUTE ACTION
        </button>

        <div id="npc-action-results" style="display: none; margin-top: 15px; padding: 10px; border-radius: 5px;"></div>
    </div>

    <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <div>
            <h3 style="color: var(--lcars-tan); font-size: 0.9em;">Quick Damage</h3>
            <div style="margin-top: 10px;">
                <label for="damage-target">Target</label>
                <select id="damage-target" style="width: 100%;">
                    <option value="player">Player Ship</option>
                    {% for enemy in enemy_ships %}
                    <option value="enemy-{{ loop.index0 }}">{{ enemy.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="margin-top: 10px;">
                <label for="damage-amount">Damage Amount</label>
                <input type="number" id="damage-amount" value="5" min="0" style="width: 100px;">
                <button class="btn btn-small" onclick="applyQuickDamage()">Apply</button>
            </div>
        </div>
        <div>
            <h3 style="color: var(--lcars-tan); font-size: 0.9em;">Quick Breach</h3>
            <div style="margin-top: 10px;">
                <label for="breach-target">Target</label>
                <select id="breach-target" style="width: 100%;">
                    <option value="player">Player Ship</option>
                    {% for enemy in enemy_ships %}
                    <option value="enemy-{{ loop.index0 }}">{{ enemy.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div style="margin-top: 10px;">
                <label for="breach-system">System</label>
                <select id="breach-system" style="width: 100%;">
                    <option value="comms">Comms</option>
                    <option value="computers">Computers</option>
                    <option value="engines">Engines</option>
                    <option value="sensors">Sensors</option>
                    <option value="structure">Structure</option>
                    <option value="weapons">Weapons</option>
                </select>
                <button class="btn btn-small" onclick="addQuickBreach()">Add</button>
            </div>
        </div>
    </div>
</div>

<!-- Active Effects Panel -->
<div class="panel" style="border-color: var(--lcars-blue);">
    <h2 style="color: var(--lcars-blue);">ACTIVE EFFECTS</h2>
    <div id="active-effects-list">
        {% if active_effects %}
            {% for effect in active_effects %}
            <div style="padding: 8px; background: #222; border-radius: 5px; margin: 5px 0;">
                <strong>{{ effect.source_action }}</strong>
                <span style="color: var(--lcars-tan);">({{ effect.applies_to }} - {{ effect.duration }})</span>
                <div style="font-size: 0.85em; color: var(--lcars-green);">
                    {% if effect.damage_bonus > 0 %}+{{ effect.damage_bonus }} damage{% endif %}
                    {% if effect.resistance_bonus > 0 %}+{{ effect.resistance_bonus }} resistance{% endif %}
                    {% if effect.can_reroll %}can re-roll{% endif %}
                    {% if effect.can_choose_system %}can choose system{% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="color: #666;">No active effects</p>
        {% endif %}
    </div>
</div>

<style>
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0 15px;
    }
    .breached {
        color: var(--lcars-red) !important;
    }
    .breach-indicator {
        color: var(--lcars-red);
        font-size: 0.8em;
        margin-left: 5px;
    }
    /* Turn banner styles */
    .turn-banner {
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 20px;
        font-size: 1.3em;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 2px;
    }
    .turn-banner.your-turn {
        background: linear-gradient(135deg, #2a1a3a, #4a2a5a);
        border: 3px solid var(--lcars-purple);
        color: var(--lcars-purple);
        animation: pulse-purple 2s ease-in-out infinite;
    }
    .turn-banner.player-turn {
        background: linear-gradient(135deg, #1a3a1a, #2a5a2a);
        border: 3px solid var(--lcars-green);
        color: var(--lcars-green);
    }
    @keyframes pulse-purple {
        0%, 100% { box-shadow: 0 0 10px var(--lcars-purple); }
        50% { box-shadow: 0 0 25px var(--lcars-purple); }
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-10px); }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const encounterId = '{{ encounter.encounter_id }}';
    const playerShipId = {{ player_ship_db_id if player_ship_db_id else 'null' }};
    const enemyShipIds = {{ enemy_ship_db_ids | tojson if enemy_ship_db_ids else '[]' }};
    const role = 'gm';
    let currentTurn = '{{ encounter.current_turn }}';

    // Update turn display
    function updateTurnDisplay(newTurn, newRound) {
        currentTurn = newTurn;
        const banner = document.getElementById('turn-banner');
        const gmControls = document.getElementById('gm-controls');
        const gmMessage = document.getElementById('gm-turn-message');
        const endTurnBtn = document.getElementById('end-turn-btn');

        if (newTurn === 'enemy') {
            banner.className = 'turn-banner your-turn';
            banner.querySelector('.turn-text').textContent = "YOUR TURN (GM) - Control enemy vessels";
            endTurnBtn.textContent = 'End Enemy Turn';
            gmControls.style.opacity = '1';
            gmMessage.innerHTML = '<span style="color: var(--lcars-green);">It\'s the enemy\'s turn. You can control enemy actions.</span>';
        } else {
            banner.className = 'turn-banner player-turn';
            banner.querySelector('.turn-text').textContent = "PLAYER'S TURN - Waiting for player actions...";
            endTurnBtn.textContent = 'End Player Turn';
            gmControls.style.opacity = '0.5';
            gmMessage.innerHTML = '<span style="color: var(--lcars-tan);">Waiting for the player to complete their turn...</span>';
        }

        // Update round in header
        document.querySelector('header h1').textContent = `{{ encounter.name }} - Round ${newRound} [GM]`;
    }

    async function updateMomentum(change) {
        const response = await fetch(`/api/encounter/${encounterId}/momentum`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({change})
        });
        const data = await response.json();
        document.getElementById('momentum').textContent = data.momentum;
    }

    async function updateThreat(change) {
        const response = await fetch(`/api/encounter/${encounterId}/threat`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({change})
        });
        const data = await response.json();
        document.getElementById('threat').textContent = data.threat;
    }

    async function nextTurn() {
        const response = await fetch(`/api/encounter/${encounterId}/next-turn`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        const data = await response.json();

        updateTurnDisplay(data.current_turn, data.round);
    }

    async function applyQuickDamage() {
        const target = document.getElementById('damage-target').value;
        const damage = parseInt(document.getElementById('damage-amount').value) || 0;

        let shipId;
        if (target === 'player') {
            shipId = playerShipId;
        } else {
            const enemyIndex = parseInt(target.replace('enemy-', ''));
            shipId = enemyShipIds[enemyIndex];
        }

        if (!shipId) {
            alert('Invalid target');
            return;
        }

        const response = await fetch(`/api/ship/${shipId}/damage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({damage})
        });
        const data = await response.json();

        showToast(`Applied ${damage} damage. Shield damage: ${data.shield_damage}, Hull damage: ${data.hull_damage}`);

        // Refresh the page to show updated values
        setTimeout(() => location.reload(), 1500);
    }

    async function addQuickBreach() {
        const target = document.getElementById('breach-target').value;
        const system = document.getElementById('breach-system').value;

        let shipId;
        if (target === 'player') {
            shipId = playerShipId;
        } else {
            const enemyIndex = parseInt(target.replace('enemy-', ''));
            shipId = enemyShipIds[enemyIndex];
        }

        if (!shipId) {
            alert('Invalid target');
            return;
        }

        const response = await fetch(`/api/ship/${shipId}/breach`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({system})
        });
        const data = await response.json();

        showToast(`Added breach to ${system.toUpperCase()}`);

        // Refresh the page to show updated values
        setTimeout(() => location.reload(), 1500);
    }

    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        const borderColor = type === 'error' ? 'var(--lcars-red)' : type === 'success' ? 'var(--lcars-green)' : 'var(--lcars-blue)';
        const bgColor = type === 'error' ? '#3a1a1a' : type === 'success' ? '#1a3a1a' : '#1a3a3a';
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: ${bgColor};
            border: 2px solid ${borderColor};
            border-radius: 5px;
            color: ${borderColor};
            font-weight: bold;
            z-index: 1000;
            animation: fadeIn 0.3s ease-in;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }

    // Enemy ship weapons data for dynamic dropdown
    const enemyShipsWeapons = [
        {% for enemy in enemy_ships %}
        [
            {% for weapon in enemy.weapons %}
            { name: "{{ weapon.name }}", damage: {{ weapon.damage }}, range: "{{ weapon.range.value }}" }{% if not loop.last %},{% endif %}
            {% endfor %}
        ]{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    function updateAttackWeapons() {
        const enemySelect = document.getElementById('attack-enemy');
        const weaponSelect = document.getElementById('attack-weapon');
        const enemyIndex = parseInt(enemySelect.value);

        // Clear current options
        weaponSelect.innerHTML = '';

        // Add weapons for selected enemy
        const weapons = enemyShipsWeapons[enemyIndex] || [];
        weapons.forEach((weapon, idx) => {
            const option = document.createElement('option');
            option.value = idx;
            option.dataset.damage = weapon.damage;
            option.textContent = `${weapon.name} (Dmg ${weapon.damage})`;
            weaponSelect.appendChild(option);
        });
    }

    async function executeEnemyAttack() {
        if (currentTurn !== 'enemy') {
            showToast("It's not the enemy's turn!", 'error');
            return;
        }

        const enemyIndex = parseInt(document.getElementById('attack-enemy').value);
        const weaponIndex = parseInt(document.getElementById('attack-weapon').value);
        const resultsDiv = document.getElementById('attack-results');

        try {
            const response = await fetch(`/api/encounter/${encounterId}/gm-attack`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    enemy_index: enemyIndex,
                    weapon_index: weaponIndex
                })
            });
            const data = await response.json();

            resultsDiv.style.display = 'block';

            if (data.error) {
                resultsDiv.style.background = '#3a1a1a';
                resultsDiv.style.border = '2px solid var(--lcars-red)';
                resultsDiv.innerHTML = `<strong style="color: var(--lcars-red);">ERROR:</strong> ${data.error}`;
                return;
            }

            // Build results display
            let html = '';

            if (data.has_defensive_effect) {
                // Opposed roll results
                html += `
                    <div style="margin-bottom: 15px; padding: 10px; background: #1a2a3a; border-radius: 5px;">
                        <strong style="color: var(--lcars-purple);">OPPOSED ROLL - ${data.defense_effect_name}</strong>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                            <div>
                                <strong style="color: var(--lcars-green);">Defender (${data.defender})</strong><br>
                                Rolls: ${data.defender_rolls.join(', ')} (Target: ${data.defender_target})<br>
                                Ship Assist: ${data.defender_ship_roll} (Target: ${data.defender_ship_target})<br>
                                <strong>Successes: ${data.defender_successes}</strong>
                            </div>
                            <div>
                                <strong style="color: var(--lcars-red);">Attacker (${data.attacker})</strong><br>
                                Rolls: ${data.attacker_rolls.join(', ')} (Target: ${data.attacker_target})<br>
                                Ship Assist: ${data.attacker_ship_roll} (Target: ${data.attacker_ship_target})<br>
                                <strong>Successes: ${data.attacker_successes}</strong>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (data.attack_result === 'missed') {
                resultsDiv.style.background = '#1a3a1a';
                resultsDiv.style.border = '2px solid var(--lcars-green)';
                html += `
                    <div style="font-size: 1.2em; color: var(--lcars-green); margin-bottom: 10px;">
                        <strong>ATTACK MISSED!</strong>
                    </div>
                    <p>${data.message}</p>
                `;

                if (data.can_counterattack) {
                    html += `
                        <div style="margin-top: 15px; padding: 10px; background: #2a2a1a; border: 2px solid var(--lcars-orange); border-radius: 5px;">
                            <strong style="color: var(--lcars-orange);">COUNTERATTACK AVAILABLE</strong>
                            <p style="margin: 10px 0;">Cost: 2 Momentum (Current: ${data.current_momentum})</p>
                            <p>Weapon: ${data.counterattack_weapon}</p>
                            <button class="btn" onclick="executeCounterattack(${data.counterattack_weapon_index}, ${enemyIndex})"
                                    style="background: var(--lcars-orange);"
                                    ${data.current_momentum < 2 ? 'disabled' : ''}>
                                COUNTERATTACK (2 Momentum)
                            </button>
                        </div>
                    `;
                }
            } else {
                // Attack hit
                resultsDiv.style.background = '#3a1a1a';
                resultsDiv.style.border = '2px solid var(--lcars-red)';
                html += `
                    <div style="font-size: 1.2em; color: var(--lcars-red); margin-bottom: 10px;">
                        <strong>ATTACK HIT!</strong>
                    </div>
                    <p>${data.message}</p>
                    <div style="margin-top: 10px;">
                        <strong>Damage Breakdown:</strong><br>
                        Base Damage: ${data.base_damage}<br>
                        After Resistance (${data.effective_resistance}): ${data.damage_after_resistance}<br>
                        ${data.complication_reduction > 0 ? `Complication Reduction: -${data.complication_reduction}<br>` : ''}
                        <strong>Total Damage: ${data.total_damage}</strong>
                    </div>
                    <div style="margin-top: 10px;">
                        Shield Damage: ${data.shield_damage}<br>
                        Hull Damage: ${data.hull_damage}<br>
                        ${data.breaches_caused > 0 ? `<strong style="color: var(--lcars-orange);">Breaches: ${data.breaches_caused} (${data.systems_hit.join(', ')})</strong>` : ''}
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;

            // Only auto-reload if no counterattack is available
            // If counterattack is available, wait for user to decide
            if (!data.can_counterattack) {
                setTimeout(() => location.reload(), 3000);
            }

        } catch (err) {
            resultsDiv.style.display = 'block';
            resultsDiv.style.background = '#3a1a1a';
            resultsDiv.style.border = '2px solid var(--lcars-red)';
            resultsDiv.innerHTML = `<strong style="color: var(--lcars-red);">ERROR:</strong> ${err.message}`;
        }
    }

    async function executeCounterattack(weaponIndex, targetIndex) {
        const resultsDiv = document.getElementById('attack-results');

        try {
            const response = await fetch(`/api/encounter/${encounterId}/counterattack`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    weapon_index: weaponIndex,
                    target_index: targetIndex
                })
            });
            const data = await response.json();

            if (data.error) {
                showToast(data.error, 'error');
                return;
            }

            let html = `
                <div style="margin-bottom: 15px; padding: 10px; background: #2a2a1a; border-radius: 5px;">
                    <strong style="color: var(--lcars-orange);">COUNTERATTACK</strong>
                    <div style="margin-top: 10px;">
                        Rolls: ${data.rolls.join(', ')} (Target: ${data.target_number})<br>
                        Ship Assist: ${data.ship_roll} (Target: ${data.ship_target})<br>
                        <strong>Successes: ${data.successes}</strong> vs Difficulty ${data.difficulty}
                    </div>
                </div>
            `;

            if (data.succeeded) {
                html += `
                    <div style="font-size: 1.2em; color: var(--lcars-green); margin-bottom: 10px;">
                        <strong>COUNTERATTACK HIT!</strong>
                    </div>
                    <p>${data.message}</p>
                    <div style="margin-top: 10px;">
                        Total Damage: ${data.total_damage}<br>
                        Shield Damage: ${data.shield_damage}<br>
                        Hull Damage: ${data.hull_damage}<br>
                        ${data.breaches_caused > 0 ? `<strong style="color: var(--lcars-orange);">Breaches: ${data.breaches_caused} (${data.systems_hit.join(', ')})</strong>` : ''}
                    </div>
                `;
                resultsDiv.style.background = '#1a3a1a';
                resultsDiv.style.border = '2px solid var(--lcars-green)';
            } else {
                html += `
                    <div style="font-size: 1.2em; color: var(--lcars-tan); margin-bottom: 10px;">
                        <strong>COUNTERATTACK MISSED</strong>
                    </div>
                    <p>${data.message}</p>
                `;
                resultsDiv.style.background = '#2a2a2a';
                resultsDiv.style.border = '2px solid var(--lcars-tan)';
            }

            html += `<p style="margin-top: 10px;">Momentum spent: ${data.momentum_spent} (Remaining: ${data.momentum_remaining})</p>`;
            resultsDiv.innerHTML = html;

            // Update momentum display
            document.getElementById('momentum').textContent = data.momentum_remaining;

            // Refresh page after a delay
            setTimeout(() => location.reload(), 3000);

        } catch (err) {
            showToast('Counterattack failed: ' + err.message, 'error');
        }
    }

    // ===== NPC ACTIONS SYSTEM =====

    // NPC Actions by category (must match action_config.py NPC_ACTIONS)
    const NPC_ACTIONS = {
        tactical_minor: [
            { name: "Calibrate Weapons", type: "buff", desc: "Next attack: +1 damage" },
            { name: "Targeting Solution", type: "buff", desc: "Next attack: can re-roll or choose system" },
            { name: "Raise Shields", type: "toggle", desc: "Raise shields to maximum" },
            { name: "Lower Shields", type: "toggle", desc: "Lower shields (set to 0)" },
            { name: "Arm Weapons", type: "toggle", desc: "Arm weapons (can be detected)" },
            { name: "Disarm Weapons", type: "toggle", desc: "Disarm weapons" },
        ],
        tactical_major: [
            { name: "Modulate Shields", type: "task_roll", difficulty: 1, desc: "Control + Engineering: +2 Resistance until next turn" },
            { name: "Defensive Fire", type: "special", desc: "Set up counterattack opportunity" },
        ],
        conn_minor: [],
        conn_major: [
            { name: "Attack Pattern", type: "buff", desc: "Assist ship attacks, but enemies get -1 difficulty vs this ship" },
            { name: "Evasive Action", type: "buff", desc: "Enemy attacks become opposed rolls" },
            { name: "Maneuver", type: "task_roll", difficulty: 2, desc: "Control + Conn: Generate Momentum for terrain" },
        ],
        engineering_minor: [],
        engineering_major: [
            { name: "Damage Control", type: "task_roll", difficulty: 2, desc: "Presence + Engineering: Patch a breach" },
        ],
        science_minor: [
            { name: "Calibrate Sensors", type: "buff", desc: "Next sensor action: ignore trait or re-roll" },
        ],
        science_major: [
            { name: "Scan For Weakness", type: "task_roll", difficulty: 2, desc: "Control + Science: Next attack +2 damage or Piercing" },
            { name: "Sensor Sweep", type: "task_roll", difficulty: 1, desc: "Reason + Science: Get info, generate Momentum" },
        ],
    };

    // Enemy ships data for NPC actions
    const enemyShipsData = [
        {% for enemy in enemy_ships %}
        {
            name: "{{ enemy.name }}",
            crew_quality: "{{ enemy.crew_quality.value if enemy.crew_quality else 'talented' }}",
            crew_attr: {{ enemy.crew_quality.attribute if enemy.crew_quality else 10 }},
            crew_dept: {{ enemy.crew_quality.department if enemy.crew_quality else 3 }},
            crew_target: {{ enemy.crew_quality.target_number if enemy.crew_quality else 13 }},
            systems: {
                comms: {{ enemy.systems.comms }},
                computers: {{ enemy.systems.computers }},
                engines: {{ enemy.systems.engines }},
                sensors: {{ enemy.systems.sensors }},
                structure: {{ enemy.systems.structure }},
                weapons: {{ enemy.systems.weapons }}
            },
            departments: {
                command: {{ enemy.departments.command }},
                conn: {{ enemy.departments.conn }},
                engineering: {{ enemy.departments.engineering }},
                medicine: {{ enemy.departments.medicine }},
                science: {{ enemy.departments.science }},
                security: {{ enemy.departments.security }}
            }
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    let selectedNpcAction = null;

    // Initialize NPC action panel
    function initNpcActionPanel() {
        updateNpcActionList();
        updateNpcActionShipInfo();
    }

    function updateNpcActionShipInfo() {
        const shipSelect = document.getElementById('npc-action-ship');
        const option = shipSelect.options[shipSelect.selectedIndex];

        document.getElementById('npc-crew-quality-display').textContent =
            option.dataset.crewQuality.charAt(0).toUpperCase() + option.dataset.crewQuality.slice(1);
        document.getElementById('npc-attr-display').textContent = option.dataset.crewAttr;
        document.getElementById('npc-dept-display').textContent = option.dataset.crewDept;
        document.getElementById('npc-target-display').textContent = option.dataset.crewTarget;
    }

    function updateNpcActionList() {
        const category = document.getElementById('npc-action-category').value;
        const actionSelect = document.getElementById('npc-action-select');
        const actions = NPC_ACTIONS[category] || [];

        actionSelect.innerHTML = '';

        if (actions.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = '(No actions in this category)';
            actionSelect.appendChild(opt);
            document.getElementById('npc-action-details').style.display = 'none';
            document.getElementById('npc-dice-panel').style.display = 'none';
            return;
        }

        actions.forEach((action, idx) => {
            const opt = document.createElement('option');
            opt.value = action.name;
            opt.dataset.type = action.type;
            opt.dataset.difficulty = action.difficulty || 0;
            opt.dataset.desc = action.desc;
            opt.textContent = action.name;
            actionSelect.appendChild(opt);
        });

        updateNpcActionDetails();
    }

    function updateNpcActionDetails() {
        const actionSelect = document.getElementById('npc-action-select');
        const option = actionSelect.options[actionSelect.selectedIndex];

        if (!option || !option.value) {
            document.getElementById('npc-action-details').style.display = 'none';
            document.getElementById('npc-dice-panel').style.display = 'none';
            selectedNpcAction = null;
            return;
        }

        selectedNpcAction = {
            name: option.value,
            type: option.dataset.type,
            difficulty: parseInt(option.dataset.difficulty) || 0,
            desc: option.dataset.desc
        };

        // Update action details display
        document.getElementById('npc-action-name').textContent = selectedNpcAction.name;
        document.getElementById('npc-action-type').textContent = `Type: ${selectedNpcAction.type}`;
        document.getElementById('npc-action-desc').textContent = selectedNpcAction.desc;
        document.getElementById('npc-action-details').style.display = 'block';

        // Show/hide dice panel based on action type
        if (selectedNpcAction.type === 'task_roll') {
            document.getElementById('npc-dice-panel').style.display = 'block';
            document.getElementById('npc-roll-difficulty').value = selectedNpcAction.difficulty;
            document.getElementById('npc-roll-results').style.display = 'none';
        } else {
            document.getElementById('npc-dice-panel').style.display = 'none';
        }

        // Update button text based on action type
        const btn = document.getElementById('npc-action-execute-btn');
        if (selectedNpcAction.type === 'task_roll') {
            btn.textContent = 'ROLL & EXECUTE ACTION';
        } else if (selectedNpcAction.type === 'buff') {
            btn.textContent = 'APPLY BUFF';
        } else if (selectedNpcAction.type === 'toggle') {
            btn.textContent = 'TOGGLE';
        } else {
            btn.textContent = 'EXECUTE ACTION';
        }
    }

    async function executeNpcAction() {
        if (currentTurn !== 'enemy') {
            showToast("It's not the enemy's turn!", 'error');
            return;
        }

        if (!selectedNpcAction) {
            showToast("Please select an action first", 'error');
            return;
        }

        const shipIndex = parseInt(document.getElementById('npc-action-ship').value);
        const shipId = enemyShipIds[shipIndex];
        const shipData = enemyShipsData[shipIndex];
        const resultsDiv = document.getElementById('npc-action-results');

        const bonusDice = parseInt(document.getElementById('npc-roll-bonus').value) || 0;
        const difficulty = parseInt(document.getElementById('npc-roll-difficulty').value) || selectedNpcAction.difficulty;

        try {
            const response = await fetch(`/api/encounter/${encounterId}/npc-action`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    ship_index: shipIndex,
                    ship_id: shipId,
                    action_name: selectedNpcAction.name,
                    action_type: selectedNpcAction.type,
                    bonus_dice: bonusDice,
                    difficulty: difficulty,
                    // NPC uses crew quality for rolls
                    attribute: shipData.crew_attr,
                    department: shipData.crew_dept,
                    focus: true,  // NPCs always have focus
                })
            });
            const data = await response.json();

            resultsDiv.style.display = 'block';

            if (data.error) {
                resultsDiv.style.background = '#3a1a1a';
                resultsDiv.style.border = '2px solid var(--lcars-red)';
                resultsDiv.innerHTML = `<strong style="color: var(--lcars-red);">ERROR:</strong> ${data.error}`;
                return;
            }

            // Build results display
            let html = `<strong style="color: var(--lcars-blue);">${selectedNpcAction.name}</strong><br>`;

            if (data.roll_results) {
                // Task roll action
                const rollDiv = document.getElementById('npc-roll-results');
                rollDiv.style.display = 'block';

                const diceHtml = data.roll_results.rolls.map((r, i) => {
                    let color = r <= data.roll_results.target ? 'var(--lcars-green)' : 'var(--lcars-red)';
                    let style = `display:inline-block; width:40px; height:40px; line-height:40px; text-align:center; background:#333; border:2px solid ${color}; border-radius:5px; margin:2px; font-size:1.2em; color:${color};`;
                    let label = '';
                    if (r === 1) label = 'â­';
                    else if (r <= 2 && data.roll_results.has_focus) label = 'â­';
                    else if (r === 20) label = 'ðŸ’¥';
                    return `<span style="${style}">${r}${label}</span>`;
                }).join('');

                html += `
                    <div style="margin: 10px 0;">
                        <strong>Dice:</strong> ${diceHtml}
                    </div>
                    <div>
                        Target: ${data.roll_results.target} |
                        Successes: <strong style="color: ${data.roll_results.succeeded ? 'var(--lcars-green)' : 'var(--lcars-red)'};">${data.roll_results.successes}</strong> vs Difficulty ${data.roll_results.difficulty}
                    </div>
                `;

                if (data.roll_results.succeeded) {
                    resultsDiv.style.background = '#1a3a1a';
                    resultsDiv.style.border = '2px solid var(--lcars-green)';
                    html += `<div style="margin-top: 10px; color: var(--lcars-green);"><strong>SUCCESS!</strong> ${data.message}</div>`;
                } else {
                    resultsDiv.style.background = '#3a1a1a';
                    resultsDiv.style.border = '2px solid var(--lcars-red)';
                    html += `<div style="margin-top: 10px; color: var(--lcars-red);"><strong>FAILED!</strong> ${data.message}</div>`;
                }

                if (data.roll_results.momentum_generated > 0) {
                    html += `<div style="margin-top: 5px; color: var(--lcars-orange);">Momentum generated: +${data.roll_results.momentum_generated}</div>`;
                }
            } else {
                // Buff or toggle action
                resultsDiv.style.background = '#1a3a1a';
                resultsDiv.style.border = '2px solid var(--lcars-green)';
                html += `<div style="margin-top: 10px; color: var(--lcars-green);"><strong>SUCCESS!</strong> ${data.message}</div>`;
            }

            resultsDiv.innerHTML = html;

            // Refresh page after a delay to show updated state
            setTimeout(() => location.reload(), 2500);

        } catch (err) {
            resultsDiv.style.display = 'block';
            resultsDiv.style.background = '#3a1a1a';
            resultsDiv.style.border = '2px solid var(--lcars-red)';
            resultsDiv.innerHTML = `<strong style="color: var(--lcars-red);">ERROR:</strong> ${err.message}`;
        }
    }

    // Initialize NPC action panel on page load
    document.addEventListener('DOMContentLoaded', initNpcActionPanel);

    // Poll for turn changes and updates
    setInterval(async () => {
        try {
            const response = await fetch(`/api/encounter/${encounterId}/status`);
            if (response.ok) {
                const data = await response.json();
                if (data.current_turn !== currentTurn) {
                    updateTurnDisplay(data.current_turn, data.round);
                }
                document.getElementById('momentum').textContent = data.momentum;
                document.getElementById('threat').textContent = data.threat;
            }
        } catch (e) {
            // Ignore errors during polling
        }
    }, 3000);
</script>
{% endblock %}
