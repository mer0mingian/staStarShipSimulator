{% extends "base.html" %}

{% block title %}STA Starship Simulator{% endblock %}

{% block header %}Welcome to Star Trek Adventures{% endblock %}

{% block content %}
<div style="max-width: 700px; margin: 0 auto;">
    <!-- Connection Info Banner -->
    <div id="connection-banner" class="connection-banner" style="display: none;">
        <div class="banner-header">
            <div class="banner-title">Players Can Join At</div>
            <button class="banner-close" onclick="closeBanner()" title="Close">&times;</button>
        </div>
        <div class="banner-content">
            <div class="banner-qr">
                <img id="qr-code" alt="QR Code" width="120" height="120">
            </div>
            <div class="banner-info">
                <div class="banner-url" id="join-url">Loading...</div>
                <div class="banner-note">
                    Players must be on the same WiFi network
                </div>
                <button class="banner-copy" onclick="copyUrl()">
                    <span id="copy-text">Copy Link</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Selection Panel -->
    <div class="lcars-bar-capped">
        <div class="bar-cap"></div>
        <div class="bar-content">Select Your Role</div>
        <div class="bar-cap"></div>
    </div>

    <p class="text-center mb-3" style="color: var(--lcars-almond);">
        How would you like to participate in today's session?
    </p>

    <div class="lcars-grid-2" style="max-width: 600px; margin: 0 auto;">
        <!-- Player Card -->
        <a href="{{ url_for('campaigns.player_home') }}" class="role-card role-player">
            <div class="role-icon">
                <svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
            </div>
            <div class="role-title">Player</div>
            <div class="role-desc">Join a campaign and take your station on the bridge</div>
            <div class="role-pill">
                <span class="lcars-pill pill-orange">Connect</span>
            </div>
        </a>

        <!-- GM Card -->
        <a href="{{ url_for('campaigns.gm_home') }}" class="role-card role-gm">
            <div class="role-icon">
                <svg viewBox="0 0 24 24" fill="currentColor" width="48" height="48">
                    <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                </svg>
            </div>
            <div class="role-title">Game Master</div>
            <div class="role-desc">Create and run campaigns for your crew</div>
            <div class="role-pill">
                <span class="lcars-pill pill-violet">Command</span>
            </div>
        </a>
    </div>

    <!-- Info Panel -->
    <div class="lcars-panel panel-blue mt-3" style="text-align: center;">
        <div class="lcars-pills" style="justify-content: center;">
            <span class="lcars-pill pill-ice">STA 2E</span>
            <span class="lcars-pill pill-gold">Starship Combat</span>
            <span class="lcars-pill pill-violet">Simulator</span>
        </div>
    </div>
</div>

<style>
    .role-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 30px 20px;
        background: var(--lcars-panel-bg);
        border: 3px solid var(--lcars-butterscotch);
        border-radius: 20px;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .role-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 30px rgba(255, 153, 0, 0.2);
        filter: brightness(110%);
        text-decoration: none;
    }

    .role-player {
        border-color: var(--lcars-orange);
    }

    .role-player:hover {
        border-color: var(--lcars-gold);
        box-shadow: 0 8px 30px rgba(255, 153, 0, 0.3);
    }

    .role-gm {
        border-color: var(--lcars-african-violet);
    }

    .role-gm:hover {
        border-color: var(--lcars-lilac);
        box-shadow: 0 8px 30px rgba(204, 153, 255, 0.3);
    }

    .role-icon {
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        border-radius: 50%;
        background: #1a1a1a;
    }

    .role-player .role-icon {
        color: var(--lcars-orange);
        border: 3px solid var(--lcars-orange);
    }

    .role-gm .role-icon {
        color: var(--lcars-african-violet);
        border: 3px solid var(--lcars-african-violet);
    }

    .role-title {
        font-size: 1.5rem;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 10px;
    }

    .role-player .role-title {
        color: var(--lcars-orange);
    }

    .role-gm .role-title {
        color: var(--lcars-african-violet);
    }

    .role-desc {
        color: var(--lcars-almond);
        font-size: 0.95rem;
        text-align: center;
        margin-bottom: 15px;
    }

    .role-pill {
        margin-top: auto;
    }

    @media (max-width: 600px) {
        .lcars-grid-2 {
            grid-template-columns: 1fr;
        }

        .role-card {
            padding: 25px 15px;
        }
    }

    /* Connection Banner Styles */
    .connection-banner {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        border: 3px solid var(--lcars-sunflower);
        border-radius: 20px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 20px rgba(255, 204, 0, 0.2);
    }

    .banner-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .banner-title {
        font-size: 1.1rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--lcars-sunflower);
        letter-spacing: 1px;
    }

    .banner-close {
        background: none;
        border: none;
        color: var(--lcars-almond);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0 5px;
        line-height: 1;
        opacity: 0.7;
        transition: opacity 0.2s;
    }

    .banner-close:hover {
        opacity: 1;
        color: var(--lcars-sunflower);
    }

    .banner-content {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .banner-qr {
        flex-shrink: 0;
        background: white;
        padding: 8px;
        border-radius: 10px;
    }

    .banner-qr img {
        display: block;
    }

    .banner-info {
        flex: 1;
        min-width: 0;
    }

    .banner-url {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--lcars-ice);
        word-break: break-all;
        margin-bottom: 8px;
        font-family: monospace;
    }

    .banner-note {
        font-size: 0.9rem;
        color: var(--lcars-almond);
        opacity: 0.8;
        margin-bottom: 12px;
    }

    .banner-copy {
        background: var(--lcars-sunflower);
        color: #000;
        border: none;
        padding: 8px 16px;
        border-radius: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.9rem;
    }

    .banner-copy:hover {
        background: var(--lcars-gold);
        transform: scale(1.05);
    }

    .banner-copy.copied {
        background: var(--lcars-green);
    }

    @media (max-width: 500px) {
        .banner-content {
            flex-direction: column;
            text-align: center;
        }

        .banner-qr {
            margin: 0 auto;
        }

        .banner-url {
            font-size: 1.1rem;
        }
    }
</style>

<script>
    let serverUrl = '';

    // Fetch server info and show banner
    async function loadServerInfo() {
        try {
            const response = await fetch('/api/server-info');
            const data = await response.json();

            serverUrl = data.url;

            // Update URL display
            document.getElementById('join-url').textContent = serverUrl;

            // Generate QR code using QR Server API
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(serverUrl)}`;
            document.getElementById('qr-code').src = qrUrl;

            // Show banner (check if user hasn't dismissed it this session)
            if (!sessionStorage.getItem('bannerDismissed')) {
                document.getElementById('connection-banner').style.display = 'block';
            }
        } catch (error) {
            console.error('Failed to load server info:', error);
        }
    }

    function closeBanner() {
        document.getElementById('connection-banner').style.display = 'none';
        sessionStorage.setItem('bannerDismissed', 'true');
    }

    async function copyUrl() {
        try {
            await navigator.clipboard.writeText(serverUrl);
            const btn = document.querySelector('.banner-copy');
            const text = document.getElementById('copy-text');
            btn.classList.add('copied');
            text.textContent = 'Copied!';
            setTimeout(() => {
                btn.classList.remove('copied');
                text.textContent = 'Copy Link';
            }, 2000);
        } catch (error) {
            console.error('Failed to copy:', error);
        }
    }

    // Load server info when page loads
    document.addEventListener('DOMContentLoaded', loadServerInfo);
</script>
{% endblock %}
