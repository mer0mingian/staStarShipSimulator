<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ encounter.name }} - Player View</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lcars.css') }}">
    <style>
        /* Player View - Full viewport with custom left nav */
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .player-wrapper {
            display: flex;
            height: 100vh;
            background: var(--lcars-bg);
        }

        /* Left Navigation Panel */
        .player-left-nav {
            width: 180px;
            display: flex;
            flex-direction: column;
            padding: 10px;
            gap: 3px;
            flex-shrink: 0;
        }

        .player-nav-top {
            background: var(--lcars-bluey);
            height: 60px;
            border-radius: 30px 0 0 0;
            display: flex;
            align-items: flex-end;
            padding: 10px 15px;
        }

        .player-nav-top span {
            color: var(--lcars-text-dark);
            font-size: 0.8rem;
            font-weight: 700;
        }

        .player-nav-tabs {
            display: flex;
            flex-direction: column;
            gap: 3px;
            flex: 1;
        }

        .player-nav-tab {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 12px 15px;
            background: var(--lcars-butterscotch);
            color: var(--lcars-text-dark);
            text-decoration: none;
            font-family: var(--font-primary);
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: filter 0.1s;
        }

        .player-nav-tab:hover {
            filter: brightness(115%);
        }

        .player-nav-tab.active {
            background: var(--lcars-text);
            color: var(--lcars-bg);
        }

        /* Tab-specific colors */
        .player-nav-tab.tab-actions { background: var(--lcars-tomato); }
        .player-nav-tab.tab-map { background: var(--lcars-butterscotch); }
        .player-nav-tab.tab-character { background: var(--lcars-bluey); }
        .player-nav-tab.tab-ship { background: var(--lcars-african-violet); }

        .player-nav-spacer {
            flex: 1;
            background: var(--lcars-ice);
            min-height: 20px;
        }

        .player-nav-bottom {
            background: var(--lcars-success);
            height: 50px;
            border-radius: 0 0 0 30px;
        }

        /* Main Content Area */
        .player-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px 10px 10px 0;
            min-width: 0;
        }

        /* Header Bar */
        .player-header {
            display: flex;
            height: 60px;
            gap: 3px;
            margin-bottom: 10px;
        }

        .player-header-bar {
            flex: 1;
            background: var(--lcars-bluey);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            border-radius: 0 0 0 20px;
        }

        .player-header-title {
            color: var(--lcars-text-dark);
            font-size: 1.4rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .player-header-round {
            color: var(--lcars-text-dark);
            font-size: 1.1rem;
            font-weight: 700;
        }

        .player-header-cap {
            width: 80px;
            background: var(--lcars-bluey);
            border-radius: 0 30px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Tab Content Panels */
        .player-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* Turn Banner */
        .turn-banner {
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .turn-banner.your-turn {
            background: linear-gradient(135deg, #1a3a1a, #2a5a2a);
            border: 3px solid var(--lcars-success);
            color: var(--lcars-success);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        .turn-banner.enemy-turn {
            background: linear-gradient(135deg, #3a1a1a, #5a2a2a);
            border: 3px solid var(--lcars-tomato);
            color: var(--lcars-tomato);
        }

        .turn-banner.waiting-turn {
            background: linear-gradient(135deg, #2a2a1a, #3a3a2a);
            border: 3px solid var(--lcars-butterscotch);
            color: var(--lcars-butterscotch);
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px var(--lcars-success); }
            50% { box-shadow: 0 0 25px var(--lcars-success); }
        }

        /* Claim Turn Panel - prominent call to action */
        .claim-turn-panel {
            padding: 25px;
            background: linear-gradient(135deg, #1a2a3a, #2a3a4a);
            border: 3px solid var(--lcars-ice);
            border-radius: 12px;
            text-align: center;
            margin-bottom: 15px;
        }

        .claim-turn-panel h3 {
            color: var(--lcars-ice);
            margin: 0 0 10px 0;
            font-size: 1.3em;
        }

        .claim-turn-panel p {
            color: var(--lcars-almond);
            margin: 0 0 15px 0;
            font-size: 0.95em;
        }

        .claim-turn-btn {
            padding: 15px 40px;
            font-size: 1.2em;
            background: var(--lcars-success);
            border: none;
            border-radius: 25px;
            color: var(--lcars-text-dark);
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            transition: all 0.2s ease;
            animation: pulse-claim 2s ease-in-out infinite;
        }

        .claim-turn-btn:hover {
            background: var(--lcars-ice);
            transform: scale(1.05);
        }

        @keyframes pulse-claim {
            0%, 100% { box-shadow: 0 0 10px var(--lcars-success); }
            50% { box-shadow: 0 0 25px var(--lcars-success), 0 0 40px rgba(153, 204, 153, 0.3); }
        }

        /* Turn instruction text */
        .turn-instruction {
            font-size: 0.9em;
            color: var(--lcars-almond);
            margin-top: 8px;
            font-weight: normal;
            text-transform: none;
        }

        /* Resource Panel */
        .resources-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .resource-box {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: var(--lcars-panel-bg);
            border-radius: 10px;
            border: 2px solid var(--lcars-gray);
        }

        .resource-box.momentum {
            border-color: var(--lcars-ice);
        }

        .resource-box.threat {
            border-color: var(--lcars-tomato);
        }

        .resource-box.reserve-power {
            border-color: var(--lcars-success);
        }

        .resource-box.reserve-power.depleted {
            border-color: var(--lcars-tomato);
        }

        .resource-label {
            font-size: 0.9rem;
            color: var(--lcars-almond);
            text-transform: uppercase;
        }

        .resource-value {
            font-size: 1.5rem;
            font-weight: 700;
            min-width: 40px;
            text-align: center;
        }

        .momentum .resource-value { color: var(--lcars-ice); }
        .threat .resource-value { color: var(--lcars-tomato); }
        .reserve-power .resource-value { color: var(--lcars-success); }
        .reserve-power.depleted .resource-value { color: var(--lcars-tomato); }

        /* Turn Counter */
        .turn-counter {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .turn-count {
            padding: 5px 15px;
            border-radius: 15px;
            background: #1a1a1a;
        }

        .turn-count.player { color: var(--lcars-success); }
        .turn-count.enemy { color: var(--lcars-tomato); }

        /* Map and Log Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 15px;
            margin-top: 15px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .map-panel {
            background: #0a0a0a;
            border: 2px solid var(--lcars-bluey);
            border-radius: 10px;
            padding: 15px;
            min-height: 400px;
        }

        .map-panel h3 {
            color: var(--lcars-bluey);
            margin-bottom: 10px;
        }

        #tactical-map-container {
            min-height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Ship Panel */
        .ship-panel {
            background: var(--lcars-panel-bg);
            border: 2px solid var(--lcars-butterscotch);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .ship-panel.player-ship {
            border-color: var(--lcars-success);
        }

        .ship-panel.player-ship h3 {
            color: var(--lcars-success);
        }

        .ship-panel.enemy-ship {
            border-color: var(--lcars-tomato);
        }

        .ship-panel.enemy-ship h3 {
            color: var(--lcars-tomato);
        }

        .ship-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ship-header h3 {
            margin: 0;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px 15px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #333;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--lcars-almond);
        }

        .stat-value {
            color: var(--lcars-ice);
            font-weight: 700;
        }

        .stat-row.breached .stat-label,
        .stat-row.breached .stat-value {
            color: var(--lcars-tomato);
        }

        /* Shields Bar */
        .shields-bar {
            height: 20px;
            background: var(--lcars-gray);
            border-radius: 10px;
            overflow: hidden;
            margin: 8px 0;
        }

        .shields-bar .fill {
            height: 100%;
            background: var(--lcars-ice);
            border-radius: 10px;
            transition: width 0.3s;
        }

        /* Character Panel */
        .character-panel {
            background: var(--lcars-panel-bg);
            border: 2px solid var(--lcars-bluey);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .character-panel h3 {
            color: var(--lcars-bluey);
            margin-bottom: 10px;
        }

        .section-header {
            color: var(--lcars-almond);
            font-size: 0.9em;
            margin: 15px 0 8px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Action Lists */
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        @media (max-width: 900px) {
            .actions-grid {
                grid-template-columns: 1fr;
            }
        }

        .action-panel {
            background: var(--lcars-panel-bg);
            border: 2px solid var(--lcars-butterscotch);
            border-radius: 10px;
            padding: 15px;
        }

        .action-panel.minor {
            border-color: var(--lcars-ice);
        }

        .action-panel.minor h3 {
            color: var(--lcars-ice);
        }

        .action-panel.major {
            border-color: var(--lcars-tomato);
        }

        .action-panel.major h3 {
            color: var(--lcars-tomato);
        }

        .action-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .action-list li {
            padding: 10px;
            margin: 5px 0;
            background: #1a1a1a;
            border-radius: 5px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .action-list li:hover {
            background: #222;
            border-left-color: var(--lcars-butterscotch);
        }

        .action-list li.action-selected {
            background: rgba(153, 204, 255, 0.2);
            border-left-color: var(--lcars-ice);
            box-shadow: 0 0 10px rgba(153, 204, 255, 0.3);
        }

        .action-list li.action-disabled {
            opacity: 0.4;
            pointer-events: none;
        }

        .action-list li.action-not-impl {
            opacity: 0.5;
        }

        .action-type {
            font-size: 0.85em;
            color: #888;
            margin-top: 3px;
        }

        /* Action cost badges */
        .action-cost-badges {
            display: flex;
            gap: 6px;
            margin-top: 5px;
        }

        .action-cost-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .action-cost-badge.momentum {
            background: rgba(153, 204, 255, 0.2);
            border: 1px solid var(--lcars-ice);
            color: var(--lcars-ice);
        }

        .action-cost-badge.threat {
            background: rgba(255, 102, 102, 0.2);
            border: 1px solid var(--lcars-tomato);
            color: var(--lcars-tomato);
        }

        .action-cost-badge.reserve-power {
            background: rgba(153, 204, 153, 0.2);
            border: 1px solid var(--lcars-success);
            color: var(--lcars-success);
        }

        .action-cost-badge.difficulty {
            background: rgba(255, 153, 0, 0.2);
            border: 1px solid var(--lcars-orange);
            color: var(--lcars-orange);
        }

        .action-cost-badge.no-roll {
            background: rgba(170, 102, 204, 0.2);
            border: 1px solid var(--lcars-african-violet);
            color: var(--lcars-african-violet);
        }


        /* Action Detail Panels */
        .action-detail-panel {
            background: var(--lcars-panel-bg);
            border: 2px solid var(--lcars-butterscotch);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .action-detail-panel h3 {
            color: var(--lcars-butterscotch);
            margin-bottom: 15px;
        }

        /* Fire panel specific */
        #fire-panel { border-color: var(--lcars-tomato); }
        #fire-panel h3 { color: var(--lcars-tomato); }

        /* Defensive Fire panel */
        #defensive-fire-panel { border-color: var(--lcars-african-violet); }
        #defensive-fire-panel h3 { color: var(--lcars-african-violet); }

        /* Damage Control panel */
        #damage-control-panel { border-color: var(--lcars-success); }
        #damage-control-panel h3 { color: var(--lcars-success); }

        /* Ram panel */
        #ram-panel { border-color: var(--lcars-orange); }
        #ram-panel h3 { color: var(--lcars-orange); }

        /* Reroute Power panel */
        #reroute-power-panel { border-color: var(--lcars-orange); }
        #reroute-power-panel h3 { color: var(--lcars-orange); }

        /* Thrusters panel */
        #thrusters-panel { border-color: var(--lcars-bluey); }
        #thrusters-panel h3 { color: var(--lcars-bluey); }

        /* Dice panel */
        #dice-panel { border-color: var(--lcars-ice); }
        #dice-panel h3 { color: var(--lcars-ice); }

        /* Selection summary */
        #selection-summary { border-color: var(--lcars-bluey); }

        /* Incoming attack panel */
        #incoming-attack-panel {
            border-color: var(--lcars-tomato);
            background: #2a1a1a;
        }

        /* Button styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-family: var(--font-primary);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            transition: filter 0.1s;
        }

        .btn:hover {
            filter: brightness(115%);
        }

        .btn-primary {
            background: var(--lcars-butterscotch);
            color: var(--lcars-text-dark);
        }

        .btn-danger {
            background: var(--lcars-tomato);
            color: var(--lcars-text-dark);
        }

        .btn-success {
            background: var(--lcars-success);
            color: var(--lcars-text-dark);
        }

        .btn-secondary {
            background: var(--lcars-gray);
            color: var(--lcars-text);
        }

        /* Forms */
        select, input[type="number"] {
            padding: 8px 12px;
            border: 2px solid var(--lcars-gray);
            border-radius: 5px;
            background: #1a1a1a;
            color: var(--lcars-text);
            font-family: var(--font-primary);
            font-size: 1rem;
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--lcars-ice);
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--lcars-almond);
            font-size: 0.9rem;
        }

        /* Weapons list */
        .weapons-list {
            margin-top: 10px;
        }

        .weapon-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: #1a1a1a;
            border-radius: 5px;
            margin: 5px 0;
        }

        .weapon-name {
            color: var(--lcars-text);
        }

        .weapon-stats {
            color: var(--lcars-almond);
            font-size: 0.9em;
        }

        /* Breach indicator */
        .breach-indicator {
            color: var(--lcars-tomato);
            font-size: 0.8em;
            margin-left: 5px;
        }

        .breach-warning {
            color: var(--lcars-tomato);
            font-weight: bold;
        }

        /* Enemy ships list (read-only) */
        .enemy-ship-item {
            padding: 10px;
            background: #1a1a1a;
            border-radius: 5px;
            margin: 8px 0;
            border-left: 3px solid var(--lcars-tomato);
        }

        .enemy-ship-item strong {
            color: var(--lcars-tomato);
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            color: var(--lcars-text-dark);
            font-weight: 700;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        .toast.success { background: var(--lcars-success); }
        .toast.error { background: var(--lcars-tomato); }
        .toast.info { background: var(--lcars-ice); }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Multiplayer status badges */
        .player-status-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.85em;
        }

        .players-status {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        /* Fire results styling */
        .fire-action {
            border-left: 3px solid var(--lcars-tomato) !important;
        }

        .fire-action-highlighted {
            background: rgba(255, 100, 100, 0.2) !important;
            border: 2px solid var(--lcars-tomato) !important;
            animation: pulse-fire 1.5s ease-in-out infinite;
        }

        @keyframes pulse-fire {
            0%, 100% { box-shadow: 0 0 5px var(--lcars-tomato); }
            50% { box-shadow: 0 0 15px var(--lcars-tomato); }
        }

        /* Damage report */
        .damage-report {
            padding: 15px;
            background: #222;
            border-radius: 5px;
            margin-top: 10px;
        }

        .damage-report h4 {
            color: var(--lcars-tomato);
            margin-bottom: 10px;
        }

        /* Info boxes */
        .info-box {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .info-box.warning {
            background: rgba(255, 153, 0, 0.15);
            border: 1px solid var(--lcars-orange);
            color: var(--lcars-orange);
        }

        .info-box.danger {
            background: rgba(255, 102, 102, 0.15);
            border: 1px solid var(--lcars-tomato);
            color: var(--lcars-tomato);
        }

        .info-box.success {
            background: rgba(153, 204, 153, 0.15);
            border: 1px solid var(--lcars-success);
            color: var(--lcars-success);
        }

        .info-box.info {
            background: rgba(153, 204, 255, 0.15);
            border: 1px solid var(--lcars-ice);
            color: var(--lcars-ice);
        }

        /* Legend styles */
        .legend {
            padding: 10px;
            background: #111;
            border-radius: 5px;
            font-size: 0.85em;
            margin-top: 10px;
        }

        .legend span {
            margin-right: 15px;
        }

        /* Dice result styling */
        .dice-result {
            display: inline-block;
            min-width: 40px;
            padding: 8px;
            margin: 3px;
            text-align: center;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1.1em;
            background: #333;
            border: 2px solid #555;
        }

        .dice-crit {
            background: #1a3a1a;
            border-color: var(--lcars-success);
            color: var(--lcars-success);
        }

        .dice-success {
            background: #1a2a3a;
            border-color: var(--lcars-ice);
            color: var(--lcars-ice);
        }

        .dice-fail {
            background: #2a2a2a;
            border-color: #666;
            color: #888;
        }

        .dice-complication {
            background: #3a1a1a;
            border-color: var(--lcars-tomato);
            color: var(--lcars-tomato);
        }

        /* LCARS Data Cascade Styling */
        .lcars-data-fill {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 8px;
            background: #0a0a0a;
            border: 1px solid var(--lcars-gray);
            border-radius: 0 0 0 20px;
            overflow: hidden;
            min-height: 60px;
        }

        .lcars-data-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.65rem;
            font-family: monospace;
            opacity: 0.5;
        }

        .lcars-data-row span {
            min-width: 30px;
            text-align: right;
        }

        .lcars-data-row.highlight {
            opacity: 0.9;
        }

        @keyframes dataPulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.7; }
        }

        .lcars-data-fill.animated .lcars-data-row {
            animation: dataPulse 4s ease-in-out infinite;
        }

        .lcars-data-fill.animated .lcars-data-row:nth-child(odd) {
            animation-delay: 0.7s;
        }

        .lcars-data-fill.animated .lcars-data-row:nth-child(3n) {
            animation-delay: 1.4s;
        }
    </style>
</head>
<body>
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <div class="player-wrapper">
        <!-- Left Navigation -->
        <nav class="player-left-nav">
            <div class="player-nav-top">
                <span>PLAYER</span>
            </div>

            <div class="player-nav-tabs">
                <button class="player-nav-tab tab-actions active" onclick="showTab('actions')">ACTIONS</button>
                <button class="player-nav-tab tab-map" onclick="showTab('map')">MAP</button>
                <button class="player-nav-tab tab-character" onclick="showTab('character')">CHARACTER</button>
                <button class="player-nav-tab tab-ship" onclick="showTab('ship')">SHIP</button>
            </div>

            <!-- LCARS Data Cascade -->
            <div class="lcars-data-fill animated" id="nav-data-cascade">
                <!-- Data rows will be generated by JavaScript -->
            </div>

            <div class="player-nav-bottom"></div>
        </nav>

        <!-- Main Content -->
        <main class="player-main">
            <!-- Header -->
            <header class="player-header">
                <div class="player-header-bar">
                    <span class="player-header-title">{{ encounter.name }}</span>
                    <span class="player-header-round" id="round-display">Round {{ encounter.round }}</span>
                </div>
                <div class="player-header-cap">
                    {% if campaign %}
                    <a href="{{ url_for('campaigns.campaign_dashboard', campaign_id=campaign.campaign_id) }}"
                       style="color: var(--lcars-text-dark); text-decoration: none; font-size: 0.8rem;">
                        BACK
                    </a>
                    {% endif %}
                </div>
            </header>

            <!-- Tab Content -->
            <div class="player-content">
                <!-- ============================================
                     ACTIONS TAB (Primary)
                     ============================================ -->
                <div id="tab-actions" class="tab-panel active">
                    <!-- Player Info Header -->
                    <div class="player-info-header" style="padding: 15px; background: linear-gradient(135deg, #1a1a1a, #222); border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--lcars-tomato);">
                        {% if player_char %}
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <div>
                                <h2 style="margin: 0; color: var(--lcars-text); font-size: 1.4em;">{{ player_char.name }}</h2>
                                <span style="color: var(--lcars-almond); font-size: 0.95em;">{{ player_char.rank }} &bull; {{ position.value.title() }}</span>
                            </div>
                            <div style="text-align: right;">
                                <span style="color: var(--lcars-ice); font-size: 0.9em;">Stress</span>
                                <span style="color: var(--lcars-text); font-weight: bold; margin-left: 5px;">{{ player_char.stress }} / {{ player_char.stress_max }}</span>
                            </div>
                        </div>
                        {% else %}
                        <div style="color: var(--lcars-almond);">No character assigned</div>
                        {% endif %}
                    </div>

                    <!-- Station-Specific Info Panel -->
                    <div class="station-info-panel" style="padding: 12px; background: #1a1a1a; border-radius: 8px; margin-bottom: 15px;">
                        {% if position.value == 'tactical' %}
                        <!-- TACTICAL STATION -->
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-start;">
                            <div style="flex: 1; min-width: 200px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-tomato); font-size: 0.9em;">WEAPONS STATUS</h4>
                                <div id="station-weapons-status" style="font-size: 1.1em; font-weight: bold; color: var(--lcars-{% if player_ship.weapons_armed %}success{% else %}tomato{% endif %});">
                                    {{ 'ARMED' if player_ship.weapons_armed else 'STANDBY' }}
                                </div>
                                {% set weapons_breach = player_ship.breaches | selectattr('system_name', 'equalto', 'weapons') | list %}
                                {% if weapons_breach %}
                                <div style="color: var(--lcars-tomato); font-size: 0.85em; margin-top: 4px;">
                                    ‚ö† {{ weapons_breach | length }} BREACH{% if weapons_breach | length > 1 %}ES{% endif %}
                                </div>
                                {% endif %}
                            </div>
                            <div style="flex: 2; min-width: 250px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-tomato); font-size: 0.9em;">ARMAMENTS</h4>
                                {% for weapon in player_ship.weapons %}
                                <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: #222; border-radius: 4px; margin-bottom: 4px; font-size: 0.9em;">
                                    <span style="color: var(--lcars-text);">{{ weapon.name }}</span>
                                    <span style="color: var(--lcars-almond);">{{ weapon.damage }}{% if player_ship.weapons_damage_bonus() > 0 %}+{{ player_ship.weapons_damage_bonus() }}{% endif %}‚ö° &bull; {{ weapon.range.value.title() }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            {% set has_defensive_fire = active_effects | selectattr('source_action', 'equalto', 'Defensive Fire') | list %}
                            {% if has_defensive_fire %}
                            <div style="flex: 1; min-width: 150px;">
                                <div style="padding: 8px; background: rgba(170, 102, 204, 0.2); border: 1px solid var(--lcars-african-violet); border-radius: 4px; text-align: center;">
                                    <span style="color: var(--lcars-african-violet); font-weight: bold;">üõ°Ô∏è DEFENSIVE FIRE ACTIVE</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        {% elif position.value == 'helm' %}
                        <!-- HELM STATION -->
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-start;">
                            <div style="flex: 1; min-width: 150px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-bluey); font-size: 0.9em;">ENGINES</h4>
                                <div style="font-size: 1.1em; color: var(--lcars-text);">{{ player_ship.systems.engines }}</div>
                                {% set engines_breach = player_ship.breaches | selectattr('system_name', 'equalto', 'engines') | list %}
                                {% if engines_breach %}
                                <div style="color: var(--lcars-tomato); font-size: 0.85em; margin-top: 4px;">
                                    ‚ö† {{ engines_breach | length }} BREACH{% if engines_breach | length > 1 %}ES{% endif %}
                                </div>
                                {% endif %}
                            </div>
                            <div style="flex: 1; min-width: 150px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-bluey); font-size: 0.9em;">CONN DEPT</h4>
                                <div style="font-size: 1.1em; color: var(--lcars-text);">{{ player_ship.departments.conn }}</div>
                            </div>
                            {% set has_evasive = active_effects | selectattr('source_action', 'equalto', 'Evasive Action') | list %}
                            {% set has_attack_pattern = active_effects | selectattr('source_action', 'equalto', 'Attack Pattern') | list %}
                            {% if has_evasive or has_attack_pattern %}
                            <div style="flex: 2; min-width: 200px;">
                                {% if has_evasive %}
                                <div style="padding: 6px 10px; background: rgba(153, 204, 255, 0.15); border: 1px solid var(--lcars-ice); border-radius: 4px; margin-bottom: 6px;">
                                    <span style="color: var(--lcars-ice); font-weight: bold;">EVASIVE MANEUVERS ACTIVE</span>
                                </div>
                                {% endif %}
                                {% if has_attack_pattern %}
                                <div style="padding: 6px 10px; background: rgba(255, 153, 0, 0.15); border: 1px solid var(--lcars-orange); border-radius: 4px;">
                                    <span style="color: var(--lcars-orange); font-weight: bold;">ATTACK PATTERN ACTIVE</span>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        {% elif position.value == 'engineering' %}
                        <!-- ENGINEERING STATION -->
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-start;">
                            <div style="flex: 1; min-width: 150px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-butterscotch); font-size: 0.9em;">RESERVE POWER</h4>
                                <div style="font-size: 1.1em; font-weight: bold; color: var(--lcars-{% if player_ship.has_reserve_power %}success{% else %}tomato{% endif %});">
                                    {{ 'AVAILABLE' if player_ship.has_reserve_power else 'DEPLETED' }}
                                </div>
                            </div>
                            <div style="flex: 2; min-width: 250px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-butterscotch); font-size: 0.9em;">DAMAGE REPORT</h4>
                                {% set total_breaches = player_ship.breaches | length %}
                                {% if total_breaches > 0 %}
                                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                    {% for breach in player_ship.breaches %}
                                    <span style="padding: 3px 8px; background: rgba(255, 102, 102, 0.2); border: 1px solid var(--lcars-tomato); border-radius: 4px; font-size: 0.85em; color: var(--lcars-tomato);">
                                        {{ breach.system_name | upper }}
                                    </span>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div style="color: var(--lcars-success);">All systems nominal</div>
                                {% endif %}
                            </div>
                        </div>

                        {% elif position.value == 'science' %}
                        <!-- SCIENCE STATION -->
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-start;">
                            <div style="flex: 1; min-width: 150px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-african-violet); font-size: 0.9em;">SENSORS</h4>
                                <div style="font-size: 1.1em; color: var(--lcars-text);">{{ player_ship.systems.sensors }}</div>
                                {% set sensors_breach = player_ship.breaches | selectattr('system_name', 'equalto', 'sensors') | list %}
                                {% if sensors_breach %}
                                <div style="color: var(--lcars-tomato); font-size: 0.85em; margin-top: 4px;">
                                    ‚ö† {{ sensors_breach | length }} BREACH{% if sensors_breach | length > 1 %}ES{% endif %}
                                </div>
                                {% endif %}
                            </div>
                            <div style="flex: 1; min-width: 150px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-african-violet); font-size: 0.9em;">SCIENCE DEPT</h4>
                                <div style="font-size: 1.1em; color: var(--lcars-text);">{{ player_ship.departments.science }}</div>
                            </div>
                            {% set has_sensor_sweep = active_effects | selectattr('source_action', 'equalto', 'Sensor Sweep') | list %}
                            {% if has_sensor_sweep %}
                            <div style="flex: 1; min-width: 150px;">
                                <div style="padding: 8px; background: rgba(170, 102, 204, 0.15); border: 1px solid var(--lcars-african-violet); border-radius: 4px; text-align: center;">
                                    <span style="color: var(--lcars-african-violet); font-weight: bold;">SENSOR SWEEP ACTIVE</span>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        {% elif position.value == 'operations' %}
                        <!-- OPERATIONS STATION -->
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-start;">
                            <div style="flex: 1; min-width: 150px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-ice); font-size: 0.9em;">SHIELDS</h4>
                                <div style="font-size: 1.1em; font-weight: bold; color: var(--lcars-{% if player_ship.shields_raised %}success{% else %}tomato{% endif %});">
                                    {{ 'ONLINE' if player_ship.shields_raised else 'OFFLINE' }}
                                </div>
                                <div style="color: var(--lcars-almond); font-size: 0.9em;">{{ player_ship.shields if player_ship.shields_raised else 0 }} / {{ player_ship.shields_max }}</div>
                            </div>
                            <div style="flex: 1; min-width: 150px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-ice); font-size: 0.9em;">COMMS</h4>
                                <div style="font-size: 1.1em; color: var(--lcars-text);">{{ player_ship.systems.comms }}</div>
                                {% set comms_breach = player_ship.breaches | selectattr('system_name', 'equalto', 'comms') | list %}
                                {% if comms_breach %}
                                <div style="color: var(--lcars-tomato); font-size: 0.85em; margin-top: 4px;">
                                    ‚ö† BREACH
                                </div>
                                {% endif %}
                            </div>
                            <div style="flex: 1; min-width: 150px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-ice); font-size: 0.9em;">COMPUTERS</h4>
                                <div style="font-size: 1.1em; color: var(--lcars-text);">{{ player_ship.systems.computers }}</div>
                            </div>
                        </div>

                        {% elif position.value == 'captain' %}
                        <!-- CAPTAIN/COMMAND STATION -->
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-start;">
                            <div style="flex: 1; min-width: 120px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-butterscotch); font-size: 0.9em;">MOMENTUM</h4>
                                <div style="font-size: 1.3em; font-weight: bold; color: var(--lcars-success);">{{ encounter.momentum }} / 6</div>
                            </div>
                            <div style="flex: 1; min-width: 120px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-butterscotch); font-size: 0.9em;">THREAT</h4>
                                <div style="font-size: 1.3em; font-weight: bold; color: var(--lcars-tomato);">{{ encounter.threat }}</div>
                            </div>
                            <div style="flex: 2; min-width: 200px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-butterscotch); font-size: 0.9em;">SHIP STATUS</h4>
                                {% set total_breaches = player_ship.breaches | length %}
                                <div style="color: var(--lcars-{% if total_breaches == 0 %}success{% elif total_breaches < 3 %}orange{% else %}tomato{% endif %});">
                                    {% if total_breaches == 0 %}All systems operational
                                    {% else %}{{ total_breaches }} system breach{% if total_breaches > 1 %}es{% endif %}{% endif %}
                                </div>
                            </div>
                        </div>

                        {% elif position.value == 'medical' %}
                        <!-- MEDICAL STATION -->
                        <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-start;">
                            <div style="flex: 1; min-width: 150px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-success); font-size: 0.9em;">MEDICINE DEPT</h4>
                                <div style="font-size: 1.1em; color: var(--lcars-text);">{{ player_ship.departments.medicine }}</div>
                            </div>
                            <div style="flex: 2; min-width: 200px;">
                                <h4 style="margin: 0 0 8px 0; color: var(--lcars-success); font-size: 0.9em;">CREW STATUS</h4>
                                {% set structure_breach = player_ship.breaches | selectattr('system_name', 'equalto', 'structure') | list %}
                                {% if structure_breach %}
                                <div style="color: var(--lcars-tomato);">‚ö† Hull breaches detected - possible casualties</div>
                                {% else %}
                                <div style="color: var(--lcars-success);">No reported casualties</div>
                                {% endif %}
                            </div>
                        </div>

                        {% else %}
                        <!-- DEFAULT / UNASSIGNED -->
                        <div style="color: var(--lcars-almond); font-size: 0.9em;">
                            Station information will appear here based on your assigned position.
                        </div>
                        {% endif %}
                    </div>

                    <!-- Turn & Resources Panel -->
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid #333; border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                        <!-- Top row: Resources + Reserve Power -->
                        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 10px; flex-wrap: wrap;">
                            <div class="resource-box momentum" style="margin: 0; padding: 8px 12px;">
                                <span class="resource-label" style="font-size: 0.7em;">MOMENTUM</span>
                                <span class="resource-value" id="momentum" style="font-size: 1.4em;">{{ encounter.momentum }}</span>
                                <span style="color: #666; font-size: 0.8em;">/6</span>
                            </div>
                            <div class="resource-box threat" style="margin: 0; padding: 8px 12px;">
                                <span class="resource-label" style="font-size: 0.7em;">THREAT</span>
                                <span class="resource-value" id="threat" style="font-size: 1.4em;">{{ encounter.threat }}</span>
                            </div>
                            <div id="reserve-power-box" style="padding: 8px 12px; background: {{ '#1a3a1a' if player_ship.has_reserve_power else '#3a1a1a' }}; border: 2px solid {{ 'var(--lcars-success)' if player_ship.has_reserve_power else 'var(--lcars-tomato)' }}; border-radius: 5px;">
                                <span style="color: {{ 'var(--lcars-success)' if player_ship.has_reserve_power else 'var(--lcars-tomato)' }}; font-size: 0.7em; display: block;">RESERVE POWER</span>
                                <span id="reserve-power-status" style="color: {{ 'var(--lcars-success)' if player_ship.has_reserve_power else 'var(--lcars-tomato)' }}; font-weight: bold; font-size: 1.1em;">{{ 'AVAILABLE' if player_ship.has_reserve_power else 'DEPLETED' }}</span>
                            </div>
                        </div>

                        <!-- Turn indicator row -->
                        <div id="turn-banner" class="turn-banner {% if encounter.current_turn == 'player' %}{% if is_multiplayer and encounter.current_player_id != my_player_id %}waiting-turn{% else %}your-turn{% endif %}{% else %}enemy-turn{% endif %}" style="margin: 0; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; gap: 15px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 15px; flex-direction: column; align-items: flex-start;">
                                <div id="turn-text" style="font-size: 1.1em; font-weight: bold;">
                                    {% if encounter.current_turn != 'player' %}
                                    ENEMY TURN
                                    {% elif is_multiplayer %}
                                        {% if encounter.current_player_id == my_player_id %}
                                        YOUR TURN
                                        {% elif encounter.current_player_id %}
                                        {{ current_player_name }}'S TURN
                                        {% else %}
                                        CREW TURN
                                        {% endif %}
                                    {% else %}
                                    YOUR TURN
                                    {% endif %}
                                </div>
                                <div id="turn-instruction" class="turn-instruction">
                                    {% if encounter.current_turn != 'player' %}
                                    The Game Master is controlling enemy ships. Stand by...
                                    {% elif is_multiplayer %}
                                        {% if encounter.current_player_id == my_player_id %}
                                        Select a minor action (optional) then a major action to complete your turn.
                                        {% elif encounter.current_player_id %}
                                        Waiting for {{ current_player_name }} to complete their action...
                                        {% else %}
                                        It's the crew's turn! Press CLAIM to take your action.
                                        {% endif %}
                                    {% else %}
                                    Select a minor action (optional) then a major action to complete your turn.
                                    {% endif %}
                                </div>
                            </div>

                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div class="turn-counter" style="font-size: 0.9em; color: var(--lcars-almond); text-align: center;">
                                    <div style="font-size: 0.7em; text-transform: uppercase; letter-spacing: 1px;">Actions</div>
                                    {% if is_multiplayer %}
                                    <span id="player-turns-used">0</span> / <span id="player-turns-total">{{ campaign_players | length }}</span>
                                    {% else %}
                                    <span id="player-turns-used">0</span> / <span id="player-turns-total">0</span>
                                    {% endif %}
                                </div>
                                <!-- Enemy turns hidden -->
                                <span style="display: none;"><span id="enemy-turns-used">0</span>/<span id="enemy-turns-total">0</span></span>

                                {% if is_multiplayer %}
                                <div id="claim-turn-section" style="{% if encounter.current_turn != 'player' or encounter.current_player_id %}display: none;{% endif %}">
                                    <button class="claim-turn-btn" onclick="claimTurn()">CLAIM</button>
                                </div>
                                <div id="release-turn-section" style="{% if encounter.current_player_id != my_player_id %}display: none;{% endif %}">
                                    <button class="btn btn-secondary" onclick="releaseTurn()" style="padding: 5px 12px; font-size: 0.85em;">RELEASE</button>
                                </div>
                                <div id="already-acted-section" style="display: none;">
                                    <span style="color: var(--lcars-success); font-size: 0.9em; font-weight: bold;">ACTION COMPLETE</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        {% if is_multiplayer %}
                        <!-- Player status badges -->
                        <div class="players-status" id="players-status" style="margin-top: 10px; display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;">
                            {% for player in campaign_players %}
                            <span class="player-status-badge" data-player-id="{{ player.id }}"
                                  style="background: {% if player.has_acted %}var(--lcars-success){% elif player.is_current %}var(--lcars-african-violet){% else %}#444{% endif %};
                                         color: {% if player.has_acted or player.is_current %}#000{% else %}#ccc{% endif %}; font-size: 0.8em; padding: 3px 8px; border-radius: 3px;">
                                {{ player.name }}{% if player.is_current %} (acting){% elif player.has_acted %} ‚úì{% endif %}
                            </span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                    <!-- Message shown when player needs to claim turn (multiplayer only) -->
                    <div id="claim-turn-message" style="{% if not is_multiplayer or encounter.current_turn != 'player' or encounter.current_player_id == my_player_id %}display: none;{% endif %} padding: 40px 20px; text-align: center; background: #1a1a1a; border-radius: 8px; margin-bottom: 15px;">
                        <div id="claim-turn-message-text" style="color: var(--lcars-almond); font-size: 1.2em; margin-bottom: 15px;">
                            {% if encounter.current_player_id %}
                            <strong>{{ current_player_name }}</strong> is currently taking their turn.
                            {% else %}
                            It's the player turn! Claim your turn above to take an action.
                            {% endif %}
                        </div>
                        <div style="color: #888; font-size: 0.9em;">
                            Actions will be available once you claim your turn.
                        </div>
                    </div>

                    <!-- Actions Container (only visible when player has claimed turn in multiplayer, or always in single-player) -->
                    <div id="actions-container" style="{% if encounter.current_turn != 'player' or (is_multiplayer and encounter.current_player_id != my_player_id) %}display: none;{% endif %}">

                        <!-- Actions Grid -->
                        <div class="actions-grid">
                            <!-- Minor Actions -->
                            <div class="action-panel minor">
                                <h3>Minor Actions</h3>

                                {# Macro for rendering action cost badges #}
                                {% macro action_cost_badges(action) %}
                                <div class="action-cost-badges">
                                    {% if action.difficulty > 0 %}
                                    <span class="action-cost-badge difficulty">Diff {{ action.difficulty }}</span>
                                    {% elif action.difficulty == 0 and action.attribute %}
                                    <span class="action-cost-badge difficulty">Diff 0</span>
                                    {% else %}
                                    <span class="action-cost-badge no-roll">No Roll</span>
                                    {% endif %}
                                    {% if action.momentum_cost > 0 %}
                                    <span class="action-cost-badge momentum">{{ action.momentum_cost }} Momentum</span>
                                    {% endif %}
                                    {% if action.threat_cost > 0 %}
                                    <span class="action-cost-badge threat">{{ action.threat_cost }} Threat</span>
                                    {% endif %}
                                    {% if action.requires_reserve_power %}
                                    <span class="action-cost-badge reserve-power">Reserve Power</span>
                                    {% endif %}
                                </div>
                                {% endmacro %}

                                {% if actions.position_minor %}
                                <h4 class="section-header" style="color: var(--lcars-orange);">{{ actions.position_name }} Specific</h4>
                                <ul class="action-list">
                                    {% for action in actions.position_minor %}
                                    {% if action.name == 'Raise/Lower Shields' %}
                                    <li id="shields-action-btn" onclick="toggleShields()" data-action-name="Raise Shields">
                                        <strong>{{ 'Lower Shields' if player_ship.shields_raised else 'Raise Shields' }}</strong>
                                        <span class="breach-warning" style="display: none;"></span>
                                        <div class="action-type">{{ action.description }}</div>
                                        <div class="action-cost-badges">
                                            <span class="action-cost-badge no-roll">No Roll</span>
                                        </div>
                                    </li>
                                    {% elif action.name == 'Arm/Disarm Weapons' %}
                                    <li id="weapons-action-btn" onclick="toggleWeapons()" data-action-name="Arm Weapons">
                                        <strong>{{ 'Disarm Weapons' if player_ship.weapons_armed else 'Arm Weapons' }}</strong>
                                        <span class="breach-warning" style="display: none;"></span>
                                        <div class="action-type">{{ action.description }}</div>
                                        <div class="action-cost-badges">
                                            <span class="action-cost-badge no-roll">No Roll</span>
                                        </div>
                                    </li>
                                    {% else %}
                                    <li onclick="selectAction('{{ action.name }}', 'minor', {{ action.difficulty }})"
                                        data-action-name="{{ action.name }}"
                                        class="{% if action.status == 'NOT_IMPL' %}action-not-impl{% endif %}">
                                        <strong>{{ action.name }}</strong>
                                        <span class="breach-warning" style="display: none;"></span>
                                        <div class="action-type">{{ action.description }}</div>
                                        {{ action_cost_badges(action) }}
                                    </li>
                                    {% endif %}
                                    {% endfor %}
                                </ul>
                                {% endif %}

                                <h4 class="section-header">Standard</h4>
                                <ul class="action-list">
                                    {% for action in actions.standard_minor %}
                                    <li onclick="selectAction('{{ action.name }}', 'minor', {{ action.difficulty }})"
                                        data-action-name="{{ action.name }}"
                                        class="{% if action.status == 'NOT_IMPL' %}action-not-impl{% endif %}">
                                        <strong>{{ action.name }}</strong>
                                        <span class="breach-warning" style="display: none;"></span>
                                        <div class="action-type">{{ action.description }}</div>
                                        {{ action_cost_badges(action) }}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>

                            <!-- Major Actions -->
                            <div class="action-panel major">
                                <h3>Major Actions</h3>

                                {% if actions.position_major %}
                                <h4 class="section-header" style="color: var(--lcars-orange);">{{ actions.position_name }} Specific</h4>
                                <ul class="action-list">
                                    {% for action in actions.position_major %}
                                    <li onclick="selectAction('{{ action.name }}', 'major', {{ action.difficulty }})"
                                        data-action-name="{{ action.name }}"
                                        data-base-difficulty="{{ action.difficulty }}"
                                        class="{% if action.name == 'Fire' %}fire-action{% endif %} {% if action.status == 'NOT_IMPL' %}action-not-impl{% endif %}">
                                        <strong>{{ action.name }}</strong>
                                        <span class="breach-warning" style="display: none;"></span>
                                        <div class="action-type">{{ action.description }}</div>
                                        {{ action_cost_badges(action) }}
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% endif %}

                                <h4 class="section-header">Standard</h4>
                                <ul class="action-list">
                                    {% for action in actions.standard_major %}
                                    <li onclick="selectAction('{{ action.name }}', 'major', {{ action.difficulty }})"
                                        data-action-name="{{ action.name }}"
                                        data-base-difficulty="{{ action.difficulty }}"
                                        class="{% if action.name == 'Fire' %}fire-action{% endif %} {% if action.status == 'NOT_IMPL' %}action-not-impl{% endif %}">
                                        <strong>{{ action.name }}</strong>
                                        <span class="breach-warning" style="display: none;"></span>
                                        <div class="action-type">{{ action.description }}</div>
                                        {{ action_cost_badges(action) }}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Turn Summary (persists after turn ends) -->
                    <div id="last-action-results" style="display: none; padding: 15px; background: #1a1a1a; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--lcars-success);">
                        <h4 style="margin: 0 0 10px 0; color: var(--lcars-almond);">YOUR TURN SUMMARY</h4>
                        <div id="last-action-content"></div>
                    </div>

                    <!-- Enemy Turn Message -->
                    <div id="actions-enemy-turn-msg" style="{% if encounter.current_turn == 'player' %}display: none;{% endif %} padding: 30px; text-align: center;">
                        <h3 style="color: var(--lcars-tomato);">ENEMY TURN</h3>
                        <p style="color: var(--lcars-almond);">Actions are not available during the enemy turn. Open the View Screen to monitor the battle.</p>
                    </div>

                    <!-- Selected Actions Summary -->
                    <div class="action-detail-panel" id="selection-summary" style="display: none;">
                        <h3 style="color: var(--lcars-bluey);">SELECTED ACTIONS</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <strong style="color: var(--lcars-almond);">Minor Action:</strong>
                                <div id="summary-minor" style="padding: 8px; background: #222; border-radius: 5px; margin-top: 5px;">
                                    <span style="color: #666;">None selected</span>
                                </div>
                            </div>
                            <div>
                                <strong style="color: var(--lcars-almond);">Major Action:</strong>
                                <div id="summary-major" style="padding: 8px; background: #222; border-radius: 5px; margin-top: 5px;">
                                    <span style="color: #666;">None selected</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fire Action Panel -->
                    <div class="action-detail-panel" id="fire-panel" style="display: none;">
                        <h3 style="color: var(--lcars-tomato);">FIRE WEAPONS</h3>

                        <!-- Active Minor Action Banner -->
                        <div id="fire-minor-action-banner" class="info-box info" style="display: none;">
                            <strong>MINOR ACTION ACTIVE:</strong>
                            <span id="fire-minor-action-name"></span>
                            <div id="fire-minor-action-effects" style="font-size: 0.9em; margin-top: 5px;"></div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label for="weapon-select">Select Weapon</label>
                                <select id="weapon-select" style="width: 100%;">
                                    {% for weapon in player_ship.weapons %}
                                    <option value="{{ loop.index0 }}"
                                            data-damage="{{ weapon.damage }}"
                                            data-type="{{ weapon.weapon_type.value }}"
                                            data-range="{{ weapon.range.value }}">
                                        {{ weapon.name }} (Dmg {{ weapon.damage }}+{{ player_ship.weapons_damage_bonus() }}, {{ weapon.range.value.title() }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label for="target-select">Select Target</label>
                                <select id="target-select" style="width: 100%;"></select>
                                <div id="target-range-info" style="font-size: 0.85em; color: var(--lcars-almond); margin-top: 5px;"></div>
                            </div>
                        </div>

                        <!-- Targeting Solution Info -->
                        <div id="targeting-solution-panel" class="info-box success" style="display: none;">
                            <strong>TARGETING SOLUTION ACTIVE</strong>
                            <div style="margin-top: 8px; font-size: 0.9em;">
                                After rolling, you may choose ONE benefit:
                                <ul style="margin: 5px 0 0 20px;">
                                    <li><strong>Re-roll 1d20</strong> - Click on any die to re-roll it</li>
                                    <li><strong>Choose System</strong> - If you cause a breach, pick which system is hit</li>
                                </ul>
                            </div>
                        </div>

                        <div style="padding: 10px; background: #222; border-radius: 5px;">
                            <strong>Attack Details:</strong>
                            <div id="attack-details">
                                <p><strong>Character Roll (2d20):</strong> Control ({{ player_char.attributes.control if player_char else 9 }}) + Security ({{ player_char.disciplines.security if player_char else 3 }}) = Target {{ (player_char.attributes.control + player_char.disciplines.security) if player_char else 12 }}</p>
                                <p><strong>Ship Assist (1d20):</strong> Weapons ({{ player_ship.systems.weapons if player_ship else 7 }}) + Security ({{ player_ship.departments.security if player_ship else 2 }}) = Target {{ (player_ship.systems.weapons + player_ship.departments.security) if player_ship else 9 }}</p>
                                <p>Difficulty: <span id="fire-difficulty">2</span> <span id="fire-difficulty-breakdown"></span></p>
                                <p>Total Damage: <span id="fire-damage">{{ player_ship.weapons[0].damage + player_ship.weapons_damage_bonus() if player_ship.weapons else 0 }}</span></p>
                            </div>
                            <div id="fire-range-warning" class="info-box danger" style="display: none;"></div>
                        </div>

                        <div style="margin-top: 15px;">
                            <label><input type="checkbox" id="fire-focus"> Focus Applies (Targeting Systems, etc.)</label>
                        </div>
                        <div id="fire-bonus-section" style="display: none; margin-top: 10px;">
                            <label for="fire-bonus">Bonus Dice (Cost: 1st=1, 2nd=2, 3rd=3 Momentum)</label>
                            <input type="number" id="fire-bonus" value="0" min="0" max="0" style="width: 80px;">
                        </div>

                        <div style="margin-top: 15px;">
                            <button class="btn btn-danger" onclick="executeFireAction()">FIRE!</button>
                            <button class="btn btn-secondary" onclick="cancelAction()">Cancel</button>
                        </div>

                        <div id="fire-results" style="margin-top: 15px; display: none;"></div>
                    </div>

                    <!-- Incoming Attack Panel -->
                    <div class="action-detail-panel" id="incoming-attack-panel" style="display: none; background: #2a1a1a;">
                        <h3 style="color: var(--lcars-tomato);">INCOMING ATTACK!</h3>

                        <div class="info-box danger">
                            <p style="margin: 0; font-size: 1.2em;">
                                <strong id="incoming-attacker">Enemy Ship</strong> is attacking with <strong id="incoming-weapon">Phasers</strong>!
                            </p>
                            <p style="margin: 10px 0 0 0;">
                                Your <strong>Defensive Fire</strong> is active. Make your opposed roll to defend!
                            </p>
                        </div>

                        <div style="padding: 10px; background: #222; border-radius: 5px; margin: 15px 0;">
                            <strong>Your Defensive Roll:</strong> Daring + Security (Target <span id="incoming-defender-target">12</span>)
                            <br>
                            <strong>Ship Assist:</strong> Weapons + Security (Target <span id="incoming-ship-target">9</span>)
                        </div>

                        <button class="btn" style="background: var(--lcars-african-violet);" onclick="rollDefensiveDice()">ROLL DEFENSIVE DICE</button>

                        <div id="incoming-roll-results" class="info-box info" style="display: none;">
                            <h4 style="color: var(--lcars-bluey); margin-top: 0;">Roll Results</h4>
                            <div id="incoming-roll-details"></div>
                            <button class="btn btn-success" onclick="submitDefensiveRoll()" style="margin-top: 15px;">SUBMIT ROLL</button>
                        </div>

                        <div id="incoming-attack-resolution" style="margin-top: 15px; display: none;"></div>
                    </div>

                    <!-- Defensive Fire Panel -->
                    <div class="action-detail-panel" id="defensive-fire-panel" style="display: none;">
                        <h3 style="color: var(--lcars-african-violet);">DEFENSIVE FIRE</h3>

                        <div class="info-box info">
                            <p style="margin: 0;">
                                Choose an <strong>energy weapon</strong> to use defensively. Until your next turn,
                                enemy attacks against this ship become <strong>opposed rolls</strong>.
                            </p>
                            <p style="margin: 10px 0 0 0; color: var(--lcars-orange);">
                                If you win the opposed roll, you may spend <strong>2 Momentum</strong> to counterattack with this weapon.
                            </p>
                        </div>

                        <div id="defensive-fire-momentum-warning" class="info-box warning" style="display: none;">
                            <strong>WARNING:</strong> You currently have <span id="df-current-momentum">0</span> Momentum.
                            If you activate Defensive Fire now, you won't have enough Momentum (2 required) to counterattack.
                        </div>

                        <div style="margin-top: 15px;">
                            <label for="defensive-fire-weapon-select">Select Energy Weapon</label>
                            <select id="defensive-fire-weapon-select" style="width: 100%;">
                                {% for weapon in player_ship.weapons %}
                                {% if weapon.weapon_type.value != 'torpedo' %}
                                <option value="{{ loop.index0 }}" data-damage="{{ weapon.damage }}">
                                    {{ weapon.name }} (Dmg {{ weapon.damage }}+{{ player_ship.weapons_damage_bonus() }}, {{ weapon.range.value.title() }})
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>

                        <div style="margin-top: 15px; padding: 10px; background: #222; border-radius: 5px;">
                            <strong>Opposed Roll Details:</strong>
                            <p><strong>Your Roll:</strong> Daring ({{ player_char.attributes.daring if player_char else 9 }}) + Security ({{ player_char.disciplines.security if player_char else 3 }}) = Target {{ (player_char.attributes.daring + player_char.disciplines.security) if player_char else 12 }}</p>
                            <p><strong>Ship Assist:</strong> Weapons ({{ player_ship.systems.weapons if player_ship else 7 }}) + Security ({{ player_ship.departments.security if player_ship else 2 }}) = Target {{ (player_ship.systems.weapons + player_ship.departments.security) if player_ship else 9 }}</p>
                        </div>

                        <div style="margin-top: 15px;">
                            <button class="btn" style="background: var(--lcars-african-violet);" onclick="executeDefensiveFire()">ACTIVATE DEFENSIVE FIRE</button>
                            <button class="btn btn-secondary" onclick="cancelAction()">Cancel</button>
                        </div>

                        <div id="defensive-fire-results" style="margin-top: 15px; display: none;"></div>
                    </div>

                    <!-- Thrusters Panel -->
                    <div class="action-detail-panel" id="thrusters-panel" style="display: none;">
                        <h3 style="color: var(--lcars-bluey);">THRUSTERS</h3>

                        <div class="info-box info">
                            <p style="margin: 0;">
                                Fine maneuvering within your current hex. Use thrusters to <strong>enter</strong> or <strong>exit Contact</strong> with other ships in the same location.
                            </p>
                            <p style="margin: 10px 0 0 0; font-size: 0.9em;">
                                Contact allows boarding actions, point-blank transporter use, and towing.
                            </p>
                        </div>

                        <div id="thrusters-actions-container">
                            <p style="color: var(--lcars-almond);">Loading available actions...</p>
                        </div>

                        <div id="thrusters-no-actions" style="display: none; padding: 15px; background: #2a2a2a; border-radius: 5px;">
                            <p style="margin: 0; color: var(--lcars-almond);">No ships in your current hex to dock with.</p>
                            <p style="margin: 10px 0 0 0; color: #888; font-size: 0.9em;">Use <strong>Impulse</strong> to move to a hex with another ship first.</p>
                        </div>

                        <button class="btn btn-secondary" onclick="cancelThrustersAction()" style="margin-top: 15px;">Cancel</button>

                        <div id="thrusters-results" style="margin-top: 15px; display: none;"></div>
                    </div>

                    <!-- Reroute Power Panel -->
                    <div class="action-detail-panel" id="reroute-power-panel" style="display: none;">
                        <h3 style="color: var(--lcars-orange);">REROUTE POWER</h3>

                        <div class="info-box warning">
                            <p style="margin: 0;">
                                Reroute power to a specific ship system. The <strong>next action</strong> using that system gets <strong>-1 Difficulty</strong>.
                            </p>
                            <p style="margin: 10px 0 0 0; color: var(--lcars-tomato);"><strong>Consumes Reserve Power!</strong></p>
                        </div>

                        <div id="reroute-no-power-warning" class="info-box danger" style="display: none;">
                            <strong>NO RESERVE POWER!</strong> You must use Regain Power first.
                        </div>

                        <div style="margin-top: 15px;">
                            <label for="reroute-system-select">Select Target System</label>
                            <select id="reroute-system-select" style="width: 100%;">
                                <option value="weapons">WEAPONS - Boost Fire, Defensive Fire</option>
                                <option value="sensors">SENSORS - Boost Scan, Sensor Sweep</option>
                                <option value="engines">ENGINES - Boost Maneuver, Impulse, Warp</option>
                                <option value="structure">STRUCTURE - Boost Regenerate Shields, Tractor Beam</option>
                                <option value="comms">COMMS - Boost Hail, Communications</option>
                                <option value="computers">COMPUTERS - Boost Computer-assisted tasks</option>
                            </select>
                        </div>

                        <div style="margin-top: 15px; padding: 10px; background: #222; border-radius: 5px;">
                            <strong>Effect:</strong> Next action using <span id="reroute-target-display">WEAPONS</span> gets <span style="color: var(--lcars-success);">-1 Difficulty</span>
                        </div>

                        <div style="margin-top: 15px;">
                            <button class="btn" style="background: var(--lcars-orange);" onclick="executeReroutePower()">REROUTE POWER</button>
                            <button class="btn btn-secondary" onclick="cancelAction()">Cancel</button>
                        </div>

                        <div id="reroute-power-results" style="margin-top: 15px; display: none;"></div>
                    </div>

                    <!-- Damage Control Panel -->
                    <div class="action-detail-panel" id="damage-control-panel" style="display: none;">
                        <h3 style="color: var(--lcars-success);">DAMAGE CONTROL</h3>

                        <div class="info-box success">
                            <p style="margin: 0;">
                                Direct repair teams to patch a breach. Select which system to repair, then roll to succeed.
                            </p>
                            <p style="margin: 10px 0 0 0; color: var(--lcars-orange);"><strong>Difficulty:</strong> 2 + Breach Potency on target system</p>
                        </div>

                        <div id="damage-control-no-breach-warning" class="info-box danger" style="display: none;">
                            <strong>NO BREACHES!</strong> There are no breaches to repair.
                        </div>

                        <div id="damage-control-system-section" style="margin-top: 15px;">
                            <label for="damage-control-system-select">Select System to Repair</label>
                            <select id="damage-control-system-select" style="width: 100%;" onchange="updateDamageControlDisplay()"></select>
                        </div>

                        <div style="margin-top: 15px; padding: 10px; background: #222; border-radius: 5px;">
                            <strong>Roll Details:</strong>
                            <p><strong>Character Roll (2d20):</strong> Presence ({{ player_char.attributes.presence if player_char else 9 }}) + Engineering ({{ player_char.disciplines.engineering if player_char else 3 }}) = Target {{ (player_char.attributes.presence + player_char.disciplines.engineering) if player_char else 12 }}</p>
                            <p>Base Difficulty: <strong>2</strong> + <span id="damage-control-breach-potency">0</span> (breach potency) = <strong id="damage-control-total-difficulty">2</strong></p>
                        </div>

                        <div style="margin-top: 15px;">
                            <label><input type="checkbox" id="damage-control-focus"> Focus Applies (Damage Control, etc.)</label>
                        </div>
                        <div id="damage-control-bonus-section" style="display: none; margin-top: 10px;">
                            <label for="damage-control-bonus">Bonus Dice (Cost: 1st=1, 2nd=2, 3rd=3 Momentum)</label>
                            <input type="number" id="damage-control-bonus" value="0" min="0" max="0" style="width: 80px;">
                        </div>

                        <div style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="executeDamageControlRoll()">ROLL DAMAGE CONTROL</button>
                            <button class="btn btn-secondary" onclick="cancelAction()">Cancel</button>
                        </div>

                        <div id="damage-control-results" style="margin-top: 15px; display: none;"></div>
                    </div>

                    <!-- Ram Action Panel -->
                    <div class="action-detail-panel" id="ram-panel" style="display: none;">
                        <h3 style="color: var(--lcars-orange);">RAM TARGET</h3>

                        <div class="info-box warning">
                            <strong>WARNING:</strong> Ramming deals collision damage to BOTH ships! Your ship will also take damage.
                        </div>

                        <div style="margin-top: 15px;">
                            <label for="ram-target-select">Select Target</label>
                            <select id="ram-target-select" style="width: 100%;">
                                {% for enemy in enemy_ships %}
                                <option value="{{ loop.index0 }}" data-scale="{{ enemy.scale }}">{{ enemy.name }} (Scale {{ enemy.scale }})</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div style="margin-top: 15px; padding: 10px; background: #222; border-radius: 5px;">
                            <strong>Ram Details:</strong>
                            <div id="ram-details">
                                <p><strong>Character Roll (2d20):</strong> Daring ({{ player_char.attributes.daring if player_char else 9 }}) + Conn ({{ player_char.disciplines.conn if player_char else 3 }}) = Target {{ (player_char.attributes.daring + player_char.disciplines.conn) if player_char else 12 }}</p>
                                <p><strong>Ship Assist (1d20):</strong> Engines ({{ player_ship.systems.engines if player_ship else 7 }}) + Conn ({{ player_ship.departments.conn if player_ship else 2 }}) = Target {{ (player_ship.systems.engines + player_ship.departments.conn) if player_ship else 9 }}</p>
                                <p>Difficulty: <strong>2</strong></p>
                                <p style="margin-top: 10px; color: var(--lcars-orange);"><strong>Your Collision Damage:</strong> <span id="ram-your-damage">{{ player_ship.scale if player_ship else 4 }}</span> (Scale {{ player_ship.scale if player_ship else 4 }})</p>
                                <p style="color: var(--lcars-tomato);"><strong>Damage You'll Take:</strong> <span id="ram-their-damage">{{ enemy_ships[0].scale if enemy_ships else 3 }}</span> (Target's Scale)</p>
                                <p style="font-size: 0.9em; color: var(--lcars-almond); margin-top: 10px;">* Collision damage has <strong>Piercing</strong> (ignores resistance)</p>
                            </div>
                        </div>

                        <div style="margin-top: 15px;">
                            <label><input type="checkbox" id="ram-focus"> Focus Applies (Precision Flying, etc.)</label>
                        </div>
                        <div id="ram-bonus-section" style="display: none; margin-top: 10px;">
                            <label for="ram-bonus">Bonus Dice (Cost: 1st=1, 2nd=2, 3rd=3 Momentum)</label>
                            <input type="number" id="ram-bonus" value="0" min="0" max="0" style="width: 80px;">
                        </div>

                        <div style="margin-top: 15px;">
                            <button class="btn" style="background: var(--lcars-orange);" onclick="executeRamAction()">RAM!</button>
                            <button class="btn btn-secondary" onclick="cancelAction()">Cancel</button>
                        </div>

                        <div id="ram-results" style="margin-top: 15px; display: none;"></div>
                    </div>

                    <!-- Change Position Panel -->
                    <div class="action-detail-panel" id="change-position-panel" style="display: none;">
                        <h3 style="color: var(--lcars-success);">CHANGE POSITION</h3>

                        <div class="info-box info">
                            <p style="margin: 0;">
                                Move to a different bridge station. You will arrive at your new position at the <strong>start of your next turn</strong>.
                            </p>
                        </div>

                        <div id="change-position-select-container" style="margin-top: 15px;">
                            <label for="change-position-select">Select New Position</label>
                            <select id="change-position-select" style="width: 100%;">
                                <option value="captain">CAPTAIN - Command, Direct, Rally</option>
                                <option value="helm">HELM - Maneuver, Evasive Action, Attack Pattern</option>
                                <option value="tactical">TACTICAL - Fire Weapons, Defensive Fire, Calibrate</option>
                                <option value="operations">OPERATIONS - Transporters, Power Management</option>
                                <option value="engineering">ENGINEERING - Damage Control, Regain Power</option>
                                <option value="science">SCIENCE - Sensor Sweep, Scan For Weakness</option>
                                <option value="medical">MEDICAL - Treat Injuries, Coordinate Response</option>
                            </select>
                        </div>

                        <div id="pending-position-notice" style="margin-top: 15px; padding: 10px; background: #332; border-radius: 5px; {% if not pending_position %}display: none;{% endif %}">
                            <strong style="color: var(--lcars-orange);">Pending Move:</strong>
                            <span id="pending-position-display">{% if pending_position %}You will move to {{ pending_position.upper() }} at the start of your next turn.{% endif %}</span>
                        </div>

                        <div style="margin-top: 15px; padding: 10px; background: #222; border-radius: 5px;">
                            <strong>Current Position:</strong> <span id="current-position-display">{{ position.value.title() }}</span>
                        </div>

                        <div id="change-position-buttons" style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="executeChangePosition()">CHANGE POSITION</button>
                            <button class="btn btn-secondary" onclick="cancelAction()">Cancel</button>
                        </div>

                        <div id="change-position-results" style="margin-top: 15px; display: none;"></div>
                    </div>

                    <!-- Override Panel -->
                    <div class="action-detail-panel" id="override-panel" style="display: none;">
                        <h3 style="color: var(--lcars-african-violet);">OVERRIDE</h3>

                        <div class="info-box warning">
                            <p style="margin: 0;">
                                Attempt an action from another station. <strong>+1 Difficulty</strong> to the base task.
                            </p>
                            {% if position.value == 'captain' %}
                            <p style="margin: 10px 0 0 0; color: var(--lcars-tomato);"><strong>Not available to Captain!</strong></p>
                            {% endif %}
                        </div>

                        <div style="margin-top: 15px;">
                            <label for="override-station-select">Select Target Station</label>
                            <select id="override-station-select" style="width: 100%;" onchange="updateOverrideActions()">
                                <option value="">-- Select Station --</option>
                                <option value="helm">HELM</option>
                                <option value="tactical">TACTICAL</option>
                                <option value="operations">OPERATIONS</option>
                                <option value="engineering">ENGINEERING</option>
                                <option value="science">SCIENCE</option>
                                <option value="medical">MEDICAL</option>
                                <option value="captain">COMMAND</option>
                            </select>
                        </div>

                        <div id="override-action-container" style="margin-top: 15px; display: none;">
                            <label for="override-action-select">Select Action</label>
                            <select id="override-action-select" style="width: 100%;" onchange="updateOverrideDetails()">
                                <option value="">-- Select Action --</option>
                            </select>
                        </div>

                        <div id="override-details" style="margin-top: 15px; padding: 10px; background: #222; border-radius: 5px; display: none;">
                            <strong>Action:</strong> <span id="override-action-display"></span><br>
                            <strong>Base Difficulty:</strong> <span id="override-base-diff">0</span>
                            <span style="color: var(--lcars-tomato);">+ 1 (Override)</span> =
                            <span id="override-total-diff" style="color: var(--lcars-orange);"></span>
                        </div>

                        <div style="margin-top: 15px;">
                            <button id="override-execute-btn" class="btn" style="background: var(--lcars-african-violet); color: var(--lcars-text-dark);" onclick="showOverrideDicePanel()" disabled>SELECT ACTION FIRST</button>
                            <button class="btn btn-secondary" onclick="cancelAction()">Cancel</button>
                        </div>

                        <div id="override-results" style="margin-top: 15px; display: none;"></div>
                    </div>

                    <!-- Impulse Movement Panel -->
                    <div class="action-detail-panel" id="impulse-panel" style="display: none;">
                        <h3 style="color: var(--lcars-bluey);">IMPULSE MOVEMENT</h3>

                        <div class="info-box info">
                            <p style="margin: 0;">
                                Select a destination hex to move your ship. Hexes highlighted in <strong style="color: var(--lcars-success);">green</strong> are valid destinations.
                            </p>
                            <p style="margin: 10px 0 0 0; font-size: 0.9em;">
                                Movement cost in Momentum is shown on each hex. Click a hex to move there.
                            </p>
                        </div>

                        <div id="impulse-map-container" style="margin: 15px 0; min-height: 300px; background: #111; border-radius: 8px; padding: 10px;">
                            <p style="color: #666; text-align: center;">Loading tactical map...</p>
                        </div>

                        <div class="legend" style="margin-bottom: 15px;">
                            <strong style="color: var(--lcars-almond);">Legend:</strong>
                            <span style="color: var(--lcars-success);">‚óè Valid Move</span>
                            <span style="color: var(--lcars-bluey);">‚óè Your Ship</span>
                            <span style="color: var(--lcars-tomato);">‚óè Enemy Ship</span>
                        </div>

                        <button class="btn btn-secondary" onclick="cancelImpulseMovement()">Cancel Movement</button>

                        <div id="impulse-results" style="margin-top: 15px; display: none;"></div>
                    </div>

                    <!-- Generic Dice Roller Panel -->
                    <div class="action-detail-panel" id="dice-panel" style="display: none;">
                        <h3 style="color: var(--lcars-ice);">DICE ROLLER</h3>

                        <div id="current-action-display" style="margin-bottom: 15px; padding: 10px; background: #222; border-radius: 5px; display: none;">
                            <strong>Current Action:</strong> <span id="current-action-name"></span>
                        </div>

                        <div id="roll-details" style="margin-bottom: 15px; padding: 10px; background: #222; border-radius: 5px;">
                            <p><strong>Character Roll (2d20):</strong> <span id="roll-attr-name">Control</span> (<span id="roll-attr-value">9</span>) + <span id="roll-disc-name">Engineering</span> (<span id="roll-disc-value">2</span>) = Target <span id="roll-target">11</span></p>
                            <p id="ship-assist-row" style="display: none;"><strong>Ship Assist (1d20):</strong> <span id="ship-assist-system-name">Structure</span> (<span id="ship-assist-system-value">7</span>) + <span id="ship-assist-dept-name">Engineering</span> (<span id="ship-assist-dept-value">2</span>) = Target <span id="ship-assist-target">9</span></p>
                            <p><strong>Difficulty:</strong> <span id="roll-diff-display">1</span></p>
                        </div>

                        <input type="hidden" id="roll-attr" value="9">
                        <input type="hidden" id="roll-disc" value="2">
                        <input type="hidden" id="roll-diff" value="1">

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div id="roll-bonus-section" style="display: none;">
                                <label for="roll-bonus">Bonus Dice (Cost: 1st=1, 2nd=2, 3rd=3 Momentum)</label>
                                <input type="number" id="roll-bonus" value="0" min="0" max="0" style="width: 100%;">
                            </div>
                            <div>
                                <label><input type="checkbox" id="roll-focus"> Focus Applies</label>
                            </div>
                        </div>

                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="rollDice()">ROLL DICE</button>
                            <button class="btn btn-secondary" onclick="cancelAction()">Cancel</button>
                        </div>

                        <div id="dice-results" style="margin-top: 15px; display: none;">
                            <h4 style="color: var(--lcars-ice);">Results</h4>
                            <div id="dice-display"></div>
                            <div id="dice-summary" style="margin-top: 10px;"></div>
                        </div>
                    </div>
                </div>

                <!-- ============================================
                     MAP TAB
                     ============================================ -->
                <div id="tab-map" class="tab-panel">
                    <!-- Tactical Map -->
                    <div class="map-panel">
                        <h3>TACTICAL MAP</h3>
                        <div id="tactical-map-container">
                            <p style="color: #666;">Loading tactical map...</p>
                        </div>
                        <div class="legend">
                            <strong style="color: var(--lcars-almond);">Range:</strong>
                            <span style="color: var(--lcars-success);">Close (same hex)</span>
                            <span style="color: var(--lcars-bluey);">Medium (1 hex)</span>
                            <span style="color: var(--lcars-orange);">Long (2 hex)</span>
                            <span style="color: var(--lcars-tomato);">Extreme (3+ hex)</span>
                        </div>
                        <div id="terrain-legend-container"></div>
                    </div>

                    <!-- Enemy Ships (simplified view) -->
                    <div class="ship-panel enemy-ship" style="margin-top: 15px;">
                        <h3>ENEMY VESSELS</h3>
                        <p style="color: var(--lcars-almond); font-size: 0.9em; margin-bottom: 10px;">Detected hostiles in sector:</p>
                        {% for enemy in enemy_ships %}
                        <div class="enemy-ship-item" data-ship-id="{{ loop.index0 }}">
                            <strong>{{ enemy.name }}</strong>
                            <div style="font-size: 0.85em; color: var(--lcars-almond);">{{ enemy.ship_class }}-class</div>
                            <div class="stat-row" style="margin-top: 5px;">
                                <span>Shields</span>
                                <span class="stat-value enemy-shields">{{ enemy.shields }} / {{ enemy.shields_max }}</span>
                            </div>
                            <div class="shields-bar" style="height: 10px;">
                                <div class="fill enemy-shields-bar" style="width: {{ (enemy.shields / enemy.shields_max * 100) | int }}%; background: var(--lcars-tomato);"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- ============================================
                     CHARACTER TAB
                     ============================================ -->
                <div id="tab-character" class="tab-panel">
                    {% if player_char %}
                    <div class="character-panel">
                        <h3>{{ player_char.name }}</h3>
                        <div class="stat-row">
                            <span>Rank / Position</span>
                            <span class="stat-value">{{ player_char.rank }} - {{ position.value.title() }}</span>
                        </div>
                        <div class="stat-row">
                            <span>Stress</span>
                            <span class="stat-value">{{ player_char.stress }} / {{ player_char.stress_max }}</span>
                        </div>

                        <h4 class="section-header">ATTRIBUTES</h4>
                        <div class="stats-grid">
                            <div class="stat-row">
                                <span>Control</span>
                                <span class="stat-value">{{ player_char.attributes.control }}</span>
                            </div>
                            <div class="stat-row">
                                <span>Daring</span>
                                <span class="stat-value">{{ player_char.attributes.daring }}</span>
                            </div>
                            <div class="stat-row">
                                <span>Fitness</span>
                                <span class="stat-value">{{ player_char.attributes.fitness }}</span>
                            </div>
                            <div class="stat-row">
                                <span>Insight</span>
                                <span class="stat-value">{{ player_char.attributes.insight }}</span>
                            </div>
                            <div class="stat-row">
                                <span>Presence</span>
                                <span class="stat-value">{{ player_char.attributes.presence }}</span>
                            </div>
                            <div class="stat-row">
                                <span>Reason</span>
                                <span class="stat-value">{{ player_char.attributes.reason }}</span>
                            </div>
                        </div>

                        <h4 class="section-header">DISCIPLINES</h4>
                        <div class="stats-grid">
                            <div class="stat-row">
                                <span>Command</span>
                                <span class="stat-value">{{ player_char.disciplines.command }}</span>
                            </div>
                            <div class="stat-row">
                                <span>Conn</span>
                                <span class="stat-value">{{ player_char.disciplines.conn }}</span>
                            </div>
                            <div class="stat-row">
                                <span>Engineering</span>
                                <span class="stat-value">{{ player_char.disciplines.engineering }}</span>
                            </div>
                            <div class="stat-row">
                                <span>Medicine</span>
                                <span class="stat-value">{{ player_char.disciplines.medicine }}</span>
                            </div>
                            <div class="stat-row">
                                <span>Science</span>
                                <span class="stat-value">{{ player_char.disciplines.science }}</span>
                            </div>
                            <div class="stat-row">
                                <span>Security</span>
                                <span class="stat-value">{{ player_char.disciplines.security }}</span>
                            </div>
                        </div>

                        <h4 class="section-header">FOCUSES</h4>
                        <div style="padding: 10px; background: #1a1a1a; border-radius: 5px;">
                            <textarea id="char-focuses" style="width: 100%; height: 60px; padding: 8px; background: #0a0a0a; color: var(--lcars-ice); border: 1px solid #333; border-radius: 3px; font-family: inherit; resize: vertical;">{{ player_char.focuses | join(', ') }}</textarea>
                            <small style="color: var(--lcars-almond);">Separate focuses with commas</small>
                        </div>

                        <h4 class="section-header">TALENTS</h4>
                        <div style="padding: 10px; background: #1a1a1a; border-radius: 5px;">
                            <textarea id="char-talents" style="width: 100%; height: 100px; padding: 8px; background: #0a0a0a; color: var(--lcars-ice); border: 1px solid #333; border-radius: 3px; font-family: inherit; resize: vertical;">{{ player_char.talents | join('\n') }}</textarea>
                            <small style="color: var(--lcars-almond);">One talent per line</small>
                        </div>

                        <button onclick="saveCharacterFocusesTalents()" class="btn" style="margin-top: 15px; background: var(--lcars-bluey); color: var(--lcars-text-dark); width: 100%;">
                            SAVE FOCUSES & TALENTS
                        </button>
                    </div>
                    {% else %}
                    <div class="character-panel">
                        <h3>NO CHARACTER ASSIGNED</h3>
                        <p style="color: var(--lcars-almond);">You don't have a character assigned to this encounter.</p>
                    </div>
                    {% endif %}
                </div>

                <!-- ============================================
                     SHIP TAB
                     ============================================ -->
                <div id="tab-ship" class="tab-panel">
                    {% if player_ship %}
                    <div class="ship-panel player-ship">
                        <h3>{{ player_ship.name }}</h3>
                        <div class="stat-row">
                            <span>Class</span>
                            <span class="stat-value">{{ player_ship.ship_class }}-class (Scale {{ player_ship.scale }})</span>
                        </div>
                        <div class="stat-row">
                            <span>Resistance</span>
                            <span class="stat-value" id="player-resistance">
                                {{ player_ship.resistance }}{% if resistance_bonus > 0 %} <span style="color: var(--lcars-success);">(+{{ resistance_bonus }})</span>{% endif %}
                            </span>
                        </div>

                        <!-- Shields -->
                        <h4 class="section-header">SHIELDS</h4>
                        <div class="stat-row">
                            <span>Shields</span>
                            <span class="stat-value" id="player-shields">
                                {{ player_ship.shields if player_ship.shields_raised else 0 }} / {{ player_ship.shields_max }}
                                <span id="shields-status" style="margin-left: 8px; font-size: 0.8em; color: var(--lcars-{% if player_ship.shields_raised %}success{% else %}tomato{% endif %});">
                                    [{{ 'ONLINE' if player_ship.shields_raised else 'OFFLINE' }}]
                                </span>
                            </span>
                        </div>
                        <div class="shields-bar">
                            <div class="fill" id="player-shields-bar" style="width: {{ ((player_ship.shields / player_ship.shields_max * 100) | int) if player_ship.shields_raised else 0 }}%;{% if not player_ship.shields_raised %} background: var(--lcars-tomato);{% endif %}"></div>
                        </div>

                        <!-- Systems -->
                        <h4 class="section-header">SYSTEMS</h4>
                        <div class="stats-grid">
                            {% set systems = [('Comms', player_ship.systems.comms, 'comms'), ('Computers', player_ship.systems.computers, 'computers'), ('Engines', player_ship.systems.engines, 'engines'), ('Sensors', player_ship.systems.sensors, 'sensors'), ('Structure', player_ship.systems.structure, 'structure'), ('Weapons', player_ship.systems.weapons, 'weapons')] %}
                            {% for name, value, key in systems %}
                            {% set breach_potency = player_ship.breaches | selectattr('system_name', 'equalto', key) | map(attribute='potency') | sum %}
                            <div class="stat-row {% if breach_potency > 0 %}breached{% endif %}" data-system="{{ key }}">
                                <span>{{ name }}</span>
                                <span class="stat-value">
                                    {{ value }}
                                    <span class="breach-indicator" style="{% if breach_potency == 0 %}display:none{% endif %}">[Breach <span class="breach-count">{{ breach_potency }}</span>]</span>
                                </span>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Departments -->
                        <h4 class="section-header">DEPARTMENTS</h4>
                        <div class="stats-grid">
                            <div class="stat-row"><span>Command</span><span class="stat-value">{{ player_ship.departments.command }}</span></div>
                            <div class="stat-row"><span>Conn</span><span class="stat-value">{{ player_ship.departments.conn }}</span></div>
                            <div class="stat-row"><span>Engineering</span><span class="stat-value">{{ player_ship.departments.engineering }}</span></div>
                            <div class="stat-row"><span>Medicine</span><span class="stat-value">{{ player_ship.departments.medicine }}</span></div>
                            <div class="stat-row"><span>Science</span><span class="stat-value">{{ player_ship.departments.science }}</span></div>
                            <div class="stat-row"><span>Security</span><span class="stat-value">{{ player_ship.departments.security }}</span></div>
                        </div>

                        <!-- Weapons -->
                        <h4 class="section-header">
                            WEAPONS
                            <span id="weapons-status" style="margin-left: 10px; color: var(--lcars-{% if player_ship.weapons_armed %}orange{% else %}tomato{% endif %});">
                                [{{ 'ARMED' if player_ship.weapons_armed else 'STANDBY' }}]
                            </span>
                        </h4>
                        <div class="weapons-list">
                            {% for weapon in player_ship.weapons %}
                            <div class="weapon-item">
                                <span class="weapon-name">{{ weapon.name }}</span>
                                <span class="weapon-stats">Dmg {{ weapon.damage }}+{{ player_ship.weapons_damage_bonus() }} | {{ weapon.range.value.title() }}</span>
                            </div>
                            {% endfor %}
                        </div>

                        {% if player_ship.talents %}
                        <h4 class="section-header">SHIP TALENTS</h4>
                        <div style="padding: 10px; background: #1a1a1a; border-radius: 5px;">
                            {% for talent in player_ship.talents %}
                            <div style="margin: 5px 0;">‚Ä¢ {{ talent }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="ship-panel">
                        <h3>NO SHIP ASSIGNED</h3>
                        <p style="color: var(--lcars-almond);">You don't have a ship assigned to this encounter.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/hex-map.js') }}"></script>
    <script>
        // Tab switching
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Remove active from all nav tabs
            document.querySelectorAll('.player-nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById('tab-' + tabName).classList.add('active');

            // Activate nav tab
            document.querySelector('.tab-' + tabName).classList.add('active');

            // If showing actions tab and it's player turn, refresh state
            if (tabName === 'actions' && currentTurn === 'player') {
                updateActionPanelVisibility();
            }

            // Re-render map when switching to map tab (fixes sizing issues)
            if (tabName === 'map') {
                renderTacticalMap();
            }
        }

        // Global state variables
        const encounterId = '{{ encounter.encounter_id }}';
        const playerShipId = {{ player_ship_db_id if player_ship_db_id else 'null' }};
        const playerCharId = {{ player_char_db_id if player_char_db_id else 'null' }};
        const enemyShipIds = {{ enemy_ship_db_ids | tojson if enemy_ship_db_ids else '[]' }};
        const weaponsBonus = {{ player_ship.weapons_damage_bonus() if player_ship else 0 }};
        const role = 'player';
        let currentTurn = '{{ encounter.current_turn }}';

        // Multi-player support
        const isMultiplayer = {{ 'true' if is_multiplayer else 'false' }};
        const myPlayerId = {{ my_player_id if my_player_id else 'null' }};
        const myPlayerName = '{{ my_player_name | default("Player", true) }}';
        let currentPlayerId = {{ encounter.current_player_id if encounter.current_player_id else 'null' }};
        let currentPlayerName = '{{ current_player_name | default("", true) }}';
        let myHasActed = false;

        // Tactical Map Data
        let tacticalMapData = {{ tactical_map | tojson if tactical_map else '{"radius": 3, "tiles": []}' | safe }};
        let shipPositions = {{ ship_positions | tojson if ship_positions else '[]' | safe }};

        // Resistance tracking
        const baseResistance = {{ player_ship.resistance if player_ship else 4 }};
        let currentResistanceBonus = {{ resistance_bonus if resistance_bonus else 0 }};

        // Shields tracking
        let shieldsRaised = {{ 'true' if player_ship.shields_raised else 'false' }};
        const shieldsMax = {{ player_ship.shields_max if player_ship else 9 }};

        // Toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showSuccessToast(message) { showToast(message, 'success'); }
        function showErrorToast(message) { showToast(message, 'error'); }
        function showInfoToast(message) { showToast(message, 'info'); }

        // Save character focuses and talents
        async function saveCharacterFocusesTalents() {
            const focusesText = document.getElementById('char-focuses')?.value || '';
            const talentsText = document.getElementById('char-talents')?.value || '';

            const focuses = focusesText.split(',').map(f => f.trim()).filter(f => f);
            const talents = talentsText.split('\n').map(t => t.trim()).filter(t => t);

            try {
                const response = await fetch(`/api/campaign/{{ campaign.campaign_id }}/player/{{ my_player_id }}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ focuses, talents })
                });

                const result = await response.json();
                if (result.success) {
                    showSuccessToast('Character saved successfully!');
                } else {
                    showErrorToast('Error saving character: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving character:', error);
                showErrorToast('Error saving character');
            }
        }

        // Weapons tracking
        let weaponsArmed = {{ 'true' if player_ship.weapons_armed else 'false' }};

        // Reserve Power tracking
        let hasReservePower = {{ 'true' if player_ship.has_reserve_power else 'false' }};

        // Player stats for reference
        const playerAttrs = {
            control: {{ player_char.attributes.control if player_char else 9 }},
            daring: {{ player_char.attributes.daring if player_char else 9 }},
            fitness: {{ player_char.attributes.fitness if player_char else 9 }},
            insight: {{ player_char.attributes.insight if player_char else 9 }},
            presence: {{ player_char.attributes.presence if player_char else 9 }},
            reason: {{ player_char.attributes.reason if player_char else 9 }}
        };
        const playerDiscs = {
            command: {{ player_char.disciplines.command if player_char else 2 }},
            conn: {{ player_char.disciplines.conn if player_char else 2 }},
            engineering: {{ player_char.disciplines.engineering if player_char else 2 }},
            medicine: {{ player_char.disciplines.medicine if player_char else 2 }},
            science: {{ player_char.disciplines.science if player_char else 2 }},
            security: {{ player_char.disciplines.security if player_char else 2 }}
        };

        // Ship stats for assist rolls
        const shipSystems = {
            comms: {{ player_ship.systems.comms if player_ship else 7 }},
            computers: {{ player_ship.systems.computers if player_ship else 7 }},
            engines: {{ player_ship.systems.engines if player_ship else 7 }},
            sensors: {{ player_ship.systems.sensors if player_ship else 7 }},
            structure: {{ player_ship.systems.structure if player_ship else 7 }},
            weapons: {{ player_ship.systems.weapons if player_ship else 7 }}
        };
        const shipDepts = {
            command: {{ player_ship.departments.command if player_ship else 2 }},
            conn: {{ player_ship.departments.conn if player_ship else 2 }},
            engineering: {{ player_ship.departments.engineering if player_ship else 2 }},
            medicine: {{ player_ship.departments.medicine if player_ship else 2 }},
            science: {{ player_ship.departments.science if player_ship else 2 }},
            security: {{ player_ship.departments.security if player_ship else 2 }}
        };

        // Action state
        let currentAction = null;
        let currentActionConfig = null;
        let activeMinorAction = null;
        let selectedMajorAction = null;
        let selectedMinorAction = null;
        let actionAvailability = {};

        // Action constants
        const BUFF_ACTIONS = ['Calibrate Weapons', 'Calibrate Sensors', 'Targeting Solution'];
        const MAJOR_BUFF_ACTIONS = ['Attack Pattern', 'Evasive Action'];
        const FIRE_ONLY_MINOR_ACTIONS = ['Targeting Solution', 'Calibrate Weapons'];
        const MINOR_ACTION_EFFECTS = {
            'Calibrate Weapons': ['+1 damage on next attack'],
            'Targeting Solution': ['Re-roll 1d20 OR choose system on breach (pick one!)'],
            'Calibrate Sensors': ['Re-roll 1d20 on next sensor task'],
        };

        // Update action panel visibility
        function updateActionPanelVisibility() {
            const actionsContainer = document.getElementById('actions-container');
            const enemyTurnMsg = document.getElementById('actions-enemy-turn-msg');
            const claimTurnMsg = document.getElementById('claim-turn-message');
            const claimTurnMsgText = document.getElementById('claim-turn-message-text');

            if (currentTurn === 'player') {
                enemyTurnMsg.style.display = 'none';

                // In multiplayer, only show actions if this player has claimed the turn
                if (isMultiplayer) {
                    if (currentPlayerId === myPlayerId) {
                        // Player has claimed turn - show actions
                        actionsContainer.style.display = 'block';
                        if (claimTurnMsg) claimTurnMsg.style.display = 'none';
                    } else {
                        // Player hasn't claimed turn - hide actions, show message
                        actionsContainer.style.display = 'none';
                        if (claimTurnMsg) {
                            claimTurnMsg.style.display = 'block';
                            if (claimTurnMsgText) {
                                if (currentPlayerId) {
                                    // Another player is acting
                                    claimTurnMsgText.innerHTML = '<strong>' + (currentPlayerName || 'Another player') + '</strong> is currently taking their turn.';
                                } else {
                                    // No one has claimed yet
                                    claimTurnMsgText.textContent = "It's the player turn! Claim your turn above to take an action.";
                                }
                            }
                        }
                        hideAllActionPanels();
                    }
                } else {
                    // Single player - always show actions on player turn
                    actionsContainer.style.display = 'block';
                    if (claimTurnMsg) claimTurnMsg.style.display = 'none';
                }
            } else {
                actionsContainer.style.display = 'none';
                enemyTurnMsg.style.display = 'block';
                if (claimTurnMsg) claimTurnMsg.style.display = 'none';
                // Hide all action panels
                hideAllActionPanels();
            }
        }

        function hideAllActionPanels() {
            document.getElementById('fire-panel').style.display = 'none';
            document.getElementById('defensive-fire-panel').style.display = 'none';
            document.getElementById('reroute-power-panel').style.display = 'none';
            document.getElementById('damage-control-panel').style.display = 'none';
            document.getElementById('ram-panel').style.display = 'none';
            document.getElementById('thrusters-panel').style.display = 'none';
            document.getElementById('change-position-panel').style.display = 'none';
            document.getElementById('override-panel').style.display = 'none';
            document.getElementById('dice-panel').style.display = 'none';
            document.getElementById('selection-summary').style.display = 'none';
        }

        // Track actions taken this turn
        let turnActionLog = [];

        // Add an action to the turn log (accumulates minor + major)
        function logTurnAction(actionName, actionType, message, isSuccess = true, diceResults = null) {
            turnActionLog.push({
                name: actionName,
                type: actionType,  // 'minor' or 'major'
                message: message,
                success: isSuccess,
                dice: diceResults
            });
            updateLastActionResults();
        }

        // Update the last action results display
        function updateLastActionResults() {
            const container = document.getElementById('last-action-results');
            const content = document.getElementById('last-action-content');

            if (turnActionLog.length === 0) {
                container.style.display = 'none';
                return;
            }

            // Determine border color based on last action's success
            const lastAction = turnActionLog[turnActionLog.length - 1];
            container.style.borderLeftColor = lastAction.success ? 'var(--lcars-success)' : 'var(--lcars-tomato)';

            let html = '';
            for (const action of turnActionLog) {
                const typeLabel = action.type === 'minor' ? 'MINOR' : 'MAJOR';
                const typeColor = action.type === 'minor' ? 'var(--lcars-almond)' : 'var(--lcars-orange)';

                html += `
                    <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #333;">
                        <div style="margin-bottom: 5px;">
                            <span style="color: ${typeColor}; font-size: 0.8em;">${typeLabel}</span>
                            <strong style="color: var(--lcars-text); margin-left: 8px;">${action.name}</strong>
                        </div>
                `;

                // Show dice results if available
                if (action.dice && action.dice.rolls) {
                    html += `<div style="margin-bottom: 8px;">`;
                    html += action.dice.rolls.map((roll, index) => {
                        let cls = 'dice-fail';
                        if (roll === 1) cls = 'dice-crit';
                        else if (roll <= action.dice.target) cls = 'dice-success';
                        else if (roll === 20) cls = 'dice-complication';
                        return `<span class="dice-result ${cls}" style="font-size: 0.9em; padding: 4px 8px;">${roll}</span>`;
                    }).join(' ');
                    html += `</div>`;
                }

                html += `<div style="color: var(--lcars-text); font-size: 0.9em;">${action.message}</div>`;
                html += `</div>`;
            }

            // Remove last border
            html = html.replace(/border-bottom: 1px solid #333;([^}]*}[^<]*<\/div>\s*)$/, '$1');

            content.innerHTML = html;
            container.style.display = 'block';
        }

        // Clear last action results (call when starting a new turn)
        function clearLastActionResults() {
            turnActionLog = [];
            document.getElementById('last-action-results').style.display = 'none';
        }

        // Action selection
        async function selectAction(name, type, difficulty) {
            if (currentTurn !== 'player') {
                showErrorToast("It's not your turn!");
                return;
            }

            // Check if action is available (system not destroyed)
            const availability = isActionAvailable(name);
            if (!availability.available) {
                showErrorToast(`Cannot use ${name}: ${availability.reason}`);
                return;
            }

            // Apply breach modifier to difficulty if applicable
            if (availability.breach_modifier > 0) {
                difficulty = difficulty + availability.breach_modifier;
            }

            currentAction = {name, type, difficulty};

            if (type === 'minor') {
                if (BUFF_ACTIONS.includes(name)) {
                    executeBuffAction(name);
                    highlightAction(name, 'minor');
                } else if (name === 'Impulse') {
                    startImpulseMovement();
                    highlightAction(name, 'minor');
                } else if (name === 'Thrusters') {
                    showThrustersPanel();
                    highlightAction(name, 'minor');
                } else if (name === 'Change Position') {
                    showPanel('change-position-panel');
                    highlightAction(name, 'minor');
                    // Set current position in dropdown
                    const currentPos = '{{ position.value }}';
                    document.getElementById('change-position-select').value = currentPos;
                }
                return;
            }

            // Major action selected
            selectedMajorAction = name;
            highlightAction(name, 'major');
            updateSelectionSummary();

            if (name === 'Fire') {
                showPanel('fire-panel');
                updateFireTargets();
                updateFireDetails();
                updateFireMinorActionBanner();
                // Show warning if weapons not armed
                if (!weaponsArmed) {
                    const resultsDiv = document.getElementById('fire-results');
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `<div class="info-box danger"><strong>WARNING: Weapons are not armed!</strong><br>Use the <em>Arm Weapons</em> minor action first before firing.</div>`;
                }
            } else if (name === 'Defensive Fire') {
                showPanel('defensive-fire-panel');
                updateDefensiveFireMomentumWarning();
            } else if (name === 'Reroute Power') {
                if (!hasReservePower) {
                    showErrorToast("Reroute Power requires Reserve Power!");
                    return;
                }
                showPanel('reroute-power-panel');
                updateRerouteTargetDisplay();
            } else if (name === 'Ram') {
                showPanel('ram-panel');
                updateRamDamageDisplay();
            } else if (name === 'Damage Control') {
                showPanel('damage-control-panel');
                populateDamageControlOptions();
            } else if (name === 'Override') {
                {% if position.value == 'captain' %}
                showErrorToast("Captain cannot use Override!");
                return;
                {% else %}
                showPanel('override-panel');
                // Reset override selections
                document.getElementById('override-station-select').value = '';
                document.getElementById('override-action-container').style.display = 'none';
                document.getElementById('override-details').style.display = 'none';
                document.getElementById('override-execute-btn').disabled = true;
                document.getElementById('override-execute-btn').textContent = 'SELECT ACTION FIRST';
                {% endif %}
            } else if (MAJOR_BUFF_ACTIONS.includes(name)) {
                executeMajorBuffAction(name);
                return;
            } else if (name === 'Pass') {
                // Pass action - immediately execute, no roll needed
                executePassAction();
                return;
            } else {
                // Generic dice roll action - fetch config from server
                try {
                    const configResponse = await fetch(`/api/action-config/${encodeURIComponent(name)}`);
                    const config = await configResponse.json();
                    currentActionConfig = config;
                    setupDicePanel(config, difficulty);
                } catch (err) {
                    console.error('Failed to fetch action config:', err);
                    setupDicePanel(null, difficulty);
                }
                showPanel('dice-panel');
                document.getElementById('current-action-display').style.display = 'block';
                document.getElementById('current-action-name').textContent = name;
            }
        }

        function showPanel(panelId) {
            hideAllActionPanels();
            document.getElementById(panelId).style.display = 'block';
            document.getElementById(panelId).scrollIntoView({behavior: 'smooth'});
        }

        function setupDicePanel(config, difficulty) {
            if (config && config.roll) {
                const attrName = config.roll.attribute;
                const discName = config.roll.discipline;
                const attrValue = playerAttrs[attrName] || 9;
                const discValue = playerDiscs[discName] || 2;
                const targetNum = attrValue + discValue;

                document.getElementById('roll-attr-name').textContent = attrName.charAt(0).toUpperCase() + attrName.slice(1);
                document.getElementById('roll-attr-value').textContent = attrValue;
                document.getElementById('roll-disc-name').textContent = discName.charAt(0).toUpperCase() + discName.slice(1);
                document.getElementById('roll-disc-value').textContent = discValue;
                document.getElementById('roll-target').textContent = targetNum;
                document.getElementById('roll-diff-display').textContent = config.roll.difficulty;

                document.getElementById('roll-attr').value = attrValue;
                document.getElementById('roll-disc').value = discValue;
                document.getElementById('roll-diff').value = config.roll.difficulty;

                const assistRow = document.getElementById('ship-assist-row');
                if (config.roll.ship_assist_system && config.roll.ship_assist_department) {
                    const sysName = config.roll.ship_assist_system;
                    const deptName = config.roll.ship_assist_department;
                    const sysValue = shipSystems[sysName] || 7;
                    const deptValue = shipDepts[deptName] || 2;

                    document.getElementById('ship-assist-system-name').textContent = sysName.charAt(0).toUpperCase() + sysName.slice(1);
                    document.getElementById('ship-assist-system-value').textContent = sysValue;
                    document.getElementById('ship-assist-dept-name').textContent = deptName.charAt(0).toUpperCase() + deptName.slice(1);
                    document.getElementById('ship-assist-dept-value').textContent = deptValue;
                    document.getElementById('ship-assist-target').textContent = sysValue + deptValue;
                    assistRow.style.display = 'block';
                } else {
                    assistRow.style.display = 'none';
                }
            } else {
                document.getElementById('roll-diff').value = difficulty;
                document.getElementById('roll-diff-display').textContent = difficulty;
            }
            document.getElementById('roll-details').style.display = 'block';
            document.getElementById('dice-results').style.display = 'none';
        }

        // Action availability check
        function isActionAvailable(actionName) {
            const availability = actionAvailability[actionName];
            if (!availability) return { available: true, reason: null };
            return availability;
        }

        async function fetchActionAvailability() {
            try {
                const response = await fetch(`/api/encounter/${encounterId}/action-availability`);
                if (response.ok) {
                    actionAvailability = await response.json();
                    updateActionAvailabilityUI();
                }
            } catch (e) {
                console.error('Failed to fetch action availability:', e);
            }
        }

        function updateActionAvailabilityUI() {
            const actionItems = document.querySelectorAll('[data-action-name]');
            actionItems.forEach(item => {
                const actionName = item.getAttribute('data-action-name');
                const availability = actionAvailability[actionName];

                // If no availability data, assume action is available (consistent with isActionAvailable)
                if (!availability) {
                    item.classList.remove('action-disabled');
                    const breachWarning = item.querySelector('.breach-warning');
                    if (breachWarning) breachWarning.style.display = 'none';
                    return;
                }

                const breachWarning = item.querySelector('.breach-warning');
                if (!availability.available) {
                    item.classList.add('action-disabled');
                    if (breachWarning) {
                        breachWarning.textContent = `[${availability.reason}]`;
                        breachWarning.style.display = 'inline';
                    }
                } else {
                    item.classList.remove('action-disabled');
                    if (breachWarning) breachWarning.style.display = 'none';
                }
            });
        }

        // Highlighting
        function clearActionSelections(type) {
            document.querySelectorAll('.action-panel').forEach(panel => {
                if ((type === 'minor' && panel.classList.contains('minor')) ||
                    (type === 'major' && panel.classList.contains('major'))) {
                    panel.querySelectorAll('.action-list li').forEach(li => {
                        li.classList.remove('action-selected');
                    });
                }
            });
        }

        function highlightAction(actionName, type) {
            clearActionSelections(type);
            document.querySelectorAll('.action-list li').forEach(li => {
                const strongEl = li.querySelector('strong');
                if (strongEl && strongEl.textContent === actionName) {
                    li.classList.add('action-selected');
                }
            });
        }

        function updateSelectionSummary() {
            const summaryPanel = document.getElementById('selection-summary');
            const summaryMinor = document.getElementById('summary-minor');
            const summaryMajor = document.getElementById('summary-major');

            if (activeMinorAction || selectedMajorAction) {
                summaryPanel.style.display = 'block';
            } else {
                summaryPanel.style.display = 'none';
            }

            if (activeMinorAction) {
                const effects = MINOR_ACTION_EFFECTS[activeMinorAction] || [];
                summaryMinor.innerHTML = `<strong style="color: var(--lcars-success);">OK ${activeMinorAction}</strong>
                    <div style="font-size: 0.85em; color: var(--lcars-almond); margin-top: 4px;">
                        ${effects.map(e => `* ${e}`).join('<br>')}
                    </div>`;
            } else {
                summaryMinor.innerHTML = '<span style="color: #666;">None selected (optional)</span>';
            }

            if (selectedMajorAction) {
                summaryMajor.innerHTML = `<strong style="color: var(--lcars-success);">OK ${selectedMajorAction}</strong>`;
            } else {
                summaryMajor.innerHTML = '<span style="color: #888;">Select a major action to proceed</span>';
            }
        }

        function cancelAction() {
            currentAction = null;
            selectedMajorAction = null;
            clearActionSelections('major');
            updateSelectionSummary();
            hideAllActionPanels();
        }

        // Shields toggle
        async function toggleShields() {
            if (currentTurn !== 'player') {
                showErrorToast("It's not your turn!");
                return;
            }
            const actionName = shieldsRaised ? 'Lower Shields' : 'Raise Shields';
            const response = await fetch(`/api/encounter/${encounterId}/execute-action`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action_name: actionName, character_id: playerCharId, player_id: myPlayerId })
            });
            const data = await response.json();

            if (data.success) {
                updateShieldsDisplay(data.shields, data.shields_raised);
                selectedMinorAction = actionName;
                highlightAction(actionName, 'minor');
                updateSelectionSummary();
                showSuccessToast(data.message);

                // Log this minor action
                logTurnAction(actionName, 'minor', data.message, true);
                updateLastActionResults();
            }
        }

        function updateShieldsDisplay(shields, raised) {
            shieldsRaised = raised;
            const shieldsEl = document.getElementById('player-shields');
            const barEl = document.getElementById('player-shields-bar');

            // Display 0 when shields are offline
            const displayValue = raised ? shields : 0;

            shieldsEl.innerHTML = `${displayValue} / ${shieldsMax} <span id="shields-status" style="margin-left: 8px; font-size: 0.8em; color: var(--lcars-${raised ? 'success' : 'tomato'});">[${raised ? 'ONLINE' : 'OFFLINE'}]</span>`;
            barEl.style.width = `${(displayValue / shieldsMax) * 100}%`;
            barEl.style.background = raised ? '' : 'var(--lcars-tomato)';

            const btn = document.getElementById('shields-action-btn');
            if (btn) btn.querySelector('strong').textContent = raised ? 'Lower Shields' : 'Raise Shields';
        }

        // Weapons toggle
        async function toggleWeapons() {
            if (currentTurn !== 'player') {
                showErrorToast("It's not your turn!");
                return;
            }
            const actionName = weaponsArmed ? 'Disarm Weapons' : 'Arm Weapons';
            const response = await fetch(`/api/encounter/${encounterId}/execute-action`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action_name: actionName, character_id: playerCharId, player_id: myPlayerId })
            });
            const data = await response.json();

            if (data.success) {
                updateWeaponsDisplay(data.weapons_armed);
                selectedMinorAction = actionName;
                highlightAction(actionName, 'minor');
                updateSelectionSummary();
                showSuccessToast(data.message);

                // Log this minor action
                logTurnAction(actionName, 'minor', data.message, true);
                updateLastActionResults();
            }
        }

        function updateWeaponsDisplay(armed) {
            weaponsArmed = armed;
            const statusEl = document.getElementById('weapons-status');
            statusEl.textContent = `[${armed ? 'ARMED' : 'STANDBY'}]`;
            statusEl.style.color = armed ? 'var(--lcars-orange)' : 'var(--lcars-tomato)';

            const btn = document.getElementById('weapons-action-btn');
            if (btn) btn.querySelector('strong').textContent = armed ? 'Disarm Weapons' : 'Arm Weapons';
        }

        // Buff action execution
        async function executeBuffAction(actionName) {
            const response = await fetch(`/api/encounter/${encounterId}/execute-action`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action_name: actionName, character_id: playerCharId, player_id: myPlayerId })
            });
            const data = await response.json();

            if (data.success) {
                activeMinorAction = actionName;
                updateMajorActionHighlights();
                updateSelectionSummary();
                showSuccessToast(`${actionName} activated!`);

                // Log this minor buff action
                const effects = MINOR_ACTION_EFFECTS[actionName] || [];
                logTurnAction(
                    actionName,
                    'minor',
                    effects.length > 0 ? effects.join(', ') : 'Buff activated',
                    true
                );
                updateLastActionResults();
            } else {
                showErrorToast(data.error || 'Action failed');
            }
        }

        async function executeMajorBuffAction(actionName) {
            const response = await fetch(`/api/encounter/${encounterId}/execute-action`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action_name: actionName, character_id: playerCharId, player_id: myPlayerId })
            });
            const data = await response.json();

            if (data.success) {
                showSuccessToast(`${actionName} activated!`);
                if (data.resistance_bonus) {
                    currentResistanceBonus += data.resistance_bonus;
                    updateResistanceDisplay();
                }

                // Log this major buff action
                logTurnAction(
                    actionName,
                    'major',
                    data.message || 'Action completed',
                    true
                );
                updateLastActionResults();

                if (data.current_turn) {
                    fetchTurnStatus();
                }
            } else {
                showErrorToast(data.error || 'Action failed');
            }
        }

        async function executePassAction() {
            // Pass action - end turn without doing anything
            const response = await fetch(`/api/encounter/${encounterId}/execute-action`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action_name: 'Pass', character_id: playerCharId, player_id: myPlayerId })
            });
            const data = await response.json();

            if (data.success) {
                showSuccessToast('Turn passed.');

                // Log this major action
                logTurnAction(
                    'Pass',
                    'major',
                    'Passed turn without acting.',
                    true
                );

                if (data.current_turn) {
                    fetchTurnStatus();
                }
            } else {
                showErrorToast(data.error || 'Action failed');
            }
        }

        function updateMajorActionHighlights() {
            const fireAction = document.querySelector('.fire-action');
            if (fireAction) {
                if (activeMinorAction && FIRE_ONLY_MINOR_ACTIONS.includes(activeMinorAction)) {
                    fireAction.classList.add('fire-action-highlighted');
                } else {
                    fireAction.classList.remove('fire-action-highlighted');
                }
            }
        }

        function updateFireMinorActionBanner() {
            const banner = document.getElementById('fire-minor-action-banner');
            const nameSpan = document.getElementById('fire-minor-action-name');
            const effectsDiv = document.getElementById('fire-minor-action-effects');
            const targetingSolutionPanel = document.getElementById('targeting-solution-panel');

            if (activeMinorAction) {
                banner.style.display = 'block';
                nameSpan.textContent = activeMinorAction;
                const effects = MINOR_ACTION_EFFECTS[activeMinorAction] || [];
                effectsDiv.innerHTML = effects.map(e => `* ${e}`).join('<br>');
                targetingSolutionPanel.style.display = activeMinorAction === 'Targeting Solution' ? 'block' : 'none';
            } else {
                banner.style.display = 'none';
                targetingSolutionPanel.style.display = 'none';
            }
        }

        // ========== HEX DISTANCE & RANGE FUNCTIONS ==========

        function hexDistance(pos1, pos2) {
            const q1 = pos1.q, r1 = pos1.r;
            const q2 = pos2.q, r2 = pos2.r;
            return (Math.abs(q1 - q2) + Math.abs(q1 + r1 - q2 - r2) + Math.abs(r1 - r2)) / 2;
        }

        function getRangeCategory(distance) {
            if (distance === 0) return 'close';
            if (distance === 1) return 'medium';
            if (distance === 2) return 'long';
            return 'extreme';
        }

        const WEAPON_RANGE_MAX = {
            'close': 0,
            'medium': 1,
            'long': 2,
            'extreme': 999
        };

        function getPlayerPosition() {
            const playerShip = shipPositions.find(s => s.faction === 'player');
            return playerShip ? playerShip.position : { q: 0, r: 0 };
        }

        function getVisibleEnemies() {
            return shipPositions.filter(s => s.faction === 'enemy');
        }

        // ========== FIRE ACTION FUNCTIONS ==========

        const shipWeapons = {{ player_ship.systems.weapons if player_ship else 7 }};
        const shipSecurity = {{ player_ship.departments.security if player_ship else 2 }};
        const shipTargetNumber = shipWeapons + shipSecurity;
        let lastFireData = null;

        function updateFireTargets() {
            const targetSelect = document.getElementById('target-select');
            const visibleEnemies = getVisibleEnemies();
            const playerPos = getPlayerPosition();

            targetSelect.innerHTML = '';

            if (visibleEnemies.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No visible targets';
                option.disabled = true;
                targetSelect.appendChild(option);
                document.getElementById('target-range-info').textContent = 'No enemies visible';
                return;
            }

            visibleEnemies.forEach((enemy, index) => {
                const distance = hexDistance(playerPos, enemy.position);
                const rangeCategory = getRangeCategory(distance);

                const option = document.createElement('option');
                option.value = enemy.id;
                option.dataset.q = enemy.position.q;
                option.dataset.r = enemy.position.r;
                option.dataset.distance = distance;
                option.dataset.range = rangeCategory;
                option.textContent = `${enemy.name} (${rangeCategory.charAt(0).toUpperCase() + rangeCategory.slice(1)} - ${distance} hex${distance !== 1 ? 'es' : ''})`;
                targetSelect.appendChild(option);
            });

            updateFireDetails();
        }

        function updateFireDetails() {
            const weaponSelect = document.getElementById('weapon-select');
            const targetSelect = document.getElementById('target-select');
            const rangeWarning = document.getElementById('fire-range-warning');
            const rangeInfo = document.getElementById('target-range-info');

            if (!weaponSelect.options.length || !targetSelect.options.length || targetSelect.value === '') {
                document.getElementById('fire-difficulty').textContent = '-';
                document.getElementById('fire-difficulty-breakdown').textContent = '';
                rangeWarning.style.display = 'none';
                return;
            }

            const weaponOption = weaponSelect.options[weaponSelect.selectedIndex];
            const targetOption = targetSelect.options[targetSelect.selectedIndex];

            const baseDamage = parseInt(weaponOption.dataset.damage);
            const weaponType = weaponOption.dataset.type;
            const weaponRange = weaponOption.dataset.range;

            const targetDistance = parseInt(targetOption.dataset.distance) || 0;
            const targetRangeCategory = targetOption.dataset.range || 'close';

            const totalDamage = baseDamage + weaponsBonus;

            let baseDifficulty = weaponType === 'torpedo' ? 3 : 2;
            let rangeDifficultyMod = 0;
            if (targetRangeCategory === 'medium') rangeDifficultyMod = 1;
            else if (targetRangeCategory === 'long') rangeDifficultyMod = 2;
            else if (targetRangeCategory === 'extreme') rangeDifficultyMod = 3;

            const totalDifficulty = baseDifficulty + rangeDifficultyMod;
            const weaponMaxHex = WEAPON_RANGE_MAX[weaponRange] || 2;
            const outOfRange = targetDistance > weaponMaxHex;

            document.getElementById('fire-damage').textContent = totalDamage;
            document.getElementById('fire-difficulty').textContent = totalDifficulty;

            let breakdown = `(${weaponType === 'torpedo' ? 'Torpedo' : 'Energy'}: ${baseDifficulty}`;
            if (rangeDifficultyMod > 0) breakdown += ` + ${rangeDifficultyMod} range`;
            breakdown += ')';
            document.getElementById('fire-difficulty-breakdown').textContent = breakdown;

            rangeInfo.innerHTML = `Target at <strong>${targetRangeCategory}</strong> range (${targetDistance} hex${targetDistance !== 1 ? 'es' : ''})`;

            if (outOfRange) {
                rangeWarning.style.display = 'block';
                rangeWarning.innerHTML = `<strong>OUT OF RANGE!</strong> ${weaponOption.text.split('(')[0].trim()} has ${weaponRange} range (max ${weaponMaxHex} hex${weaponMaxHex !== 1 ? 'es' : ''}), target is ${targetDistance} hex${targetDistance !== 1 ? 'es' : ''} away.`;
            } else {
                rangeWarning.style.display = 'none';
            }
        }

        async function executeFireAction() {
            try {
                if (currentTurn !== 'player') {
                    showErrorToast("It's not your turn!");
                    return;
                }

                if (!weaponsArmed) {
                    const resultsDiv = document.getElementById('fire-results');
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `<div class="info-box danger"><strong>ERROR: Weapons are not armed!</strong><br>Use the <em>Arm Weapons</em> minor action first.</div>`;
                    return;
                }

                const weaponSelect = document.getElementById('weapon-select');
                const targetSelect = document.getElementById('target-select');
                const selectedWeapon = weaponSelect.options[weaponSelect.selectedIndex];
                const selectedTarget = targetSelect.options[targetSelect.selectedIndex];

                const targetId = targetSelect.value;
                const targetIndex = parseInt(targetId.replace('enemy_', ''));

                if (!targetId || isNaN(targetIndex)) {
                    showErrorToast("No valid target selected!");
                    return;
                }

                const targetDistance = parseInt(selectedTarget.dataset.distance) || 0;
                const weaponRange = selectedWeapon.dataset.range;
                const weaponMaxHex = WEAPON_RANGE_MAX[weaponRange] || 2;

                if (targetDistance > weaponMaxHex) {
                    showErrorToast(`Target is out of range!`);
                    return;
                }

                const weaponType = selectedWeapon.dataset.type;
                const targetRangeCategory = selectedTarget.dataset.range || 'close';
                let baseDifficulty = weaponType === 'torpedo' ? 3 : 2;
                let rangeDifficultyMod = 0;
                if (targetRangeCategory === 'medium') rangeDifficultyMod = 1;
                else if (targetRangeCategory === 'long') rangeDifficultyMod = 2;
                else if (targetRangeCategory === 'extreme') rangeDifficultyMod = 3;
                const difficulty = baseDifficulty + rangeDifficultyMod;
                const focus = document.getElementById('fire-focus').checked;
                const bonusDice = parseInt(document.getElementById('fire-bonus').value) || 0;

                lastFireData = {
                    encounter_id: encounterId,
                    weapon_index: parseInt(weaponSelect.value),
                    target_index: targetIndex,
                    targetIndex: targetIndex,
                    attribute: playerAttrs.control,
                    discipline: playerDiscs.security,
                    difficulty: difficulty,
                    focus: focus,
                    bonus_dice: bonusDice,
                    bonusDice: bonusDice,
                    player_id: myPlayerId,
                };

                const response = await fetch('/api/fire', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        encounter_id: encounterId,
                        weapon_index: parseInt(weaponSelect.value),
                        target_index: targetIndex,
                        attribute: playerAttrs.control,
                        discipline: playerDiscs.security,
                        difficulty: difficulty,
                        focus: focus,
                        bonus_dice: bonusDice,
                        character_id: playerCharId,
                        player_id: myPlayerId
                    })
                });
                const data = await response.json();

                // Check for API errors
                if (data.error) {
                    const resultsDiv = document.getElementById('fire-results');
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `<div class="info-box danger"><strong>ERROR:</strong> ${data.error}</div>`;
                    return;
                }

                lastFireData.previous_rolls = data.rolls;
                displayFireResults(data, targetIndex, focus, bonusDice, difficulty);

                // Log to turn summary so results persist after turn ends
                const weaponName = weaponSelect.options[weaponSelect.selectedIndex].text;
                const targetName = selectedTarget.querySelector('.target-name')?.textContent || `Enemy ${targetIndex + 1}`;
                let fireMessage = data.hit
                    ? `<strong>HIT!</strong> Fired ${weaponName} at ${targetName} - ${data.damage_dealt} damage dealt`
                    : `<strong>MISS!</strong> Fired ${weaponName} at ${targetName}`;
                if (data.breaches_caused > 0) {
                    fireMessage += ` (${data.breaches_caused} breach${data.breaches_caused > 1 ? 'es' : ''} caused!)`;
                }
                logTurnAction(
                    'Fire Weapons',
                    'major',
                    fireMessage,
                    data.hit,
                    { rolls: data.rolls, target: data.target_number }
                );

                if (data.current_turn) {
                    fetchTurnStatus();
                    activeMinorAction = null;
                    selectedMajorAction = null;
                    updateFireMinorActionBanner();
                    updateMajorActionHighlights();
                    clearActionSelections('minor');
                    clearActionSelections('major');
                }
            } catch (error) {
                console.error('Fire action error:', error);
                showErrorToast('Fire action failed: ' + error.message);
            }
        }

        function displayFireResults(data, targetIndex, focus, bonusDice, difficulty) {
            const resultsDiv = document.getElementById('fire-results');
            resultsDiv.style.display = 'block';

            if (!data.can_reroll) {
                activeMinorAction = null;
                updateFireMinorActionBanner();
                updateMajorActionHighlights();
                updateSelectionSummary();
            }

            const charDiceCount = 2 + bonusDice;
            const charRolls = data.rolls.slice(0, charDiceCount);
            const shipRoll = data.ship_roll;

            const charDiceHtml = charRolls.map((roll, index) => {
                let cls = 'dice-fail';
                if (roll === 1 || (focus && roll <= playerDiscs.security)) cls = 'dice-crit';
                else if (roll <= data.target_number) cls = 'dice-success';
                else if (roll === 20) cls = 'dice-complication';

                let rerollBtn = '';
                if (data.can_reroll && !data.rerolled) {
                    rerollBtn = ` <button class="btn btn-small" onclick="rerollDie(${index})" style="font-size: 0.7em; padding: 2px 6px;">REROLL</button>`;
                }
                return `<span class="dice-result ${cls}">${roll}${rerollBtn}</span>`;
            }).join('');

            let shipDiceHtml = '';
            if (shipRoll !== null && shipRoll !== undefined) {
                let cls = 'dice-fail';
                if (shipRoll === 1) cls = 'dice-crit';
                else if (shipRoll <= data.ship_target_number) cls = 'dice-success';
                else if (shipRoll === 20) cls = 'dice-complication';
                shipDiceHtml = `<span class="dice-result ${cls}" style="border: 2px solid var(--lcars-almond);" title="Ship Assist">${shipRoll}</span>`;
            }

            let html = `<h3>Attack Roll</h3>`;
            if (data.can_reroll && !data.rerolled) {
                html += `<div class="info-box info"><strong>TARGETING SOLUTION ACTIVE:</strong> Click REROLL to re-roll any die</div>`;
            }
            if (data.rerolled) {
                html += `<div class="info-box success"><strong>DIE RE-ROLLED</strong> (Targeting Solution consumed)</div>`;
            }

            html += `<div style="margin-bottom: 5px;"><strong>Character:</strong> ${charDiceHtml} (target <=${data.target_number})</div>`;
            html += `<div style="margin-bottom: 10px;"><strong>Ship Assist:</strong> ${shipDiceHtml} (target <=${data.ship_target_number})</div>`;
            html += `<p>${data.successes} total successes vs Difficulty ${difficulty}</p>`;

            if (data.complications > 0) {
                html += `<p style="color: var(--lcars-tomato);">${data.complications} complication(s)!</p>`;
            }

            if (data.succeeded) {
                html += `<div class="info-box success"><strong>HIT!</strong></div>`;
                html += `<div class="damage-report"><h4>Damage Report</h4>`;
                html += `<p>Base Damage: ${data.base_damage}`;
                if (data.damage_bonus > 0) html += ` <span style="color: var(--lcars-success);">(+${data.damage_bonus} bonus)</span>`;
                html += `</p>`;
                if (data.resistance_reduction > 0) html += `<p style="color: var(--lcars-almond);">Resistance (${data.target_resistance}): -${data.resistance_reduction}</p>`;
                html += `<p><strong>Final Damage: ${data.total_damage}</strong></p>`;
                html += `<hr style="border-color: #444; margin: 8px 0;">`;
                html += `<p>Shield Damage: ${data.shield_damage}</p>`;
                if (data.hull_damage > 0) html += `<p style="color: var(--lcars-tomato);">Hull Damage: ${data.hull_damage}</p>`;
                html += `<p>Target Shields: ${data.target_shields_remaining}</p>`;

                if (data.breaches_caused > 0) {
                    html += `<div class="info-box danger" style="margin-top: 10px;">`;
                    html += `<p style="font-weight: bold;">${data.breaches_caused} BREACH(ES) CAUSED!</p>`;
                    html += `<p>Systems hit: ${data.systems_hit.map(s => s.toUpperCase()).join(', ')}</p>`;
                    html += `</div>`;
                }

                html += `</div>`;

                if (data.momentum_generated > 0) {
                    html += `<p style="color: var(--lcars-ice);">+${data.momentum_generated} Momentum generated</p>`;
                    document.getElementById('momentum').textContent = data.new_momentum;
                }

                updateEnemyShipDisplay(targetIndex, data);
            } else {
                html += `<div class="info-box danger"><strong>MISS!</strong></div>`;
            }

            resultsDiv.innerHTML = html;
        }

        async function rerollDie(dieIndex) {
            if (!lastFireData) {
                showErrorToast('No previous roll to re-roll!');
                return;
            }

            const response = await fetch('/api/fire', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    ...lastFireData,
                    reroll_die_index: dieIndex,
                    previous_rolls: lastFireData.previous_rolls,
                    character_id: playerCharId
                })
            });
            const data = await response.json();
            displayFireResults(data, lastFireData.targetIndex, lastFireData.focus, lastFireData.bonusDice, lastFireData.difficulty);
        }

        function updateEnemyShipDisplay(targetIndex, data) {
            const enemyItems = document.querySelectorAll('.enemy-ship-item');
            if (enemyItems[targetIndex]) {
                const item = enemyItems[targetIndex];
                const shieldsSpan = item.querySelector('.enemy-shields');
                const shieldsBar = item.querySelector('.enemy-shields-bar');
                if (shieldsSpan && data.target_shields_remaining !== undefined) {
                    const maxShields = parseInt(shieldsSpan.textContent.split('/')[1]);
                    shieldsSpan.textContent = `${data.target_shields_remaining} / ${maxShields}`;
                    shieldsBar.style.width = `${(data.target_shields_remaining / maxShields) * 100}%`;
                }
            }
        }

        // ========== DEFENSIVE FIRE FUNCTIONS ==========

        function updateDefensiveFireMomentumWarning() {
            const currentMomentum = parseInt(document.getElementById('momentum').textContent) || 0;
            const warningDiv = document.getElementById('defensive-fire-momentum-warning');
            document.getElementById('df-current-momentum').textContent = currentMomentum;
            warningDiv.style.display = currentMomentum <= 3 ? 'block' : 'none';
        }

        async function executeDefensiveFire() {
            if (currentTurn !== 'player') {
                showErrorToast("It's not your turn!");
                return;
            }

            const weaponSelect = document.getElementById('defensive-fire-weapon-select');
            const weaponIndex = parseInt(weaponSelect.value);
            const weaponName = weaponSelect.options[weaponSelect.selectedIndex].text;
            const resultsDiv = document.getElementById('defensive-fire-results');

            try {
                const response = await fetch(`/api/encounter/${encounterId}/execute-action`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action_name: 'Defensive Fire',
                        weapon_index: weaponIndex,
                        role: 'player',
                        character_id: playerCharId,
                        player_id: myPlayerId
                    })
                });
                const data = await response.json();

                resultsDiv.style.display = 'block';

                if (data.success) {
                    resultsDiv.innerHTML = `
                        <div class="info-box" style="background: rgba(153, 102, 204, 0.15); border-color: var(--lcars-african-violet);">
                            <strong style="color: var(--lcars-african-violet);">DEFENSIVE FIRE ACTIVATED!</strong><br><br>
                            <div style="color: var(--lcars-almond);">
                                ${data.message}<br><br>
                                <strong>Weapon:</strong> ${data.weapon_name || weaponName}<br>
                                <strong>Duration:</strong> Until your next turn
                            </div>
                        </div>
                    `;
                    showSuccessToast('Defensive Fire activated!');
                    selectedMajorAction = 'Defensive Fire';
                    updateSelectionSummary();
                    if (data.turn_ended) fetchTurnStatus();
                } else {
                    resultsDiv.innerHTML = `<div class="info-box danger"><strong>ERROR:</strong> ${data.error}</div>`;
                    showErrorToast(data.error);
                }
            } catch (err) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = `<div class="info-box danger"><strong>ERROR:</strong> ${err.message}</div>`;
                showErrorToast('Failed to activate Defensive Fire');
            }
        }

        // Reroute Power
        function updateRerouteTargetDisplay() {
            const select = document.getElementById('reroute-system-select');
            const display = document.getElementById('reroute-target-display');
            display.textContent = select.value.toUpperCase();
        }

        async function executeReroutePower() {
            const system = document.getElementById('reroute-system-select').value;
            const response = await fetch(`/api/encounter/${encounterId}/execute-action`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    action_name: 'Reroute Power',
                    character_id: playerCharId,
                    target_system: system,
                    player_id: myPlayerId
                })
            });
            const data = await response.json();
            if (data.success) {
                hasReservePower = false;
                updateReservePowerDisplay();
                showSuccessToast(`Power rerouted to ${system.toUpperCase()}`);

                // Log this major action
                logTurnAction(
                    'Reroute Power',
                    'major',
                    `Power rerouted to <strong>${system.toUpperCase()}</strong>. Next action using this system gets <strong>-1 Difficulty</strong>.`,
                    true
                );

                fetchTurnStatus();
            } else {
                showErrorToast(data.error || 'Failed to reroute power');
            }
        }

        function updateReservePowerDisplay() {
            const statusEl = document.getElementById('reserve-power-status');
            const container = document.getElementById('reserve-power-box');
            if (hasReservePower) {
                statusEl.textContent = 'AVAILABLE';
                statusEl.style.color = 'var(--lcars-success)';
                if (container) {
                    container.style.background = '#1a3a1a';
                    container.style.borderColor = 'var(--lcars-success)';
                    const label = container.querySelector('span:first-child');
                    if (label) label.style.color = 'var(--lcars-success)';
                }
            } else {
                statusEl.textContent = 'DEPLETED';
                statusEl.style.color = 'var(--lcars-tomato)';
                if (container) {
                    container.style.background = '#3a1a1a';
                    container.style.borderColor = 'var(--lcars-tomato)';
                    const label = container.querySelector('span:first-child');
                    if (label) label.style.color = 'var(--lcars-tomato)';
                }
            }
        }

        // Change Position
        async function executeChangePosition() {
            const newPosition = document.getElementById('change-position-select').value;
            const currentPosition = '{{ position.value }}';

            if (newPosition === currentPosition) {
                showErrorToast("You are already at that position!");
                return;
            }

            const resultsDiv = document.getElementById('change-position-results');
            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = '<div class="info-box">Processing...</div>';

            try {
                const response = await fetch(`/api/encounter/${encounterId}/execute-action`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action_name: 'Change Position',
                        character_id: playerCharId,
                        new_position: newPosition,
                        player_id: myPlayerId
                    })
                });
                const data = await response.json();

                if (data.success) {
                    const currentPos = '{{ position.value }}'.toUpperCase();
                    resultsDiv.innerHTML = `
                        <div class="info-box success">
                            <strong>Position change queued!</strong><br>
                            You will move to <strong>${newPosition.toUpperCase()}</strong> at the start of your next turn.
                        </div>
                        <div class="info-box warning" style="margin-top: 10px;">
                            <strong>You may still take one Major Action from ${currentPos} before your turn ends.</strong>
                        </div>
                    `;
                    showSuccessToast(`Will move to ${newPosition.toUpperCase()} next turn - take a Major Action!`);

                    // Hide the position select and buttons since action is complete
                    document.getElementById('change-position-select-container').style.display = 'none';
                    document.getElementById('change-position-buttons').style.display = 'none';

                    // Show pending position notice
                    const pendingNotice = document.getElementById('pending-position-notice');
                    const pendingDisplay = document.getElementById('pending-position-display');
                    pendingNotice.style.display = 'block';
                    pendingDisplay.textContent = `You will move to ${newPosition.toUpperCase()} at the start of your next turn.`;

                    // Log this minor action
                    selectedMinorAction = 'Change Position';
                    logTurnAction(
                        'Change Position',
                        'minor',
                        `Position change queued to <strong>${newPosition.toUpperCase()}</strong>. You may still take a Major Action from ${currentPos}.`,
                        true
                    );
                    updateSelectionSummary();
                    updateLastActionResults();

                    fetchTurnStatus();
                } else {
                    resultsDiv.innerHTML = `<div class="info-box danger">${data.error || 'Failed'}</div>`;
                    showErrorToast(data.error || 'Failed to change position');
                }
            } catch (err) {
                resultsDiv.innerHTML = `<div class="info-box danger">Error: ${err.message}</div>`;
                showErrorToast('Error: ' + err.message);
            }
        }

        // Override
        // Data for override actions - fetched dynamically
        const overrideActions = {
            helm: ['Attack Pattern', 'Evasive Action', 'Maneuver', 'Ram', 'Warp'],
            tactical: ['Fire', 'Modulate Shields', 'Defensive Fire'],
            operations: ['Damage Control', 'Regain Power', 'Regenerate Shields', 'Reroute Power', 'Transport'],
            engineering: ['Damage Control', 'Regain Power', 'Regenerate Shields', 'Reroute Power'],
            science: ['Reveal', 'Scan For Weakness', 'Sensor Sweep'],
            medical: ['Treat Injuries', 'Coordinate Response'],
            captain: ['Direct', 'Rally']
        };

        let overrideTargetStation = null;
        let overrideTargetAction = null;
        let overrideActionConfig = null;

        function updateOverrideActions() {
            const station = document.getElementById('override-station-select').value;
            const actionContainer = document.getElementById('override-action-container');
            const actionSelect = document.getElementById('override-action-select');
            const detailsDiv = document.getElementById('override-details');
            const executeBtn = document.getElementById('override-execute-btn');

            if (!station) {
                actionContainer.style.display = 'none';
                detailsDiv.style.display = 'none';
                executeBtn.disabled = true;
                executeBtn.textContent = 'SELECT ACTION FIRST';
                return;
            }

            overrideTargetStation = station;
            actionContainer.style.display = 'block';

            // Populate actions for selected station
            const actions = overrideActions[station] || [];
            actionSelect.innerHTML = '<option value="">-- Select Action --</option>';
            actions.forEach(action => {
                const option = document.createElement('option');
                option.value = action;
                option.textContent = action;
                actionSelect.appendChild(option);
            });

            detailsDiv.style.display = 'none';
            executeBtn.disabled = true;
            executeBtn.textContent = 'SELECT ACTION FIRST';
        }

        async function updateOverrideDetails() {
            const actionName = document.getElementById('override-action-select').value;
            const detailsDiv = document.getElementById('override-details');
            const executeBtn = document.getElementById('override-execute-btn');

            if (!actionName) {
                detailsDiv.style.display = 'none';
                executeBtn.disabled = true;
                executeBtn.textContent = 'SELECT ACTION FIRST';
                return;
            }

            overrideTargetAction = actionName;

            // Fetch action config
            try {
                const response = await fetch(`/api/action-config/${encodeURIComponent(actionName)}`);
                overrideActionConfig = await response.json();

                const baseDiff = (overrideActionConfig.roll?.difficulty) || 0;
                document.getElementById('override-action-display').textContent = actionName;
                document.getElementById('override-base-diff').textContent = baseDiff;
                document.getElementById('override-total-diff').textContent = baseDiff + 1;

                detailsDiv.style.display = 'block';
                executeBtn.disabled = false;
                executeBtn.textContent = 'EXECUTE OVERRIDE';
            } catch (err) {
                console.error('Failed to fetch action config:', err);
                detailsDiv.style.display = 'none';
                executeBtn.disabled = true;
            }
        }

        function showOverrideDicePanel() {
            if (!overrideTargetAction || !overrideActionConfig) {
                showErrorToast('Select an action first!');
                return;
            }

            // Set up dice panel for the override action with +1 difficulty
            const config = overrideActionConfig;
            let difficulty = 1; // Default

            if (config.roll) {
                difficulty = (config.roll.difficulty || 1) + 1; // +1 for Override
            }

            currentAction = {name: 'Override', type: 'major', difficulty: difficulty};
            currentActionConfig = config;

            // Setup dice panel
            setupDicePanel(config, difficulty);

            // Update the display
            document.getElementById('current-action-display').style.display = 'block';
            document.getElementById('current-action-name').textContent = `Override: ${overrideTargetAction} (+1 Diff)`;

            // Store override info for when the roll is executed
            window.overrideData = {
                target_station: overrideTargetStation,
                target_action: overrideTargetAction
            };

            showPanel('dice-panel');
        }

        // Damage Control
        let damageControlTargetSystem = null;

        function populateDamageControlOptions() {
            const select = document.getElementById('damage-control-system-select');
            const noBreachWarning = document.getElementById('damage-control-no-breach-warning');
            const systemSection = document.getElementById('damage-control-system-section');

            const breachedSystems = [];
            document.querySelectorAll('.stat-row.breached').forEach(row => {
                const system = row.getAttribute('data-system');
                const breachCount = row.querySelector('.breach-count');
                const potency = breachCount ? parseInt(breachCount.textContent) || 1 : 1;
                if (system) breachedSystems.push({ system, potency });
            });

            select.innerHTML = '';
            if (breachedSystems.length === 0) {
                noBreachWarning.style.display = 'block';
                systemSection.style.display = 'none';
                damageControlTargetSystem = null;
                return;
            }

            noBreachWarning.style.display = 'none';
            systemSection.style.display = 'block';

            breachedSystems.forEach(({ system, potency }) => {
                const option = document.createElement('option');
                option.value = system;
                option.textContent = `${system.toUpperCase()} - Breach Potency ${potency}`;
                option.dataset.potency = potency;
                select.appendChild(option);
            });

            damageControlTargetSystem = breachedSystems[0].system;
            updateDamageControlDisplay();
        }

        function updateDamageControlDisplay() {
            const select = document.getElementById('damage-control-system-select');
            const selectedOption = select.options[select.selectedIndex];
            const potency = selectedOption ? parseInt(selectedOption.dataset.potency) || 0 : 0;

            document.getElementById('damage-control-breach-potency').textContent = potency;
            document.getElementById('damage-control-total-difficulty').textContent = 2 + potency;
            damageControlTargetSystem = select.value;
        }

        async function executeDamageControlRoll() {
            if (currentTurn !== 'player') {
                showErrorToast("It's not your turn!");
                return;
            }

            if (!damageControlTargetSystem) {
                showErrorToast("No system selected for repair!");
                return;
            }

            const select = document.getElementById('damage-control-system-select');
            const selectedOption = select.options[select.selectedIndex];
            const potency = selectedOption ? parseInt(selectedOption.dataset.potency) || 0 : 0;
            const difficulty = 2 + potency;
            const focus = document.getElementById('damage-control-focus').checked;
            const bonus = parseInt(document.getElementById('damage-control-bonus').value) || 0;
            const attr = playerAttrs.presence;
            const disc = playerDiscs.engineering;
            const resultsDiv = document.getElementById('damage-control-results');

            try {
                // First do the roll
                const rollResponse = await fetch('/api/roll', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        attribute: attr,
                        discipline: disc,
                        difficulty: difficulty,
                        bonus_dice: bonus,
                        focus: focus
                    })
                });
                const rollData = await rollResponse.json();

                resultsDiv.style.display = 'block';

                const diceHtml = rollData.rolls.map((roll, index) => {
                    let cls = 'dice-fail';
                    if (roll === 1 || (focus && roll <= disc)) cls = 'dice-crit';
                    else if (roll <= rollData.target_number) cls = 'dice-success';
                    else if (roll === 20) cls = 'dice-complication';
                    return `<span class="dice-result ${cls}">${roll}</span>`;
                }).join('');

                if (rollData.succeeded) {
                    // Success - execute the actual repair
                    const repairResponse = await fetch(`/api/encounter/${encounterId}/execute-action`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            action_name: 'Damage Control',
                            roll_succeeded: true,
                            roll_successes: rollData.successes,
                            roll_momentum: rollData.momentum_generated,
                            roll_complications: rollData.complications,
                            roll_dice: rollData.rolls,
                            roll_target: rollData.target_number,
                            target_system: damageControlTargetSystem,
                            bonus_dice: bonus,
                            character_id: playerCharId,
                            player_id: myPlayerId
                        })
                    });
                    const repairData = await repairResponse.json();

                    resultsDiv.innerHTML = `
                        <div class="info-box success">
                            <strong>REPAIR SUCCESSFUL!</strong>
                            <div style="margin: 10px 0;">${diceHtml}</div>
                            <p>${rollData.successes} successes vs Difficulty ${difficulty}</p>
                            <p>${repairData.message}</p>
                            ${rollData.momentum_generated > 0 ? `<p style="color: var(--lcars-ice);">+${rollData.momentum_generated} Momentum</p>` : ''}
                        </div>
                    `;

                    showSuccessToast(`${damageControlTargetSystem.toUpperCase()} repaired!`);

                    if (repairData.new_momentum !== undefined) {
                        document.getElementById('momentum').textContent = repairData.new_momentum;
                    }

                    if (repairData.current_turn) {
                        fetchTurnStatus();
                        activeMinorAction = null;
                        selectedMajorAction = null;
                        clearActionSelections('minor');
                        clearActionSelections('major');
                    }
                } else {
                    // Failed
                    resultsDiv.innerHTML = `
                        <div class="info-box danger">
                            <strong>REPAIR FAILED!</strong>
                            <div style="margin: 10px 0;">${diceHtml}</div>
                            <p>${rollData.successes} successes vs Difficulty ${difficulty}</p>
                            ${rollData.complications > 0 ? `<p>${rollData.complications} complication(s)!</p>` : ''}
                        </div>
                    `;

                    showErrorToast("Damage Control failed!");

                    // Log the failed action
                    const failResponse = await fetch(`/api/encounter/${encounterId}/execute-action`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            action_name: 'Damage Control',
                            roll_succeeded: false,
                            roll_successes: rollData.successes,
                            roll_complications: rollData.complications,
                            target_system: damageControlTargetSystem,
                            character_id: playerCharId,
                            player_id: myPlayerId
                        })
                    });
                    const failData = await failResponse.json();

                    if (failData.current_turn) {
                        fetchTurnStatus();
                        activeMinorAction = null;
                        selectedMajorAction = null;
                        clearActionSelections('minor');
                        clearActionSelections('major');
                    }
                }
            } catch (err) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = `<div class="info-box danger"><strong>ERROR:</strong> ${err.message}</div>`;
            }
        }

        // ========== RAM ACTION FUNCTIONS ==========

        function updateRamDamageDisplay() {
            const select = document.getElementById('ram-target-select');
            const selectedOption = select.options[select.selectedIndex];
            if (selectedOption) {
                const targetScale = selectedOption.dataset.scale;
                document.getElementById('ram-their-damage').textContent = targetScale;
            }
        }

        async function executeRamAction() {
            if (currentTurn !== 'player') {
                showErrorToast("It's not your turn!");
                return;
            }

            const targetIndex = parseInt(document.getElementById('ram-target-select').value);
            const focus = document.getElementById('ram-focus').checked;
            const bonusDice = parseInt(document.getElementById('ram-bonus').value) || 0;
            const resultsDiv = document.getElementById('ram-results');

            // Validate range - Ram requires Close range (same hex)
            const enemies = getVisibleEnemies();
            const targetEnemy = enemies[targetIndex];
            if (targetEnemy) {
                const playerPos = getPlayerPosition();
                const targetDistance = hexDistance(playerPos, targetEnemy.position);
                if (targetDistance > 0) {
                    const rangeCategory = getRangeCategory(targetDistance);
                    showErrorToast(`Ram requires Close range (same hex). Target is at ${rangeCategory} range (${targetDistance} hex${targetDistance !== 1 ? 'es' : ''} away).`);
                    resultsDiv.style.display = 'block';
                    resultsDiv.innerHTML = `<div class="info-box danger"><strong>OUT OF RANGE:</strong> Ram requires Close range (same hex). Target is at ${rangeCategory} range (${targetDistance} hex${targetDistance !== 1 ? 'es' : ''} away).</div>`;
                    return;
                }
            }

            try {
                const response = await fetch(`/api/encounter/${encounterId}/ram`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        target_index: targetIndex,
                        attribute: playerAttrs.daring,
                        discipline: playerDiscs.conn,
                        difficulty: 2,
                        focus: focus,
                        bonus_dice: bonusDice,
                        character_id: playerCharId,
                        player_id: myPlayerId
                    })
                });
                const data = await response.json();

                resultsDiv.style.display = 'block';

                if (data.error) {
                    resultsDiv.innerHTML = `<div class="info-box danger"><strong>ERROR:</strong> ${data.error}</div>`;
                    showErrorToast(data.error);
                    return;
                }

                const diceHtml = data.rolls.map((roll, index) => {
                    let cls = 'dice-fail';
                    if (roll === 1 || (focus && roll <= playerDiscs.conn)) cls = 'dice-crit';
                    else if (roll <= data.target_number) cls = 'dice-success';
                    else if (roll === 20) cls = 'dice-complication';
                    return `<span class="dice-result ${cls}">${roll}</span>`;
                }).join('');

                if (data.succeeded) {
                    resultsDiv.innerHTML = `
                        <div class="info-box" style="background: rgba(255, 153, 0, 0.15); border-color: var(--lcars-orange);">
                            <strong style="color: var(--lcars-orange);">COLLISION!</strong>
                            <div style="margin: 10px 0;">${diceHtml}</div>
                            <p>${data.successes} successes vs Difficulty 2</p>
                            <div style="margin-top: 15px;">
                                <p><strong>Damage to Target:</strong> ${data.target_damage} (Piercing)</p>
                                <p><strong>Damage to You:</strong> ${data.self_damage} (Piercing)</p>
                            </div>
                            ${data.target_breaches > 0 ? `<p style="color: var(--lcars-tomato);">Target took ${data.target_breaches} breach(es)!</p>` : ''}
                            ${data.self_breaches > 0 ? `<p style="color: var(--lcars-tomato);">You took ${data.self_breaches} breach(es)!</p>` : ''}
                        </div>
                    `;
                    showSuccessToast('Ram successful!');
                } else {
                    resultsDiv.innerHTML = `
                        <div class="info-box danger">
                            <strong>RAM FAILED!</strong>
                            <div style="margin: 10px 0;">${diceHtml}</div>
                            <p>${data.successes} successes vs Difficulty 2</p>
                            <p style="color: var(--lcars-almond);">You missed the target - no collision damage.</p>
                        </div>
                    `;
                    showErrorToast('Ram missed!');
                }

                if (data.current_turn) {
                    fetchTurnStatus();
                    activeMinorAction = null;
                    selectedMajorAction = null;
                    clearActionSelections('minor');
                    clearActionSelections('major');
                }

            } catch (err) {
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = `<div class="info-box danger"><strong>ERROR:</strong> ${err.message}</div>`;
            }
        }

        // ========== THRUSTERS FUNCTIONS ==========

        async function showThrustersPanel() {
            hideAllActionPanels();
            document.getElementById('thrusters-panel').style.display = 'block';
            document.getElementById('thrusters-results').style.display = 'none';
            document.getElementById('thrusters-panel').scrollIntoView({behavior: 'smooth'});

            try {
                const response = await fetch(`/api/encounter/${encounterId}/move/thrusters/valid-actions?ship_id=player`);
                if (!response.ok) {
                    showErrorToast('Failed to load thrusters actions');
                    return;
                }

                const data = await response.json();
                const container = document.getElementById('thrusters-actions-container');
                const noActionsDiv = document.getElementById('thrusters-no-actions');

                if (data.valid_actions.length === 0) {
                    container.style.display = 'none';
                    noActionsDiv.style.display = 'block';
                } else {
                    container.style.display = 'block';
                    noActionsDiv.style.display = 'none';

                    let html = '';
                    if (data.currently_in_contact) {
                        html += `<div class="info-box success" style="margin-bottom: 15px;">
                            <p style="margin: 0;"><strong>CURRENTLY IN CONTACT</strong> with ${data.currently_in_contact}</p>
                        </div>`;
                    }

                    html += '<div style="display: flex; flex-direction: column; gap: 10px;">';
                    for (const action of data.valid_actions) {
                        const btnColor = action.type === 'enter_contact' ? 'var(--lcars-bluey)' : 'var(--lcars-orange)';
                        const actionLabel = action.type === 'enter_contact'
                            ? `Dock with ${action.target}`
                            : `Undock from ${action.target}`;
                        const escapedTarget = action.target.replace(/'/g, "\\'").replace(/"/g, '\\"');
                        html += `
                            <button class="btn" onclick="executeThrustersAction('${action.type}', '${escapedTarget}')"
                                    style="background: ${btnColor}; text-align: left; padding: 15px;">
                                <strong>${actionLabel}</strong>
                            </button>
                        `;
                    }
                    html += '</div>';
                    container.innerHTML = html;
                }

            } catch (error) {
                console.error('Error loading thrusters actions:', error);
                showErrorToast('Failed to load thrusters actions');
            }
        }

        async function executeThrustersAction(actionType, targetShip) {
            try {
                const response = await fetch(`/api/encounter/${encounterId}/move/thrusters`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        action_type: actionType,
                        target_ship: targetShip,
                        ship_id: 'player'
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    showErrorToast(data.error || 'Thrusters action failed');
                    return;
                }

                const resultsDiv = document.getElementById('thrusters-results');
                resultsDiv.style.display = 'block';
                resultsDiv.innerHTML = `
                    <div class="info-box success">
                        <p style="margin: 0;"><strong>SUCCESS!</strong></p>
                        <p style="margin: 10px 0 0 0;">${data.message}</p>
                    </div>
                `;

                showSuccessToast(data.message);

                // Log this minor action
                selectedMinorAction = 'Thrusters';
                logTurnAction('Thrusters', 'minor', data.message, true);
                updateSelectionSummary();
                updateLastActionResults();

                setTimeout(() => {
                    showThrustersPanel();
                }, 1500);

            } catch (error) {
                console.error('Error executing thrusters action:', error);
                showErrorToast('Failed to execute thrusters action');
            }
        }

        function cancelThrustersAction() {
            document.getElementById('thrusters-panel').style.display = 'none';
            clearActionSelections('minor');
        }

        // ========== IMPULSE MOVEMENT FUNCTIONS ==========

        let impulseMovementActive = false;
        let validMoveDestinations = [];

        async function startImpulseMovement() {
            try {
                const response = await fetch(`/api/encounter/${encounterId}/move/valid-destinations?action=impulse&ship_id=player`);
                if (!response.ok) {
                    showErrorToast('Failed to get movement destinations');
                    return;
                }

                const data = await response.json();
                validMoveDestinations = data.valid_moves;

                if (validMoveDestinations.length === 0) {
                    showInfoToast('No valid movement destinations available');
                    return;
                }

                impulseMovementActive = true;
                showInfoToast(`Impulse: Select a destination hex (${validMoveDestinations.length} options). Click again to cancel.`);

                // Show the inline impulse panel and render map there
                showPanel('impulse-panel');
                renderImpulseMap();

            } catch (error) {
                console.error('Error fetching valid moves:', error);
                showErrorToast('Error fetching movement options');
            }
        }

        function cancelImpulseMovement() {
            impulseMovementActive = false;
            validMoveDestinations = [];
            document.getElementById('impulse-panel').style.display = 'none';
            renderTacticalMap();
            showInfoToast('Movement cancelled');
        }

        async function executeImpulseMove(q, r, cost) {
            try {
                const currentMomentum = parseInt(document.getElementById('momentum').textContent) || 0;

                let useThreat = false;
                if (cost > currentMomentum) {
                    if (cost > 0) {
                        useThreat = confirm(`Not enough Momentum (need ${cost}, have ${currentMomentum}). Add ${cost} Threat instead?`);
                        if (!useThreat) {
                            showErrorToast('Movement cancelled - insufficient Momentum');
                            return;
                        }
                    }
                }

                const response = await fetch(`/api/encounter/${encounterId}/move/impulse`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        q: q,
                        r: r,
                        use_threat: useThreat,
                        ship_id: 'player'
                    })
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    showErrorToast(data.error || 'Movement failed');
                    return;
                }

                shipPositions = data.ship_positions;
                document.getElementById('momentum').textContent = data.momentum;
                document.getElementById('threat').textContent = data.threat;

                let message = `Moved to (${q}, ${r})`;
                if (data.momentum_spent > 0) message += ` - spent ${data.momentum_spent} Momentum`;
                if (data.threat_added > 0) message += ` - added ${data.threat_added} Threat`;
                if (data.hazard_damage > 0) {
                    message += ` - ${data.hazard_damage}CD hazard damage!`;
                    showErrorToast(`Hazardous terrain! Roll ${data.hazard_damage} Challenge Dice for damage.`);
                }
                showSuccessToast(message);

                impulseMovementActive = false;
                validMoveDestinations = [];
                document.getElementById('impulse-panel').style.display = 'none';
                renderTacticalMap();

                selectedMinorAction = 'Impulse';
                logTurnAction('Impulse', 'minor', message, true);
                updateSelectionSummary();
                updateLastActionResults();

            } catch (error) {
                console.error('Error executing impulse move:', error);
                showErrorToast('Error executing movement');
            }
        }

        function renderTacticalMapWithMoves() {
            if (typeof HexMap !== 'undefined') {
                HexMap.render('tactical-map-container', tacticalMapData, shipPositions, {
                    editable: false,
                    showCoords: false,
                    validMoves: validMoveDestinations,
                    onShipClick: function(ship, index) {
                        if (ship.id === 'player' && impulseMovementActive) {
                            cancelImpulseMovement();
                        }
                    },
                    onHexClick: function(q, r, terrain, moveCost) {
                        if (!impulseMovementActive) return;
                        const move = validMoveDestinations.find(m => m.q === q && m.r === r);
                        if (move) {
                            executeImpulseMove(q, r, move.cost);
                        } else {
                            cancelImpulseMovement();
                        }
                    }
                });
            }
        }

        // Render the impulse map in the inline panel
        function renderImpulseMap() {
            if (typeof HexMap !== 'undefined') {
                HexMap.render('impulse-map-container', tacticalMapData, shipPositions, {
                    editable: false,
                    showCoords: false,
                    validMoves: validMoveDestinations,
                    onShipClick: function(ship, index) {
                        if (ship.id === 'player' && impulseMovementActive) {
                            cancelImpulseMovement();
                        }
                    },
                    onHexClick: function(q, r, terrain, moveCost) {
                        if (!impulseMovementActive) return;
                        const move = validMoveDestinations.find(m => m.q === q && m.r === r);
                        if (move) {
                            executeImpulseMove(q, r, move.cost);
                        } else {
                            cancelImpulseMovement();
                        }
                    }
                });
            }
        }

        // ========== GENERIC DICE ROLLER ==========

        async function rollDice() {
            if (currentTurn !== 'player') {
                showErrorToast("It's not your turn!");
                return;
            }

            const attr = parseInt(document.getElementById('roll-attr').value);
            const disc = parseInt(document.getElementById('roll-disc').value);
            const diff = parseInt(document.getElementById('roll-diff').value);
            const bonus = parseInt(document.getElementById('roll-bonus').value) || 0;
            const focus = document.getElementById('roll-focus').checked;

            const hasShipAssist = currentActionConfig?.roll?.ship_assist_system && currentActionConfig?.roll?.ship_assist_department;

            let response;
            if (hasShipAssist) {
                const sysName = currentActionConfig.roll.ship_assist_system;
                const deptName = currentActionConfig.roll.ship_assist_department;
                const sysValue = shipSystems[sysName] || 7;
                const deptValue = shipDepts[deptName] || 2;

                response = await fetch('/api/roll-assisted', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        attribute: attr,
                        discipline: disc,
                        system: sysValue,
                        department: deptValue,
                        difficulty: diff,
                        bonus_dice: bonus,
                        focus: focus
                    })
                });
            } else {
                response = await fetch('/api/roll', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        attribute: attr,
                        discipline: disc,
                        difficulty: diff,
                        bonus_dice: bonus,
                        focus: focus
                    })
                });
            }
            const data = await response.json();

            document.getElementById('dice-results').style.display = 'block';

            const charDiceCount = hasShipAssist ? data.rolls.length - 1 : data.rolls.length;
            const shipAssistTarget = hasShipAssist ?
                (shipSystems[currentActionConfig.roll.ship_assist_system] || 7) + (shipDepts[currentActionConfig.roll.ship_assist_department] || 2) : 0;

            const diceDisplay = document.getElementById('dice-display');
            diceDisplay.innerHTML = data.rolls.map((roll, index) => {
                const isShipDie = hasShipAssist && index === data.rolls.length - 1;
                const targetNum = isShipDie ? shipAssistTarget : data.target_number;

                let cls = 'dice-fail';
                if (roll === 1) cls = 'dice-crit';
                else if (!isShipDie && focus && roll <= disc) cls = 'dice-crit';
                else if (roll <= targetNum) cls = 'dice-success';
                else if (roll === 20) cls = 'dice-complication';

                const label = isShipDie ? '<span style="font-size: 0.7em; display: block; color: var(--lcars-almond);">Ship</span>' : '';
                return `<span class="dice-result ${cls}">${roll}${label}</span>`;
            }).join('');

            const summary = document.getElementById('dice-summary');
            const resultClass = data.succeeded ? 'success' : 'danger';

            let effectMessage = '';

            if (currentAction?.name) {
                try {
                    // Build the request body
                    const execBody = {
                        action_name: currentAction.name,
                        attribute: attr,
                        discipline: disc,
                        difficulty: diff,
                        focus: focus,
                        bonus_dice: bonus,
                        roll_succeeded: data.succeeded,
                        roll_successes: data.successes,
                        roll_momentum: data.succeeded ? data.momentum_generated : 0,
                        roll_complications: data.complications,
                        roll_dice: data.rolls,
                        roll_target: data.target_number,
                        character_id: playerCharId,
                        player_id: myPlayerId
                    };

                    // Add Override-specific data if this is an Override action
                    if (currentAction.name === 'Override' && window.overrideData) {
                        execBody.target_station = window.overrideData.target_station;
                        execBody.target_action = window.overrideData.target_action;
                    }

                    const execResponse = await fetch(`/api/encounter/${encounterId}/execute-action`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(execBody)
                    });
                    const execData = await execResponse.json();

                    if (execData.new_momentum !== undefined) {
                        document.getElementById('momentum').textContent = execData.new_momentum;
                    }

                    if (data.succeeded && execData.success) {
                        if (execData.message && execData.message !== `${currentAction.name} succeeded!`) {
                            effectMessage = `<br><span style="color: var(--lcars-almond);">${execData.message}</span>`;
                        }
                        if (execData.effect_applied) {
                            effectMessage += `<br><span style="color: var(--lcars-success);">Effect applied: ${execData.effect_applied}</span>`;
                        }
                        if (execData.resistance_bonus) {
                            currentResistanceBonus += execData.resistance_bonus;
                            updateResistanceDisplay();
                        }
                    }

                    if (currentAction && currentAction.type === 'major') {
                        if (execData.current_turn) {
                            // Log this major action with dice results
                            const actionSummary = data.succeeded
                                ? `<strong style="color: var(--lcars-success);">SUCCESS</strong> - ${data.successes} successes vs Difficulty ${data.difficulty}${data.momentum_generated > 0 ? ` (+${data.momentum_generated} Momentum)` : ''}`
                                : `<strong style="color: var(--lcars-tomato);">FAILED</strong> - ${data.successes} successes vs Difficulty ${data.difficulty}`;
                            logTurnAction(
                                currentAction.name,
                                'major',
                                actionSummary + (effectMessage ? `<br>${effectMessage}` : ''),
                                data.succeeded,
                                { rolls: data.rolls, target: data.target_number }
                            );

                            fetchTurnStatus();
                            activeMinorAction = null;
                            selectedMajorAction = null;
                            updateFireMinorActionBanner();
                            updateMajorActionHighlights();
                            updateSelectionSummary();
                            clearActionSelections('minor');
                            clearActionSelections('major');
                        }
                    }
                } catch (err) {
                    console.error('Failed to execute action:', err);
                }
            }

            let momentumDisplay = '';
            if (data.succeeded) {
                if (data.momentum_generated > 0) {
                    momentumDisplay = `<span style="color: var(--lcars-ice);">+${data.momentum_generated} Momentum generated</span>`;
                } else {
                    momentumDisplay = `<span style="color: #888;">(No extra momentum - just met difficulty)</span>`;
                }
            }

            summary.innerHTML = `
                <div class="info-box ${resultClass}">
                    <strong>${data.succeeded ? 'SUCCESS!' : 'FAILURE'}</strong><br>
                    ${data.successes} successes vs Difficulty ${data.difficulty}<br>
                    ${data.complications > 0 ? `<span style="color: var(--lcars-tomato);">${data.complications} complication(s)!</span><br>` : ''}
                    ${momentumDisplay}
                    ${effectMessage}
                </div>
            `;
        }

        // ========== PENDING ATTACK / DEFENSIVE ROLL HANDLING ==========

        let pendingAttackData = null;
        let defensiveRollData = null;

        function showPendingAttackPanel(attack) {
            pendingAttackData = attack;
            defensiveRollData = null;

            document.getElementById('incoming-attacker').textContent = attack.attacker_name;
            document.getElementById('incoming-weapon').textContent = attack.weapon_name;

            const defenderTarget = playerAttrs.daring + playerDiscs.security;
            const shipTarget = shipSystems.weapons + shipDepts.security;
            document.getElementById('incoming-defender-target').textContent = defenderTarget;
            document.getElementById('incoming-ship-target').textContent = shipTarget;

            document.getElementById('incoming-roll-results').style.display = 'none';
            document.getElementById('incoming-attack-resolution').style.display = 'none';
            document.getElementById('incoming-attack-resolution').innerHTML = '';

            const panel = document.getElementById('incoming-attack-panel');
            panel.style.display = 'block';
            panel.scrollIntoView({behavior: 'smooth'});

            showErrorToast('INCOMING ATTACK! Roll your defensive dice!');
        }

        function hidePendingAttackPanel() {
            pendingAttackData = null;
            defensiveRollData = null;
            document.getElementById('incoming-attack-panel').style.display = 'none';
        }

        function rollDefensiveDice() {
            if (!pendingAttackData) return;

            const roll1 = Math.floor(Math.random() * 20) + 1;
            const roll2 = Math.floor(Math.random() * 20) + 1;
            const shipRoll = Math.floor(Math.random() * 20) + 1;

            const defenderTarget = playerAttrs.daring + playerDiscs.security;
            const shipTarget = shipSystems.weapons + shipDepts.security;

            let successes = 0;
            let complications = 0;

            [roll1, roll2].forEach(roll => {
                if (roll === 1) successes += 2;
                else if (roll <= defenderTarget) successes += 1;
                if (roll === 20) complications += 1;
            });

            if (shipRoll === 1) successes += 2;
            else if (shipRoll <= shipTarget) successes += 1;
            if (shipRoll === 20) complications += 1;

            defensiveRollData = {
                defender_rolls: [roll1, roll2],
                ship_assist_roll: shipRoll,
            };

            const formatRoll = (roll, target) => {
                if (roll === 1) return `<span style="color: var(--lcars-success); font-weight: bold;">1 (CRIT!)</span>`;
                if (roll === 20) return `<span style="color: var(--lcars-tomato); font-weight: bold;">20 (COMP!)</span>`;
                if (roll <= target) return `<span style="color: var(--lcars-success);">${roll}</span>`;
                return `<span style="color: #888;">${roll}</span>`;
            };

            const detailsDiv = document.getElementById('incoming-roll-details');
            detailsDiv.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>Character Rolls (Target ${defenderTarget}):</strong><br>
                    Die 1: ${formatRoll(roll1, defenderTarget)} | Die 2: ${formatRoll(roll2, defenderTarget)}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Ship Assist (Target ${shipTarget}):</strong><br>
                    Die: ${formatRoll(shipRoll, shipTarget)}
                </div>
                <div style="padding: 10px; background: #222; border-radius: 5px;">
                    <strong>Your Successes:</strong> <span style="color: var(--lcars-success); font-size: 1.2em;">${successes}</span>
                    ${complications > 0 ? `<br><span style="color: var(--lcars-tomato);">Complications: ${complications}</span>` : ''}
                </div>
            `;

            document.getElementById('incoming-roll-results').style.display = 'block';
        }

        async function submitDefensiveRoll() {
            if (!pendingAttackData || !defensiveRollData) {
                showErrorToast('Please roll your defensive dice first!');
                return;
            }

            try {
                const response = await fetch(`/api/encounter/${encounterId}/resolve-defensive-roll`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(defensiveRollData)
                });
                const data = await response.json();

                if (data.error) {
                    showErrorToast(data.error);
                    return;
                }

                const resolutionDiv = document.getElementById('incoming-attack-resolution');
                resolutionDiv.style.display = 'block';

                let html = `
                    <div class="info-box ${data.defender_wins ? 'success' : 'danger'}">
                        <h3 style="margin-top: 0;">
                            ${data.defender_wins ? 'DEFENSE SUCCESSFUL!' : 'ATTACK HITS!'}
                        </h3>
                        <div style="display: flex; gap: 30px; margin-bottom: 15px;">
                            <div><strong>Your Successes:</strong> ${data.defender_successes}</div>
                            <div><strong>Attacker Successes:</strong> ${data.attacker_successes}</div>
                        </div>
                `;

                if (data.defender_wins) {
                    html += `<p>${data.message}</p>`;

                    if (data.can_counterattack && data.current_momentum >= 2) {
                        html += `
                            <div style="margin-top: 15px; padding: 10px; background: #222; border-radius: 5px;">
                                <p style="color: var(--lcars-orange);">
                                    <strong>COUNTERATTACK AVAILABLE!</strong><br>
                                    Spend 2 Momentum to counterattack with ${data.counterattack_weapon}?
                                </p>
                                <button class="btn" onclick="executeCounterattack(${data.counterattack_weapon_index}, ${data.counterattack_target_index})" style="background: var(--lcars-orange);">
                                    COUNTERATTACK (2 Momentum)
                                </button>
                                <button class="btn btn-secondary" onclick="declineCounterattack()">
                                    Decline
                                </button>
                            </div>
                        `;
                    }
                } else {
                    html += `
                        <p>${data.message}</p>
                        <div style="margin-top: 10px;">
                            <strong>Damage Breakdown:</strong><br>
                            Base: ${data.base_damage} - Resistance: ${data.effective_resistance} = ${data.total_damage} damage<br>
                            Shield Damage: ${data.shield_damage} | Hull Damage: ${data.hull_damage}
                        </div>
                    `;
                    if (data.breaches_caused > 0) {
                        html += `<p style="color: var(--lcars-tomato);"><strong>BREACHES:</strong> ${data.systems_hit.join(', ').toUpperCase()}</p>`;
                    }
                }

                html += '</div>';
                resolutionDiv.innerHTML = html;

                if (data.breaches_caused > 0) {
                    fetchActionAvailability();
                }

                if (!data.can_counterattack || data.current_momentum < 2) {
                    setTimeout(() => {
                        hidePendingAttackPanel();
                    }, 5000);
                }

                pendingAttackData = null;

            } catch (err) {
                showErrorToast('Failed to submit defensive roll: ' + err.message);
            }
        }

        async function executeCounterattack(weaponIndex, targetIndex) {
            try {
                const response = await fetch(`/api/encounter/${encounterId}/counterattack`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        weapon_index: weaponIndex,
                        target_index: targetIndex,
                        character_id: playerCharId
                    })
                });
                const data = await response.json();

                const resolutionDiv = document.getElementById('incoming-attack-resolution');

                if (data.error) {
                    resolutionDiv.innerHTML += `<p style="color: var(--lcars-tomato);">Counterattack failed: ${data.error}</p>`;
                    return;
                }

                resolutionDiv.innerHTML += `
                    <div class="info-box" style="margin-top: 15px; background: rgba(153, 204, 255, 0.15); border-color: var(--lcars-ice);">
                        <h3 style="margin-top: 0; color: var(--lcars-orange);">COUNTERATTACK!</h3>
                        <p>${data.message}</p>
                        ${data.total_damage > 0 ? `<p style="color: var(--lcars-success);">Dealt ${data.total_damage} damage!</p>` : ''}
                    </div>
                `;

                document.getElementById('momentum').textContent = data.new_momentum;
                showSuccessToast('Counterattack executed!');

                setTimeout(() => {
                    hidePendingAttackPanel();
                }, 3000);

            } catch (err) {
                showErrorToast('Counterattack failed: ' + err.message);
            }
        }

        function declineCounterattack() {
            showInfoToast('Counterattack declined');
            hidePendingAttackPanel();
        }

        // Resistance display update
        function updateResistanceDisplay() {
            const el = document.getElementById('player-resistance');
            if (currentResistanceBonus > 0) {
                el.innerHTML = `${baseResistance} <span style="color: var(--lcars-success);">(+${currentResistanceBonus})</span>`;
            } else {
                el.innerHTML = `${baseResistance}`;
            }
        }

        // Turn management
        async function nextTurn() {
            const response = await fetch(`/api/encounter/${encounterId}/next-turn`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.current_turn) {
                fetchTurnStatus();
            }

            // Clear action state
            activeMinorAction = null;
            selectedMajorAction = null;
            updateFireMinorActionBanner();
            updateMajorActionHighlights();
            updateSelectionSummary();
            clearActionSelections('minor');
            clearActionSelections('major');
            hideAllActionPanels();
        }

        async function claimTurn() {
            if (!isMultiplayer || !myPlayerId) return;

            const response = await fetch(`/api/encounter/${encounterId}/claim-turn`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ player_id: myPlayerId })
            });
            const data = await response.json();

            if (data.success && data.confirmed) {
                currentPlayerId = myPlayerId;
                currentPlayerName = myPlayerName;
                clearLastActionResults();  // Clear previous turn's results
                updateActionPanelVisibility();
                showSuccessToast('Turn claimed! Take your action.');
                fetchTurnStatus();
            } else if (data.error) {
                showErrorToast(data.error);
            }
        }

        async function releaseTurn() {
            if (!isMultiplayer) return;

            const response = await fetch(`/api/encounter/${encounterId}/release-turn`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                currentPlayerId = null;
                currentPlayerName = '';
                updateActionPanelVisibility();
                showInfoToast('Turn released');
                fetchTurnStatus();
            }
        }

        // Fetch turn status (polling)
        async function fetchTurnStatus() {
            try {
                const response = await fetch(`/api/encounter/${encounterId}/status?role=player`);
                if (response.ok) {
                    const data = await response.json();
                    currentTurn = data.current_turn;
                    updateTurnDisplay(data);
                    updateActionPanelVisibility();

                    // Update turn counters
                    if (data.player_turns_used !== undefined) {
                        document.getElementById('player-turns-used').textContent = data.player_turns_used;
                        document.getElementById('player-turns-total').textContent = data.player_turns_total;
                    }
                    if (data.enemy_turns_used !== undefined) {
                        document.getElementById('enemy-turns-used').textContent = data.enemy_turns_used;
                        document.getElementById('enemy-turns-total').textContent = data.enemy_turns_total;
                    }

                    // Update resources
                    if (data.momentum !== undefined) {
                        document.getElementById('momentum').textContent = data.momentum;
                    }
                    if (data.threat !== undefined) {
                        document.getElementById('threat').textContent = data.threat;
                    }

                    // Update Reserve Power status if changed
                    if (data.has_reserve_power !== undefined && data.has_reserve_power !== hasReservePower) {
                        hasReservePower = data.has_reserve_power;
                        updateReservePowerDisplay();
                    }

                    // Check for pending attack that needs defensive roll
                    if (data.pending_attack && !pendingAttackData) {
                        showPendingAttackPanel(data.pending_attack);
                    } else if (!data.pending_attack && pendingAttackData) {
                        hidePendingAttackPanel();
                    }
                }
            } catch (e) {
                console.error('Failed to fetch turn status:', e);
            }
        }

        function updateTurnDisplay(data) {
            // Update global player tracking
            currentPlayerId = data.current_player_id || null;
            currentPlayerName = data.current_player_name || '';

            const banner = document.getElementById('turn-banner');
            const turnText = document.getElementById('turn-text');
            const turnInstruction = document.getElementById('turn-instruction');

            // Get UI elements - some may not exist depending on multiplayer mode
            // Note: end-turn-section removed - players must use "Pass" action to end turn
            const mpEndTurnSection = document.getElementById('mp-end-turn-section');
            const claimTurnSection = document.getElementById('claim-turn-section');
            const releaseTurnSection = document.getElementById('release-turn-section');
            const alreadyActedSection = document.getElementById('already-acted-section');

            if (data.current_turn === 'player') {
                banner.classList.remove('enemy-turn');

                if (isMultiplayer) {
                    // Check if current player has already acted this round
                    const hasActed = data.players_info?.find(p => p.player_id === myPlayerId)?.has_acted || false;

                    if (hasActed) {
                        // Player has already acted - waiting state
                        banner.classList.remove('your-turn');
                        banner.classList.add('waiting-turn');
                        turnText.textContent = 'WAITING';
                        turnInstruction.textContent = 'You have acted this round. Waiting for other crew members...';
                        if (claimTurnSection) claimTurnSection.style.display = 'none';
                        if (releaseTurnSection) releaseTurnSection.style.display = 'none';
                        if (mpEndTurnSection) mpEndTurnSection.style.display = 'none';
                        if (alreadyActedSection) alreadyActedSection.style.display = 'block';
                    } else if (data.current_player_id === myPlayerId) {
                        // This player's turn - active state
                        banner.classList.remove('waiting-turn');
                        banner.classList.add('your-turn');
                        turnText.textContent = 'YOUR TURN';
                        turnInstruction.textContent = 'Select a minor action (optional) then a major action to complete your turn.';
                        if (claimTurnSection) claimTurnSection.style.display = 'none';
                        if (releaseTurnSection) releaseTurnSection.style.display = 'block';
                        if (mpEndTurnSection) mpEndTurnSection.style.display = 'block';
                        if (alreadyActedSection) alreadyActedSection.style.display = 'none';
                    } else if (data.current_player_id) {
                        // Another player is acting - waiting state
                        banner.classList.remove('your-turn');
                        banner.classList.add('waiting-turn');
                        turnText.textContent = `${data.current_player_name || 'CREW MEMBER'}'S TURN`;
                        turnInstruction.textContent = `Waiting for ${data.current_player_name || 'another player'} to complete their action...`;
                        if (claimTurnSection) claimTurnSection.style.display = 'none';
                        if (releaseTurnSection) releaseTurnSection.style.display = 'none';
                        if (mpEndTurnSection) mpEndTurnSection.style.display = 'none';
                        if (alreadyActedSection) alreadyActedSection.style.display = 'none';
                    } else {
                        // No one has claimed - prompt to claim
                        banner.classList.remove('waiting-turn');
                        banner.classList.add('your-turn');
                        turnText.textContent = 'CREW TURN';
                        turnInstruction.textContent = "It's the crew's turn! Press CLAIM to take your action.";
                        if (claimTurnSection) claimTurnSection.style.display = 'block';
                        if (releaseTurnSection) releaseTurnSection.style.display = 'none';
                        if (mpEndTurnSection) mpEndTurnSection.style.display = 'none';
                        if (alreadyActedSection) alreadyActedSection.style.display = 'none';
                    }
                } else {
                    // Single player mode
                    banner.classList.add('your-turn');
                    turnText.textContent = 'YOUR TURN';
                    turnInstruction.textContent = 'Select a minor action (optional) then a major action to complete your turn.';
                }
            } else {
                // Enemy turn
                banner.classList.remove('your-turn');
                banner.classList.remove('waiting-turn');
                banner.classList.add('enemy-turn');
                turnText.textContent = 'ENEMY TURN';
                turnInstruction.textContent = 'The Game Master is controlling enemy ships. Stand by...';
                if (mpEndTurnSection) mpEndTurnSection.style.display = 'none';
                if (claimTurnSection) claimTurnSection.style.display = 'none';
                if (releaseTurnSection) releaseTurnSection.style.display = 'none';
                if (alreadyActedSection) alreadyActedSection.style.display = 'none';
            }

            // Update player status badges in multiplayer
            if (isMultiplayer && data.players_info) {
                data.players_info.forEach(player => {
                    const badge = document.querySelector(`.player-status-badge[data-player-id="${player.player_id}"]`);
                    if (badge) {
                        const isCurrent = data.current_player_id === player.player_id;
                        const hasActed = player.has_acted;
                        badge.style.background = hasActed ? 'var(--lcars-success)' : (isCurrent ? 'var(--lcars-african-violet)' : '#444');
                        badge.style.color = (hasActed || isCurrent) ? '#000' : '#ccc';
                        badge.textContent = player.name + (isCurrent ? ' (acting)' : (hasActed ? ' ‚úì' : ''));
                    }
                });
            }

            // Update round display
            if (data.round) {
                document.getElementById('round-display').textContent = `Round ${data.round}`;
            }
        }

        // Render tactical map
        function renderTacticalMap() {
            if (typeof HexMap !== 'undefined') {
                HexMap.render('tactical-map-container', tacticalMapData, shipPositions, {
                    role: role,
                    playerShipId: playerShipId
                });
            }
        }

        // ===== LCARS Data Cascade =====
        const lcarsColors = [
            'var(--lcars-tomato)',
            'var(--lcars-butterscotch)',
            'var(--lcars-ice)',
            'var(--lcars-african-violet)',
            'var(--lcars-orange)',
            'var(--lcars-bluey)',
            'var(--lcars-almond)',
        ];

        function generateLcarsData() {
            const types = ['numeric', 'hex', 'code', 'coord'];
            const type = types[Math.floor(Math.random() * types.length)];

            switch(type) {
                case 'numeric':
                    return Math.floor(Math.random() * 9999).toString().padStart(4, '0');
                case 'hex':
                    return Math.floor(Math.random() * 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
                case 'code':
                    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                    return letters[Math.floor(Math.random() * 26)] +
                           letters[Math.floor(Math.random() * 26)] + '-' +
                           Math.floor(Math.random() * 999).toString().padStart(3, '0');
                case 'coord':
                    return Math.floor(Math.random() * 360) + '.' +
                           Math.floor(Math.random() * 99).toString().padStart(2, '0');
            }
        }

        function fillDataCascade(containerId, rowCount) {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = '';

            for (let i = 0; i < rowCount; i++) {
                const row = document.createElement('div');
                row.className = 'lcars-data-row';
                if (Math.random() > 0.7) row.classList.add('highlight');

                const color1 = lcarsColors[Math.floor(Math.random() * lcarsColors.length)];
                const color2 = lcarsColors[Math.floor(Math.random() * lcarsColors.length)];

                row.innerHTML = `
                    <span style="color: ${color1};">${generateLcarsData()}</span>
                    <span style="color: ${color2};">${generateLcarsData()}</span>
                `;
                container.appendChild(row);
            }
        }

        function updateDataCascade() {
            const container = document.getElementById('nav-data-cascade');
            if (!container) return;

            const rows = container.querySelectorAll('.lcars-data-row');
            const updateCount = Math.floor(Math.random() * 2) + 1;
            for (let i = 0; i < updateCount; i++) {
                const randomRow = rows[Math.floor(Math.random() * rows.length)];
                if (randomRow) {
                    const spans = randomRow.querySelectorAll('span');
                    const randomSpan = spans[Math.floor(Math.random() * spans.length)];
                    if (randomSpan) {
                        randomSpan.textContent = generateLcarsData();
                    }
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            renderTacticalMap();
            fetchTurnStatus();
            fetchActionAvailability();

            // Initialize LCARS data cascade
            fillDataCascade('nav-data-cascade', 15);
            setInterval(updateDataCascade, 2500);

            // Event listeners
            const rerouteSelect = document.getElementById('reroute-system-select');
            if (rerouteSelect) {
                rerouteSelect.addEventListener('change', updateRerouteTargetDisplay);
            }

            const ramSelect = document.getElementById('ram-target-select');
            if (ramSelect) {
                ramSelect.addEventListener('change', updateRamDamageDisplay);
            }

            // Fire panel event listeners
            const weaponSelect = document.getElementById('weapon-select');
            if (weaponSelect) {
                weaponSelect.addEventListener('change', updateFireDetails);
            }

            const targetSelect = document.getElementById('target-select');
            if (targetSelect) {
                targetSelect.addEventListener('change', updateFireDetails);
            }

            // Damage control system select
            const dcSelect = document.getElementById('damage-control-system-select');
            if (dcSelect) {
                dcSelect.addEventListener('change', updateDamageControlDisplay);
            }

            // Start polling for turn status
            setInterval(fetchTurnStatus, 3000);

            // Periodically refresh map data
            setInterval(refreshMapData, 5000);
        });

        // Refresh map data from server
        async function refreshMapData() {
            if (impulseMovementActive) return;

            try {
                const response = await fetch(`/api/encounter/${encounterId}/map?role=player`);
                if (response.ok) {
                    const data = await response.json();
                    tacticalMapData = data.tactical_map;
                    shipPositions = data.ship_positions;
                    renderTacticalMap();
                    updateFireTargets();
                }
            } catch (error) {
                console.error('Error refreshing map:', error);
            }
        }
    </script>
</body>
</html>
